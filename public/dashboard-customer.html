<!DOCTYPE html><html lang='en-GB'><head><meta charset='utf-8'><meta name='viewport' content='width=device-width,initial-scale=1'><title>Customer dashboard ‚Äî EventFlow</title><link rel='stylesheet' href='/assets/css/styles.css?v=17.0.1'><link rel='stylesheet' href='/assets/css/ui-ux-fixes.css?v=17.0.1'></head><body>
<header class="header" role="banner">
  <div class="container header-inner">
    <a class="brand" href="/" aria-label="EventFlow home">
      <span class="logo" aria-hidden="true"></span>
      <span class="brand-text">EventFlow</span>
    </a>
    <div class="header-actions">
      <nav class="nav nav-inline" aria-label="Quick navigation">
        <a href="/start.html" class="nav-link nav-main">Plan</a>
        <a href="/suppliers.html" class="nav-link nav-main">Suppliers</a>
        <a href="/pricing.html" class="nav-link nav-main">Pricing</a>
        <a href="/blog.html" class="nav-link nav-main">Blog</a>
        <a href="/auth.html" class="nav-link nav-main nav-main-login">Log in</a>
      </nav>
      <button id="notification-bell" class="icon-button" type="button" aria-label="Notifications" style="display:none;">
        <span class="notification-icon">üîî</span>
        <span class="notification-badge" style="display:none;">0</span>
      </button>
      <button id="burger" class="nav-toggle" type="button" aria-label="Toggle navigation" aria-expanded="false">
        <span class="nav-toggle-bar"></span>
        <span class="nav-toggle-bar"></span>
        <span class="nav-toggle-bar"></span>
      </button>
    </div>
  </div>
  <nav class="nav nav-menu" aria-label="Primary navigation">
    <a href="/start.html">Plan an Event</a>
    <a href="/suppliers.html">Suppliers</a>
    <a href="/plan.html">My Plan</a>
    <a href="/blog.html">Blog</a>
    <a href="/for-suppliers.html">For Suppliers</a>
    <a href="/faq.html">FAQ</a>
    <a href="/settings.html">Settings</a>
    <a href="/auth.html" id="nav-auth">Log in</a>
    <a href="#" id="nav-dashboard" style="display:none">Dashboard</a>
    <a href="#" id="nav-signout" style="display:none">Sign out</a>
  </nav>
</header>
<script src="/assets/js/auth-nav.js" defer></script>
<script src="/assets/js/websocket-client.js" defer></script>
<main class='section'><div class='container'>
<h1>Your dashboard</h1>

<!-- Welcome Section -->
<div class="card" style="background:linear-gradient(135deg, #0B8073 0%, #13B6A2 100%);color:white;margin-bottom:1.5rem;padding:2rem;">
  <h2 style="margin:0 0 0.75rem 0;color:white;font-size:1.75rem;">Welcome to EventFlow!</h2>
  <p class="small" style="color:rgba(255,255,255,0.95);margin:0;font-size:1rem;">Plan your perfect event with our curated suppliers.</p>
</div>

<div class="cards">
  <!-- Your Plans Card -->
  <div class="card">
    <h3 style="margin:0 0 0.5rem 0;font-size:1.25rem;color:#0B1220;">Your Plans</h3>
    <p class="small" style="color:#667085;margin:0 0 1rem 0;">Event plans created with the wizard.</p>
    <div id="customer-plans-list" style="margin-bottom:1rem;">
      <p class="small" style="color:#667085;">Loading plans...</p>
    </div>
    <a href="/start.html" class="cta secondary" style="text-decoration:none;width:100%;text-align:center;display:inline-block;">Create New Plan</a>
  </div>

  <!-- Your Saved Suppliers Card -->
  <div class="card">
    <h3 style="margin:0 0 0.5rem 0;font-size:1.25rem;color:#0B1220;">Saved Suppliers</h3>
    <p class="small" style="color:#667085;margin:0 0 1rem 0;">Review and manage your saved suppliers.</p>
    <button class="cta" id="openPlanBtn" style="width:100%;">View Saved Items</button>
  </div>
  
  <!-- Quick Actions Card -->
  <div class="card">
    <h3 style="margin:0 0 0.5rem 0;font-size:1.25rem;color:#0B1220;">Quick Actions</h3>
    <p class="small" style="color:#667085;margin:0 0 1rem 0;">Common tasks to help plan your event.</p>
    <div style="display:flex;flex-direction:column;gap:0.75rem;">
      <a href="/suppliers.html" class="cta secondary" style="text-decoration:none;width:100%;text-align:center;">Browse Suppliers</a>
      <a href="/budget.html" class="cta secondary" style="text-decoration:none;width:100%;text-align:center;">Budget Calculator</a>
    </div>
  </div>
  
  <!-- Support Tickets Card -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;gap:0.75rem;">
      <h3 style="margin:0;font-size:1.25rem;color:#0B1220;">Support Tickets</h3>
      <button class="cta" id="createTicketBtn" style="padding:0.5rem 1rem;font-size:0.9rem;min-width:auto;white-space:nowrap;">Create Ticket</button>
    </div>
    <div id="tickets-cust" class="section"><p class="small" style="color:#667085;">Loading‚Ä¶</p></div>
  </div>
  
  <!-- Conversations Card -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;gap:0.75rem;flex-wrap:wrap;">
      <h3 style="margin:0;font-size:1.25rem;color:#0B1220;">Conversations</h3>
      <span id="unreadMessageBadge" class="badge badge-info" style="display:none;font-size:0.85rem;background:#DBEAFE;color:#1E40AF;padding:6px 12px;border-radius:12px;">0 unread</span>
    </div>
    <div id="threads-cust" class="section"><p class="small" style="color:#667085;">Loading‚Ä¶</p></div>
  </div>
</div>

<script src="/assets/js/app.js?v=17.0.1"></script>
<script type="module" src="/assets/js/customer-tickets.js?v=17.0.1"></script>
<script type="module" src="/assets/js/customer-messages.js?v=17.0.1"></script>
<script>
window.__EF_PAGE__='dash_customer';

// Load customer plans
async function loadCustomerPlans() {
  const container = document.getElementById('customer-plans-list');
  if (!container) return;

  try {
    const response = await fetch('/api/me/plans', { credentials: 'include' });
    if (!response.ok) {
      container.innerHTML = '<p class="small" style="color:#667085;">Unable to load plans.</p>';
      return;
    }

    const data = await response.json();
    const plans = data.plans || [];

    if (plans.length === 0) {
      container.innerHTML = '<p class="small" style="color:#667085;">No plans yet. Create one to get started!</p>';
      return;
    }

    container.innerHTML = plans.map(plan => {
      const packageCount = (plan.packages || []).length;
      return `
        <div style="padding:0.75rem;background:#f9fafb;border-radius:8px;margin-bottom:0.75rem;">
          <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:0.5rem;">
            <div>
              <strong style="color:#0B1220;">${escapeHtml(plan.eventName || plan.eventType || 'Untitled Event')}</strong>
              ${plan.eventType ? `<span class="small" style="color:#667085;display:block;">${escapeHtml(plan.eventType)}</span>` : ''}
            </div>
            <span class="small" style="color:#667085;">${packageCount} packages</span>
          </div>
          ${plan.location ? `<p class="small" style="color:#667085;margin:0.25rem 0;">üìç ${escapeHtml(plan.location)}</p>` : ''}
          ${plan.date ? `<p class="small" style="color:#667085;margin:0.25rem 0;">üìÖ ${plan.date}</p>` : ''}
        </div>
      `;
    }).join('');
  } catch (err) {
    console.error('Error loading plans:', err);
    container.innerHTML = '<p class="small" style="color:#667085;">Error loading plans.</p>';
  }
}

function escapeHtml(unsafe) {
  if (typeof unsafe !== 'string') return '';
  const div = document.createElement('div');
  div.textContent = unsafe;
  return div.innerHTML;
}

// Check authentication on page load
async function checkAuth() {
  try {
    const response = await fetch('/api/auth/me', { credentials: 'include' });
    return response.ok;
  } catch (error) {
    console.error('Auth check failed:', error);
    return false;
  }
}

// Setup navigation with auth check
async function initDashboard() {
  const isAuthenticated = await checkAuth();
  
  if (!isAuthenticated) {
    // Redirect to login if not authenticated
    window.location.href = '/auth.html?redirect=' + encodeURIComponent(window.location.pathname);
    return;
  }

  // Check for guest plan token and claim it
  await claimGuestPlanIfExists();

  // Load customer plans
  loadCustomerPlans();

  // Setup Open My Plan button with auth-aware navigation
  document.getElementById('openPlanBtn')?.addEventListener('click', async (e) => {
    e.preventDefault();
    const authenticated = await checkAuth();
    if (authenticated) {
      window.location.href = '/plan.html';
    } else {
      window.location.href = '/auth.html?redirect=/plan.html';
    }
  });
}

/**
 * Claim guest plan if token exists in localStorage
 */
async function claimGuestPlanIfExists() {
  const guestToken = localStorage.getItem('eventflow_guest_plan_token');
  
  if (!guestToken) {
    return; // No guest plan to claim
  }

  try {
    // Get CSRF token
    const csrfToken = getCsrfToken();
    
    const response = await fetch('/api/me/plans/claim', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': csrfToken,
      },
      credentials: 'include',
      body: JSON.stringify({ token: guestToken }),
    });

    if (response.ok) {
      // Successfully claimed
      localStorage.removeItem('eventflow_guest_plan_token');
      console.log('Guest plan claimed successfully');
    } else {
      const error = await response.json();
      console.warn('Failed to claim guest plan:', error.error);
      // Remove token even if claim failed (might be expired or already claimed)
      localStorage.removeItem('eventflow_guest_plan_token');
    }
  } catch (error) {
    console.error('Error claiming guest plan:', error);
    // Don't remove token on network error - try again next time
  }
}

/**
 * Get CSRF token from meta tag or cookie
 */
function getCsrfToken() {
  const meta = document.querySelector('meta[name="csrf-token"]');
  if (meta) {
    return meta.getAttribute('content');
  }
  // Try cookie
  const match = document.cookie.match(/csrfToken=([^;]+)/);
  return match ? match[1] : '';
}

// Initialize dashboard
initDashboard();
</script>
</div></main>
<footer class="footer" role="contentinfo" style="padding:1.25rem 0;margin-top:3rem;">
  <div class="container" style="display:flex;align-items:center;justify-content:space-between;gap:1rem;flex-wrap:wrap;">
    <div style="font-size:0.9rem;"><strong>EventFlow</strong><br><span class="small" style="font-size:0.85rem;">Event planning made simple.</span></div>
    <div class="version" style="font-size:0.8rem;">Version: v17.0.0</div>
    <div class="small" style="font-size:0.85rem;"><a href="/blog.html">Blog</a> ¬∑
      <a href="/credits.html">Credits</a> ¬∑ <a href="/contact.html">Contact</a> ¬∑ <a href="/legal.html">Legal Hub</a></div>
  </div>
</footer>
<script src="/assets/js/components/footer-nav.js" defer></script>
<script src="/assets/js/cookie-consent.js" defer></script>
</body></html>