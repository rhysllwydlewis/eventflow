<!DOCTYPE html><html lang='en-GB'><head><meta charset='utf-8'><meta name='viewport' content='width=device-width,initial-scale=1'><title>Customer dashboard ‚Äî EventFlow</title><link rel='stylesheet' href='/assets/css/styles.css?v=17.0.1'><link rel='stylesheet' href='/assets/css/mobile-optimizations.css'><link rel='stylesheet' href='/assets/css/ui-ux-fixes.css?v=17.0.1'><link rel='stylesheet' href='/assets/css/skeleton.css'><link rel='stylesheet' href='/assets/css/dashboard-animations.css'><script src="/assets/js/dashboard-guard.js?v=17.0.2"></script>    <link rel="stylesheet" href="/assets/css/navbar.css" />
  </head><body>
<a href="#main-content" class="skip-link">Skip to main content</a>
<!-- TOP NAVBAR - GOLD STANDARD REBUILD -->
<header class="ef-header" role="banner">
  <div class="ef-container">
    <div class="ef-header-content">
      <!-- Brand Logo - Enhanced Animated -->
      <a href="/" class="ef-brand" aria-label="EventFlow - Return to homepage">
        <div class="ef-logo" aria-hidden="true">
          <div class="ef-logo-inner"></div>
        </div>
        <span class="ef-brand-text">EventFlow</span>
      </a>

      <!-- Desktop Navigation -->
      <nav class="ef-nav-desktop" aria-label="Main navigation">
        <a href="/start.html" class="ef-nav-link">Plan</a>
        <a href="/suppliers.html" class="ef-nav-link">Suppliers</a>
        <a href="/pricing.html" class="ef-nav-link">Pricing</a>
        <a href="/blog.html" class="ef-nav-link">Blog</a>
      </nav>

      <!-- Actions -->
      <div class="ef-header-actions">
        <!-- Notification Bell (hidden by default, shown when logged in) -->
        <button 
          id="ef-notification-btn" 
          class="ef-icon-btn" 
          type="button" 
          aria-label="View notifications"
          style="display: none;"
        >
          <svg class="ef-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
            <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
          </svg>
          <span id="ef-notification-badge" class="ef-badge" style="display: none;">0</span>
        </button>

        <!-- Auth Button (Desktop) -->
        <a href="/auth.html" id="ef-auth-link" class="ef-btn ef-btn-primary">
          Log in
        </a>

        <!-- Dashboard Link (Desktop, hidden by default) -->
        <a href="#" id="ef-dashboard-link" class="ef-nav-link" style="display: none;">
          Dashboard
        </a>

        <!-- Mobile Menu Toggle -->
        <button 
          id="ef-mobile-toggle" 
          class="ef-mobile-toggle" 
          type="button"
          aria-label="Toggle menu"
          aria-expanded="false"
          aria-controls="ef-mobile-menu"
        >
          <span class="ef-toggle-line"></span>
          <span class="ef-toggle-line"></span>
          <span class="ef-toggle-line"></span>
        </button>
      </div>
    </div>
  </div>

  <!-- Mobile Menu -->
  <div id="ef-mobile-menu" class="ef-mobile-menu" role="dialog" aria-modal="true" aria-label="Mobile navigation">
    <nav class="ef-mobile-nav" aria-label="Primary navigation">
      <a href="/start.html" class="ef-mobile-link">Plan an Event</a>
      <a href="/suppliers.html" class="ef-mobile-link">Browse Suppliers</a>
      <a href="/pricing.html" class="ef-mobile-link">Pricing</a>
      <a href="/blog.html" class="ef-mobile-link">Blog & Guides</a>
      <a href="/for-suppliers.html" class="ef-mobile-link">For Suppliers</a>
      <a href="/faq.html" class="ef-mobile-link">FAQ</a>
      <div class="ef-mobile-divider"></div>
      <a href="/auth.html" id="ef-mobile-auth" class="ef-mobile-link ef-mobile-primary">Log in</a>
      <a href="#" id="ef-mobile-dashboard" class="ef-mobile-link" style="display: none;">Dashboard</a>
      <a href="#" id="ef-mobile-logout" class="ef-mobile-link" style="display: none;">Log out</a>
    </nav>
  </div>
</header>

<!-- Load auth state manager first -->
<script src="/assets/js/utils/auth-state.js" defer></script>
<!-- Burger menu - simple standalone implementation -->
<script src="/assets/js/burger-menu.js" defer></script>
<script src="/assets/js/navbar.js" defer></script>

<script src="/assets/js/websocket-client.js" defer></script>
<main id="main-content" class='section'><div class='container'>
<h1>Your dashboard</h1>

<!-- Welcome Section -->
<div id="welcome-section" class="card" style="background:linear-gradient(135deg, #0B8073 0%, #13B6A2 100%);color:white;margin-bottom:1.5rem;padding:2rem;">
  <h2 id="welcome-heading" style="margin:0 0 0.75rem 0;color:white;font-size:1.75rem;">Welcome to EventFlow!</h2>
  <p class="small" style="color:rgba(255,255,255,0.95);margin:0 0 1rem 0;font-size:1rem;">Plan your perfect event with our curated suppliers.</p>
  <div id="what-you-can-do" style="margin-top:1rem;padding-top:1rem;border-top:1px solid rgba(255,255,255,0.2);">
    <h3 style="margin:0 0 0.5rem 0;color:white;font-size:1.1rem;">What you can do from here:</h3>
    <ul style="margin:0;padding-left:1.25rem;color:rgba(255,255,255,0.95);font-size:0.95rem;">
      <li style="margin-bottom:0.25rem;">Create and manage event plans with our wizard</li>
      <li style="margin-bottom:0.25rem;">Browse and save suppliers for your events</li>
      <li style="margin-bottom:0.25rem;">Track your budget with our calculator</li>
      <li style="margin-bottom:0.25rem;">Manage support tickets and conversations</li>
    </ul>
  </div>
</div>

<!-- Statistics Widgets -->
<div id="customer-stats-grid"></div>

<!-- Budget Tracker and Progress Ring -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;">
  <div id="budget-tracker-widget"></div>
  <div id="progress-ring-widget"></div>
</div>

<!-- Upcoming Events Timeline -->
<div id="upcoming-events-timeline"></div>

<div class="cards">
  <!-- Your Plans Card -->
  <div class="card">
    <h3 style="margin:0 0 0.5rem 0;font-size:1.25rem;color:#0B1220;">Your Plans</h3>
    <p class="small" style="color:#667085;margin:0 0 1rem 0;">Event plans created with the wizard.</p>
    <div id="customer-plans-list" style="margin-bottom:1rem;">
      <div class="skeleton skeleton-text skeleton-text-long"></div>
      <div class="skeleton skeleton-text skeleton-text-medium"></div>
    </div>
    <a href="/start.html" class="cta secondary" style="text-decoration:none;width:100%;text-align:center;display:inline-block;">Create New Plan</a>
  </div>

  <!-- Your Saved Suppliers Card -->
  <div class="card">
    <h3 style="margin:0 0 0.5rem 0;font-size:1.25rem;color:#0B1220;">Saved Suppliers</h3>
    <p class="small" style="color:#667085;margin:0 0 1rem 0;">Review and manage your saved suppliers.</p>
    <button class="cta" id="openPlanBtn" style="width:100%;">View Saved Items</button>
  </div>
  
  <!-- Quick Actions Card -->
  <div class="card">
    <h3 style="margin:0 0 0.5rem 0;font-size:1.25rem;color:#0B1220;">Quick Actions</h3>
    <p class="small" style="color:#667085;margin:0 0 1rem 0;">Common tasks to help plan your event.</p>
    <div style="display:flex;flex-direction:column;gap:0.75rem;">
      <a href="/suppliers.html" class="cta secondary" style="text-decoration:none;width:100%;text-align:center;">Browse Suppliers</a>
      <a href="/budget.html" class="cta secondary" style="text-decoration:none;width:100%;text-align:center;">Budget Calculator</a>
    </div>
  </div>
  
  <!-- Support Tickets Card -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;gap:0.75rem;">
      <h3 style="margin:0;font-size:1.25rem;color:#0B1220;">Support Tickets</h3>
      <button class="cta" id="createTicketBtn" style="padding:0.5rem 1rem;font-size:0.9rem;min-width:auto;white-space:nowrap;">Create Ticket</button>
    </div>
    <div id="tickets-cust" class="section">
      <div class="skeleton skeleton-text skeleton-text-long"></div>
      <div class="skeleton skeleton-text skeleton-text-medium"></div>
    </div>
  </div>
  
  <!-- Conversations Card -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;gap:0.75rem;flex-wrap:wrap;">
      <h3 style="margin:0;font-size:1.25rem;color:#0B1220;">Conversations</h3>
      <span id="unreadMessageBadge" class="badge badge-info" style="display:none;font-size:0.85rem;background:#DBEAFE;color:#1E40AF;padding:6px 12px;border-radius:12px;">0 unread</span>
    </div>
    <div id="threads-cust" class="section">
      <div class="skeleton skeleton-text skeleton-text-long"></div>
      <div class="skeleton skeleton-text skeleton-text-medium"></div>
    </div>
  </div>
</div>

<script src="/assets/js/app.js?v=17.0.1"></script>
<script type="module" src="/assets/js/customer-tickets.js?v=17.0.1"></script>
<script type="module" src="/assets/js/customer-messages.js?v=17.0.1"></script>
<script type="module">
import { createStatsGrid, createBudgetTracker, createProgressRing, createEventsTimeline } from '/assets/js/dashboard-widgets.js';
import { initCountUp } from '/assets/js/count-up-animation.js';

// Initialize dashboard widgets after data loads
async function initCustomerDashboardWidgets() {
  try {
    // Fetch customer data with fallback
    let plans = [];
    try {
      const response = await fetch('/api/me/plans', { credentials: 'include' });
      if (response.ok) {
        const data = await response.json();
        plans = data.plans || [];
      }
    } catch (err) {
      console.error('Error fetching plans:', err);
      // Continue with empty plans array
    }
    
    // Count saved suppliers (from localStorage or API)
    let savedSuppliers = [];
    try {
      savedSuppliers = JSON.parse(localStorage.getItem('eventflow_saved_suppliers') || '[]');
    } catch (err) {
      console.error('Error reading saved suppliers:', err);
      savedSuppliers = [];
    }
    
    // Count messages/conversations - will be updated by customer-messages.js
    let unreadMessages = 0;
    const unreadBadge = document.getElementById('unreadMessageBadge');
    if (unreadBadge && unreadBadge.textContent) {
      const match = unreadBadge.textContent.match(/(\d+)/);
      if (match) unreadMessages = parseInt(match[1]);
    }
    
    // Count upcoming tasks from plans (suppliers that need action)
    const upcomingTasks = plans.length > 0 ? plans.length : 0;
    
    // Create statistics widgets
    createStatsGrid([
      {
        icon: 'üìã',
        value: plans.length,
        label: 'Active Plans',
        format: 'number',
        color: 'linear-gradient(135deg, #0B8073 0%, #13B6A2 100%)',
      },
      {
        icon: '‚≠ê',
        value: savedSuppliers.length,
        label: 'Saved Suppliers',
        format: 'number',
        color: 'linear-gradient(135deg, #F59E0B 0%, #FBBF24 100%)',
      },
      {
        icon: 'üìÖ',
        value: upcomingTasks,
        label: 'Upcoming Tasks',
        format: 'number',
        color: 'linear-gradient(135deg, #3B82F6 0%, #60A5FA 100%)',
      },
      {
        icon: 'üí¨',
        value: unreadMessages,
        label: 'Messages',
        format: 'number',
        color: 'linear-gradient(135deg, #8B5CF6 0%, #A78BFA 100%)',
        pulse: unreadMessages > 0,
      },
    ], 'customer-stats-grid');
    
    // Calculate budget from plans data (if available)
    let totalBudget = 5000; // Default budget
    let spentBudget = 0;
    
    // Calculate spent based on saved suppliers or plans
    if (plans.length > 0) {
      // Estimate: assume each plan represents ~¬£500 committed
      spentBudget = plans.length * 500;
      totalBudget = Math.max(5000, spentBudget * 1.5); // Ensure total is reasonable
    }
    
    createBudgetTracker({
      spent: spentBudget,
      total: totalBudget,
    }, 'budget-tracker-widget');
    
    // Calculate event progress
    const totalSuppliers = 10; // Average suppliers for a complete event
    const bookedSuppliers = savedSuppliers.length;
    const pendingSuppliers = Math.max(0, totalSuppliers - bookedSuppliers);
    const progressPercentage = Math.min(100, Math.round((bookedSuppliers / totalSuppliers) * 100));
    
    // Create progress ring
    createProgressRing({
      percentage: progressPercentage,
      label: 'Event Progress',
      booked: bookedSuppliers,
      pending: pendingSuppliers,
    }, 'progress-ring-widget');
    
    // Create upcoming events timeline based on plans
    let upcomingEvents = [];
    
    if (plans.length > 0) {
      // Generate contextual tasks based on actual plans
      upcomingEvents = [
        { name: 'Review plan details', supplier: 'Planning Dashboard', daysUntil: 2 },
        { name: 'Confirm supplier bookings', supplier: `${plans.length} supplier${plans.length !== 1 ? 's' : ''}`, daysUntil: 7 },
        { name: 'Finalize event details', supplier: 'Event Planning', daysUntil: 14 },
      ];
    } else {
      // Show getting started tasks if no plans
      upcomingEvents = [
        { name: 'Create your first event plan', supplier: 'Getting Started', daysUntil: 0 },
        { name: 'Browse suppliers', supplier: 'Marketplace', daysUntil: 1 },
        { name: 'Save your favorites', supplier: 'Supplier Search', daysUntil: 3 },
      ];
    }
    
    createEventsTimeline(upcomingEvents, 'upcoming-events-timeline');
    
  } catch (error) {
    console.error('Error initializing dashboard widgets:', error);
  }
}

// Initialize widgets after page loads
window.addEventListener('load', () => {
  setTimeout(() => {
    initCustomerDashboardWidgets();
  }, 500);
});
</script>
<script>
window.__EF_PAGE__='dash_customer';

// Load customer plans
async function loadCustomerPlans() {
  const container = document.getElementById('customer-plans-list');
  if (!container) return;

  try {
    const response = await fetch('/api/me/plans', { credentials: 'include' });
    if (!response.ok) {
      container.innerHTML = '<p class="small" style="color:#667085;">Unable to load plans.</p>';
      return;
    }

    const data = await response.json();
    const plans = data.plans || [];

    if (plans.length === 0) {
      container.innerHTML = '<p class="small" style="color:#667085;">No plans yet. Create one to get started!</p>';
      return;
    }

    container.innerHTML = plans.map(plan => {
      const packageCount = (plan.packages || []).length;
      return `
        <div style="padding:0.75rem;background:#f9fafb;border-radius:8px;margin-bottom:0.75rem;">
          <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:0.5rem;">
            <div>
              <strong style="color:#0B1220;">${escapeHtml(plan.eventName || plan.eventType || 'Untitled Event')}</strong>
              ${plan.eventType ? `<span class="small" style="color:#667085;display:block;">${escapeHtml(plan.eventType)}</span>` : ''}
            </div>
            <span class="small" style="color:#667085;">${packageCount} packages</span>
          </div>
          ${plan.location ? `<p class="small" style="color:#667085;margin:0.25rem 0;">üìç ${escapeHtml(plan.location)}</p>` : ''}
          ${plan.date ? `<p class="small" style="color:#667085;margin:0.25rem 0;">üìÖ ${plan.date}</p>` : ''}
        </div>
      `;
    }).join('');
  } catch (err) {
    console.error('Error loading plans:', err);
    container.innerHTML = '<p class="small" style="color:#667085;">Error loading plans.</p>';
  }
}

function escapeHtml(unsafe) {
  if (typeof unsafe !== 'string') return '';
  const div = document.createElement('div');
  div.textContent = unsafe;
  return div.innerHTML;
}

// Check authentication on page load
async function checkAuth() {
  try {
    const response = await fetch('/api/auth/me', { credentials: 'include' });
    if (!response.ok) {
      return null;
    }
    const data = await response.json();
    return data.user || null;
  } catch (error) {
    console.error('Auth check failed:', error);
    return null;
  }
}

// Setup navigation with auth check
async function initDashboard() {
  const user = await checkAuth();
  
  if (!user) {
    // Redirect to login if not authenticated
    window.location.href = '/auth.html?redirect=' + encodeURIComponent(window.location.pathname);
    return;
  }

  // Personalize welcome message
  const welcomeHeading = document.getElementById('welcome-heading');
  if (welcomeHeading) {
    if (user.firstName) {
      welcomeHeading.textContent = `Welcome ${escapeHtml(user.firstName)}!`;
    } else if (user.name) {
      const firstName = user.name.split(' ')[0];
      welcomeHeading.textContent = `Welcome ${escapeHtml(firstName)}!`;
    } else {
      welcomeHeading.textContent = `Welcome to EventFlow!`;
    }
  }

  // Check for guest plan token and claim it
  await claimGuestPlanIfExists();

  // Load customer plans
  loadCustomerPlans();

  // Setup Open My Plan button with auth-aware navigation
  document.getElementById('openPlanBtn')?.addEventListener('click', async (e) => {
    e.preventDefault();
    window.location.href = '/plan.html';
  });
}

/**
 * Claim guest plan if token exists in localStorage
 */
async function claimGuestPlanIfExists() {
  const guestToken = localStorage.getItem('eventflow_guest_plan_token');
  
  if (!guestToken) {
    return; // No guest plan to claim
  }

  try {
    // Get CSRF token
    const csrfToken = getCsrfToken();
    
    const response = await fetch('/api/me/plans/claim', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': csrfToken,
      },
      credentials: 'include',
      body: JSON.stringify({ token: guestToken }),
    });

    if (response.ok) {
      // Successfully claimed
      localStorage.removeItem('eventflow_guest_plan_token');
      console.log('Guest plan claimed successfully');
    } else {
      const error = await response.json();
      console.warn('Failed to claim guest plan:', error.error);
      // Remove token even if claim failed (might be expired or already claimed)
      localStorage.removeItem('eventflow_guest_plan_token');
    }
  } catch (error) {
    console.error('Error claiming guest plan:', error);
    // Don't remove token on network error - try again next time
  }
}

/**
 * Get CSRF token from meta tag or cookie
 */
function getCsrfToken() {
  const meta = document.querySelector('meta[name="csrf-token"]');
  if (meta) {
    return meta.getAttribute('content');
  }
  // Try cookie
  const match = document.cookie.match(/csrfToken=([^;]+)/);
  return match ? match[1] : '';
}

// Initialize dashboard
initDashboard();
</script>
</div></main>
<!-- BOTTOM NAVBAR - GOLD STANDARD REBUILD (Mobile Only) -->
<nav class="ef-bottom-nav" role="navigation" aria-label="Mobile bottom navigation">
  <a href="/start.html" class="ef-bottom-link" aria-label="Plan your event">
    <svg class="ef-bottom-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <path d="M12 20h9"/>
      <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/>
    </svg>
    <span class="ef-bottom-label">Plan</span>
  </a>
  
  <a href="/suppliers.html" class="ef-bottom-link" aria-label="Browse suppliers">
    <svg class="ef-bottom-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <circle cx="11" cy="11" r="8"/>
      <path d="m21 21-4.35-4.35"/>
    </svg>
    <span class="ef-bottom-label">Suppliers</span>
  </a>
  
  <a href="/blog.html" class="ef-bottom-link" aria-label="View guides">
    <svg class="ef-bottom-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
      <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
    </svg>
    <span class="ef-bottom-label">Guides</span>
  </a>
  
  <!-- Dashboard with notification badge (shown when logged in, replaces Alerts) -->
  <a href="#" id="ef-bottom-dashboard" class="ef-bottom-link" style="display: none;" aria-label="Go to dashboard">
    <svg class="ef-bottom-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <rect x="3" y="3" width="7" height="7" rx="1"/>
      <rect x="14" y="3" width="7" height="7" rx="1"/>
      <rect x="14" y="14" width="7" height="7" rx="1"/>
      <rect x="3" y="14" width="7" height="7" rx="1"/>
    </svg>
    <span class="ef-bottom-label">Dashboard</span>
    <span id="ef-bottom-dashboard-badge" class="ef-badge" style="display: none;">0</span>
  </a>
  
  <!-- Alerts button (shown when logged out) -->
  <a href="/blog.html" id="ef-bottom-alerts" class="ef-bottom-link" aria-label="View guides and alerts">
    <svg class="ef-bottom-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
      <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
    </svg>
    <span class="ef-bottom-label">Alerts</span>
  </a>
  
  <button 
    id="ef-bottom-menu" 
    class="ef-bottom-link" 
    type="button"
    aria-label="Open menu"
    aria-expanded="false"
    aria-controls="ef-mobile-menu"
  >
    <svg class="ef-bottom-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <line x1="3" y1="12" x2="21" y2="12"/>
      <line x1="3" y1="6" x2="21" y2="6"/>
      <line x1="3" y1="18" x2="21" y2="18"/>
    </svg>
    <span class="ef-bottom-label">Menu</span>
  </button>
</nav>


<footer class="footer" role="contentinfo" style="padding:1.25rem 0;margin-top:3rem;">
  <div class="container" style="display:flex;align-items:center;justify-content:space-between;gap:1rem;flex-wrap:wrap;">
    <div style="font-size:0.9rem;"><strong>EventFlow</strong><br><span class="small" style="font-size:0.85rem;">Event planning made simple.</span></div>
    <div class="version" style="font-size:0.8rem;">Version: v17.0.0</div>
    <div class="small" style="font-size:0.85rem;"><a href="/blog.html">Blog</a> ¬∑
      <a href="/credits.html">Credits</a> ¬∑ <a href="/contact.html">Contact</a> ¬∑ <a href="/legal.html">Legal Hub</a></div>
  </div>
</footer>
<script src="/assets/js/cookie-consent.js" defer></script>

<!-- JadeAssist Chat Widget -->
<script src="https://cdn.jsdelivr.net/gh/rhysllwydlewis/JadeAssist@abbf580487e0bcf7739a0857d4d940213fe2e176/packages/widget/dist/jade-widget.js" defer></script>
<script src="/assets/js/jadeassist-init.v2.js" defer></script>
</body></html>