<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Avatar Widget Positioning Test - EventFlow</title>
    <link rel="stylesheet" href="/assets/css/components.css" />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 200vh; /* Make page scrollable */
        padding: 2rem;
        color: white;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      h1 {
        font-size: 2.5rem;
        margin-bottom: 1rem;
        text-align: center;
      }

      .test-section {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 16px;
        padding: 2rem;
        margin-bottom: 2rem;
      }

      .test-section h2 {
        font-size: 1.5rem;
        margin-bottom: 1rem;
      }

      .test-section ul {
        margin-left: 1.5rem;
      }

      .test-section li {
        margin-bottom: 0.5rem;
      }

      .success {
        color: #4ade80;
      }

      .warning {
        color: #fbbf24;
      }

      .error {
        color: #f87171;
      }

      .code {
        background: rgba(0, 0, 0, 0.3);
        padding: 2px 6px;
        border-radius: 4px;
        font-family: monospace;
        font-size: 0.9em;
      }

      .diagnostic-output {
        background: rgba(0, 0, 0, 0.5);
        padding: 1rem;
        border-radius: 8px;
        font-family: monospace;
        font-size: 0.9rem;
        margin-top: 1rem;
        max-height: 400px;
        overflow-y: auto;
      }

      .diagnostic-line {
        margin-bottom: 0.5rem;
      }

      .visual-guide {
        position: fixed;
        background: rgba(255, 255, 255, 0.2);
        z-index: 50;
        pointer-events: none;
      }

      .guide-horizontal {
        height: 2px;
        left: 0;
        right: 0;
      }

      .guide-label {
        position: absolute;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 11px;
        white-space: nowrap;
        left: 50%;
        transform: translateX(-50%);
        bottom: 4px;
      }

      button {
        background: linear-gradient(135deg, #00b2a9, #008c85);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s ease;
      }

      button:hover {
        transform: translateY(-2px);
      }

      button:active {
        transform: translateY(0);
      }

      .button-group {
        display: flex;
        gap: 1rem;
        margin-top: 1rem;
        flex-wrap: wrap;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîç Avatar Widget Positioning Test</h1>

      <div class="test-section">
        <h2>üìä Live Diagnostics</h2>
        <p>This page loads the real JadeAssist widget and tests its positioning.</p>
        <div class="button-group">
          <button onclick="runDiagnostics()">Run Diagnostics</button>
          <button onclick="clearLocalStorage()">Clear Teaser Dismissal</button>
          <button onclick="scrollToBottom()">Scroll to Bottom</button>
        </div>
        <div id="diagnostics" class="diagnostic-output">
          <div class="diagnostic-line">‚è≥ Waiting for diagnostics...</div>
        </div>
      </div>

      <div class="test-section">
        <h2>‚úÖ Expected Configuration</h2>
        <ul>
          <li><strong>Desktop:</strong> Widget at <span class="code">bottom: 5rem (80px), left: 1.5rem (24px)</span></li>
          <li><strong>Desktop:</strong> Back-to-top at <span class="code">bottom: 5rem (80px), right: 1.5rem (24px)</span></li>
          <li class="success">‚úì Aligned vertically on same baseline</li>
        </ul>
        <br />
        <ul>
          <li><strong>Mobile (‚â§768px):</strong> Widget at <span class="code">bottom: 4.5rem (72px), left: 1rem (16px)</span></li>
          <li><strong>Mobile:</strong> Back-to-top at <span class="code">bottom: 4.5rem (72px), right: 1rem (16px)</span></li>
          <li class="success">‚úì Aligned vertically on same baseline</li>
        </ul>
      </div>

      <div class="test-section">
        <h2>üìã What to Check</h2>
        <ul>
          <li>Widget launcher button should appear on the <strong>left side</strong> of the screen</li>
          <li>Back-to-top button (‚Üë) should appear on the <strong>right side</strong> of the screen</li>
          <li>Both buttons should be at the <strong>same vertical height</strong></li>
          <li>Avatar should show a <strong>woman's face</strong> (PNG image)</li>
          <li>Teaser bubble should appear above the widget after ~1.5 seconds</li>
          <li>On mobile (< 768px), spacing should adjust appropriately</li>
        </ul>
      </div>

      <div class="test-section">
        <h2>üéØ Visual Alignment Test</h2>
        <p>Scroll down to see the positioning of both buttons at the bottom of the viewport.</p>
        <p class="success" style="margin-top: 0.5rem;">
          The horizontal guide line below shows where both buttons should be aligned (at the same bottom position).
        </p>
      </div>

      <div style="height: 100vh; display: flex; align-items: center; justify-content: center">
        <p style="font-size: 1.5rem; opacity: 0.8">
          ‚¨áÔ∏è Scroll down to test positioning ‚¨áÔ∏è
        </p>
      </div>

      <div style="height: 50vh; display: flex; align-items: center; justify-content: center">
        <p style="font-size: 1.5rem; opacity: 0.8">
          Keep scrolling...
        </p>
      </div>
    </div>

    <!-- Visual alignment guide -->
    <div class="visual-guide guide-horizontal" id="guide" style="bottom: 5rem">
      <div class="guide-label">
        Alignment baseline: 5rem (desktop) / 4.5rem (mobile)
      </div>
    </div>

    <!-- Back to top button (from components.css) -->
    <button class="back-to-top" id="backToTop" title="Back to top" onclick="window.scrollTo({top: 0, behavior: 'smooth'})">
      ‚Üë
    </button>

    <!-- JadeAssist Widget -->
    <!-- Note: CDN URL uses pinned commit SHA (not @main) to ensure consistent behavior and prevent unexpected changes -->
    <script 
      src="https://cdn.jsdelivr.net/gh/rhysllwydlewis/JadeAssist@b346f7e4d9130a4c258e987f955e2d0c3149e9b2/packages/widget/dist/jade-widget.js"
      defer
    ></script>
    <script src="/assets/js/jadeassist-init.v2.js" defer></script>

    <script>
      // Show back-to-top button when scrolled
      window.addEventListener('scroll', () => {
        const backToTop = document.getElementById('backToTop');
        if (window.scrollY > 300) {
          backToTop.classList.add('visible');
        } else {
          backToTop.classList.remove('visible');
        }
      });

      // Update guide on resize
      function updateGuide() {
        const guide = document.getElementById('guide');
        if (window.innerWidth <= 768) {
          guide.style.bottom = '4.5rem';
        } else {
          guide.style.bottom = '5rem';
        }
      }

      window.addEventListener('resize', updateGuide);
      updateGuide();

      // Diagnostic functions
      function runDiagnostics() {
        const output = document.getElementById('diagnostics');
        const lines = [];

        lines.push('üîç Running diagnostics...');
        lines.push('');

        // Check if JadeWidget loaded
        if (typeof window.JadeWidget !== 'undefined') {
          lines.push('<span class="success">‚úÖ JadeWidget library loaded</span>');
        } else {
          lines.push('<span class="error">‚ùå JadeWidget library NOT loaded</span>');
        }

        // Check for widget root element
        const widgetRoot = document.querySelector('.jade-widget-root');
        if (widgetRoot) {
          lines.push('<span class="success">‚úÖ Widget root element found (.jade-widget-root)</span>');
          
          // Get computed styles
          const styles = window.getComputedStyle(widgetRoot);
          lines.push('');
          lines.push('üìä Widget Root Styles:');
          lines.push(`   position: ${styles.position}`);
          lines.push(`   bottom: ${styles.bottom}`);
          lines.push(`   left: ${styles.left}`);
          lines.push(`   right: ${styles.right}`);
          lines.push(`   z-index: ${styles.zIndex}`);

          // Check shadow DOM
          if (widgetRoot.shadowRoot) {
            lines.push('');
            lines.push('<span class="success">‚úÖ Shadow DOM accessible</span>');
            
            const container = widgetRoot.shadowRoot.querySelector('.jade-widget-container');
            if (container) {
              const containerStyles = window.getComputedStyle(container);
              lines.push('');
              lines.push('üìä Shadow Container Styles:');
              lines.push(`   position: ${containerStyles.position}`);
              lines.push(`   bottom: ${containerStyles.bottom}`);
              lines.push(`   left: ${containerStyles.left}`);
              lines.push(`   right: ${containerStyles.right}`);
            }

            // Check avatar
            const avatarImg = widgetRoot.shadowRoot.querySelector('img');
            if (avatarImg) {
              lines.push('');
              lines.push('<span class="success">‚úÖ Avatar image found</span>');
              lines.push(`   src: ${avatarImg.src}`);
              lines.push(`   alt: ${avatarImg.alt || '(none)'}`);
            } else {
              lines.push('');
              lines.push('<span class="warning">‚ö†Ô∏è Avatar image not found in shadow DOM</span>');
            }
          } else {
            lines.push('');
            lines.push('<span class="warning">‚ö†Ô∏è Shadow DOM not accessible</span>');
          }
        } else {
          lines.push('<span class="error">‚ùå Widget root element NOT found</span>');
        }

        // Check back-to-top button
        lines.push('');
        const backToTop = document.getElementById('backToTop');
        if (backToTop) {
          const btStyles = window.getComputedStyle(backToTop);
          lines.push('<span class="success">‚úÖ Back-to-top button found</span>');
          lines.push('üìä Back-to-top Styles:');
          lines.push(`   bottom: ${btStyles.bottom}`);
          lines.push(`   right: ${btStyles.right}`);
        }

        // Check teaser
        const teaser = document.querySelector('.jade-teaser');
        if (teaser) {
          lines.push('');
          lines.push('<span class="success">‚úÖ Teaser bubble found</span>');
          const teaserStyles = window.getComputedStyle(teaser);
          lines.push('üìä Teaser Styles:');
          lines.push(`   bottom: ${teaserStyles.bottom}`);
          lines.push(`   left: ${teaserStyles.left}`);
          lines.push(`   opacity: ${teaserStyles.opacity}`);
        } else {
          lines.push('');
          lines.push('<span class="warning">‚ö†Ô∏è Teaser bubble not visible (may be dismissed)</span>');
        }

        // Check localStorage
        lines.push('');
        const dismissed = localStorage.getItem('jadeassist-teaser-dismissed');
        if (dismissed) {
          const date = new Date(parseInt(dismissed));
          lines.push(`‚ÑπÔ∏è Teaser dismissed at: ${date.toLocaleString()}`);
        } else {
          lines.push('‚ÑπÔ∏è Teaser not dismissed (should appear)');
        }

        // Viewport info
        lines.push('');
        lines.push('üì± Viewport Information:');
        lines.push(`   Width: ${window.innerWidth}px`);
        lines.push(`   Height: ${window.innerHeight}px`);
        lines.push(`   Device: ${window.innerWidth <= 768 ? 'Mobile' : 'Desktop'}`);

        output.innerHTML = lines.map(line => `<div class="diagnostic-line">${line}</div>`).join('');
      }

      function clearLocalStorage() {
        localStorage.removeItem('jadeassist-teaser-dismissed');
        console.log('‚úÖ Teaser dismissal cleared! Reload the page to see the teaser again.');
        
        // Show feedback in the diagnostic output
        const output = document.getElementById('diagnostics');
        const feedbackLine = document.createElement('div');
        feedbackLine.className = 'diagnostic-line success';
        feedbackLine.textContent = '‚úÖ Teaser dismissal cleared! Reload the page to see the teaser again.';
        output.insertBefore(feedbackLine, output.firstChild);
      }

      function scrollToBottom() {
        window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
      }

      // Auto-run diagnostics after widget loads
      setTimeout(() => {
        runDiagnostics();
        // Re-run after a bit to catch shadow DOM updates
        setTimeout(runDiagnostics, 2000);
      }, 3000);

      // Console logs for debugging
      console.log('üß™ Avatar Widget Positioning Test Page');
      console.log('üìç Expected positioning:');
      console.log('   Widget (left): bottom: 5rem, left: 1.5rem (desktop)');
      console.log('   Back-to-top (right): bottom: 5rem, right: 1.5rem (desktop)');
      console.log('');
      console.log('Run runDiagnostics() to check current state');
    </script>
  </body>
</html>
