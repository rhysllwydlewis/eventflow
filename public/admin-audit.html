<!DOCTYPE html>
<html>
<head>
  <title>Audit Log - Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body{font-family:sans-serif;padding:20px;background:#0b0b0b;color:#f5f5f5;}
    h1,h2{margin-top:20px;}
    table{width:100%;border-collapse:collapse;margin-top:10px;margin-bottom:20px;background:#111;font-size:13px;}
    td,th{border:1px solid #333;padding:8px;}
    th{background:#161616;text-align:left;}
    button{padding:6px 10px;margin:2px;font-size:12px;cursor:pointer;background:#222;color:#f5f5f5;border:1px solid #444;border-radius:3px;}
    button:hover{background:#2b825b;border-color:#2b825b;}
    .controls{margin-top:10px;margin-bottom:10px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    select,input[type="date"]{padding:6px 8px;border-radius:3px;border:1px solid #444;background:#111;color:#f5f5f5;}
    .badge{display:inline-block;padding:2px 6px;border-radius:999px;font-size:11px;background:#222;}
    .badge-user{background:#1e3a8a;color:#bfdbfe;}
    .badge-supplier{background:#713f12;color:#fde68a;}
    .badge-review{background:#4c1d95;color:#ddd6fe;}
    .badge-report{background:#7f1d1d;color:#fca5a5;}
    .small{font-size:12px;color:#a1a1aa;}
    
  /* Admin sidebar styles */
  .admin-sidebar {
    position: fixed;
    left: 0;
    top: 0;
    bottom: 0;
    width: 260px;
    background: #111;
    color: #f5f5f5;
    border-right: 1px solid #27272a;
    padding: 1rem;
    overflow-y: auto;
    z-index: 1000;
    transition: transform 0.3s;
  }
  
  .admin-sidebar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #27272a;
  }
  
  .admin-sidebar-header h3 {
    margin: 0;
    font-size: 1.25rem;
    color: #f5f5f5;
  }
  
  .sidebar-toggle {
    display: none;
    background: none;
    border: none;
    color: #f5f5f5;
    font-size: 1.5rem;
    cursor: pointer;
  }
  
  .admin-sidebar-nav {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }
  
  .admin-nav-link {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    border-radius: 6px;
    color: #d4d4d8;
    text-decoration: none;
    transition: all 0.2s;
  }
  
  .admin-nav-link:hover {
    background: #1a1a1a;
    color: #f5f5f5;
  }
  
  .admin-nav-link.active {
    background: #3b82f6;
    color: #fff;
  }
  
  .nav-icon {
    font-size: 1.25rem;
  }
  
  .nav-label {
    flex: 1;
    font-weight: 500;
  }
  
  .nav-badge {
    background: #3b82f6;
    color: #fff;
    font-size: 0.75rem;
    padding: 0.125rem 0.5rem;
    border-radius: 999px;
    font-weight: 600;
    display: none;
  }
  
  .nav-badge.badge-warning {
    background: #f59e0b;
  }
  
  .nav-badge.badge-danger {
    background: #ef4444;
  }
  
  main.section {
    margin-left: 260px;
    transition: margin-left 0.3s;
  }
  
  @media (max-width: 1024px) {
    .admin-sidebar {
      transform: translateX(-100%);
    }
    
    .admin-sidebar.open {
      transform: translateX(0);
    }
    
    .sidebar-toggle {
      display: block;
    }
    
    main.section {
      margin-left: 0;
    }
  }

</style>
</head>
<body>
<aside class="admin-sidebar" id="adminSidebar">
  <div class="admin-sidebar-header">
    <h3>Admin Panel</h3>
    <button id="sidebarToggle" class="sidebar-toggle" aria-label="Toggle sidebar">‚ò∞</button>
  </div>
  <nav class="admin-sidebar-nav">
    <a href="/admin.html" class="admin-nav-link">
      <span class="nav-icon">üìä</span>
      <span class="nav-label">Dashboard</span>
    </a>
    <a href="/admin-users.html" class="admin-nav-link">
      <span class="nav-icon">üë•</span>
      <span class="nav-label">Users</span>
      <span class="nav-badge" id="newUsersCount"></span>
    </a>
    <a href="/admin-packages.html" class="admin-nav-link">
      <span class="nav-icon">üì¶</span>
      <span class="nav-label">Packages</span>
    </a>
    <a href="/admin-photos.html" class="admin-nav-link">
      <span class="nav-icon">üì∑</span>
      <span class="nav-label">Photos</span>
      <span class="nav-badge badge-warning" id="pendingPhotosCount"></span>
    </a>
    <a href="/admin-tickets.html" class="admin-nav-link">
      <span class="nav-icon">üé´</span>
      <span class="nav-label">Tickets</span>
      <span class="nav-badge badge-danger" id="openTicketsCount"></span>
    </a>
    <a href="/admin-reports.html" class="admin-nav-link">
      <span class="nav-icon">‚ö†Ô∏è</span>
      <span class="nav-label">Reports</span>
    </a>
    <a href="/admin-audit.html" class="admin-nav-link">
      <span class="nav-icon">üìã</span>
      <span class="nav-label">Audit Log</span>
    </a>
    <a href="/admin-homepage.html" class="admin-nav-link">
      <span class="nav-icon">üè†</span>
      <span class="nav-label">Homepage</span>
    </a>
    <a href="/admin-payments.html" class="admin-nav-link">
      <span class="nav-icon">üí≥</span>
      <span class="nav-label">Payments</span>
    </a>
    <a href="/admin-content.html" class="admin-nav-link">
      <span class="nav-icon">üìù</span>
      <span class="nav-label">Content</span>
    </a>
    <a href="/admin-settings.html" class="admin-nav-link">
      <span class="nav-icon">‚öôÔ∏è</span>
      <span class="nav-label">Settings</span>
    </a>
  </nav>
</aside>


  <h1>Audit Log</h1>
  <div class="controls">
    <button id="backToDashboard">‚Üê Back to Dashboard</button>
    <button id="refreshAuditLogs">Refresh</button>
    <button id="exportAuditLogs">Export CSV</button>
  </div>

  <div class="controls">
    <select id="actionFilter">
      <option value="">All Actions</option>
      <option value="user_suspended">User Suspended</option>
      <option value="user_banned">User Banned</option>
      <option value="user_verified">User Verified</option>
      <option value="supplier_verified">Supplier Verified</option>
      <option value="supplier_approved">Supplier Approved</option>
      <option value="review_approved">Review Approved</option>
      <option value="review_rejected">Review Rejected</option>
      <option value="report_resolved">Report Resolved</option>
      <option value="report_dismissed">Report Dismissed</option>
    </select>
    <select id="targetTypeFilter">
      <option value="">All Types</option>
      <option value="user">User</option>
      <option value="supplier">Supplier</option>
      <option value="review">Review</option>
      <option value="report">Report</option>
      <option value="photo">Photo</option>
    </select>
    <label>From: <input type="date" id="dateFrom"></label>
    <label>To: <input type="date" id="dateTo"></label>
  </div>

  <div id="status">Loading audit logs...</div>
  <div class="small" style="margin-bottom:10px;">Showing most recent <span id="logCount">0</span> actions</div>
  
  <table id="auditTable">
    <thead>
      <tr>
        <th>Timestamp</th>
        <th>Admin</th>
        <th>Action</th>
        <th>Target</th>
        <th>Details</th>
      </tr>
    </thead>
    <tbody id="auditBody"></tbody>
  </table>

  <script src="/assets/js/admin-shared.js"></script>
<script>
    let allLogs = [];
    let filteredLogs = [];

    // Mock API - in production this would call a real endpoint
    function api(url, method, body) {
      const opts = {
        method: method || 'GET',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' }
      };
      if (body) opts.body = JSON.stringify(body);
      return fetch(url, opts).then(r => {
        if (!r.ok) throw new Error('API error ' + r.status);
        return r.json();
      });
    }

    function loadAuditLogs() {
      document.getElementById('status').innerText = 'Loading audit logs...';
      
      // This endpoint doesn't exist yet, but we'll try to fetch
      // For now, we'll show a message if it fails
      api('/api/admin/audit-logs?limit=100', 'GET')
        .then(data => {
          allLogs = data.logs || [];
          filteredLogs = allLogs;
          renderAuditLogs(filteredLogs);
          document.getElementById('status').innerText = 'Loaded successfully';
          document.getElementById('logCount').innerText = filteredLogs.length;
        })
        .catch(err => {
          console.error('Error loading audit logs:', err);
          // Show sample data for demonstration
          allLogs = generateSampleLogs();
          filteredLogs = allLogs;
          renderAuditLogs(filteredLogs);
          document.getElementById('status').innerText = 'Showing sample data (endpoint not yet implemented)';
          document.getElementById('logCount').innerText = filteredLogs.length;
        });
    }

    function generateSampleLogs() {
      // Generate sample audit log data for demonstration
      const now = new Date();
      const sampleLogs = [
        {
          id: 'audit_1',
          timestamp: new Date(now - 3600000).toISOString(),
          adminEmail: 'admin@eventflow.local',
          action: 'user_suspended',
          targetType: 'user',
          targetId: 'usr_123',
          details: { reason: 'Violating community guidelines', email: 'user@example.com' }
        },
        {
          id: 'audit_2',
          timestamp: new Date(now - 7200000).toISOString(),
          adminEmail: 'admin@eventflow.local',
          action: 'supplier_verified',
          targetType: 'supplier',
          targetId: 'sup_456',
          details: { name: 'Example Venue', notes: 'All documents verified' }
        },
        {
          id: 'audit_3',
          timestamp: new Date(now - 10800000).toISOString(),
          adminEmail: 'admin@eventflow.local',
          action: 'report_resolved',
          targetType: 'report',
          targetId: 'report_789',
          details: { reportType: 'review', resolution: 'valid', action: 'content_removed' }
        }
      ];
      return sampleLogs;
    }

    function applyFilters() {
      const actionFilter = document.getElementById('actionFilter').value;
      const typeFilter = document.getElementById('targetTypeFilter').value;
      const dateFrom = document.getElementById('dateFrom').value;
      const dateTo = document.getElementById('dateTo').value;

      filteredLogs = allLogs.filter(log => {
        if (actionFilter && log.action !== actionFilter) return false;
        if (typeFilter && log.targetType !== typeFilter) return false;
        
        if (dateFrom) {
          const logDate = new Date(log.timestamp);
          const fromDate = new Date(dateFrom);
          if (logDate < fromDate) return false;
        }
        
        if (dateTo) {
          const logDate = new Date(log.timestamp);
          const toDate = new Date(dateTo);
          toDate.setHours(23, 59, 59, 999);
          if (logDate > toDate) return false;
        }
        
        return true;
      });

      renderAuditLogs(filteredLogs);
      document.getElementById('logCount').innerText = filteredLogs.length;
    }

    function renderAuditLogs(logs) {
      const tbody = document.getElementById('auditBody');
      tbody.innerHTML = '';
      
      if (logs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#a1a1aa;">No audit logs found</td></tr>';
        return;
      }
      
      logs.forEach(log => {
        const row = document.createElement('tr');
        
        const timestamp = new Date(log.timestamp).toLocaleString();
        const actionLabel = log.action.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        
        let targetBadge = '';
        if (log.targetType === 'user') targetBadge = '<span class="badge badge-user">User</span>';
        else if (log.targetType === 'supplier') targetBadge = '<span class="badge badge-supplier">Supplier</span>';
        else if (log.targetType === 'review') targetBadge = '<span class="badge badge-review">Review</span>';
        else if (log.targetType === 'report') targetBadge = '<span class="badge badge-report">Report</span>';
        else targetBadge = '<span class="badge">' + escapeHtml(log.targetType) + '</span>';
        
        let detailsText = '';
        if (log.details) {
          if (log.details.reason) detailsText += 'Reason: ' + escapeHtml(log.details.reason);
          if (log.details.email) detailsText += '<br>User: ' + escapeHtml(log.details.email);
          if (log.details.name) detailsText += '<br>Name: ' + escapeHtml(log.details.name);
          if (log.details.notes) detailsText += '<br>Notes: ' + escapeHtml(log.details.notes);
        }
        
        row.innerHTML = `
          <td><span class="small">${timestamp}</span></td>
          <td>${escapeHtml(log.adminEmail || 'Unknown')}</td>
          <td>${escapeHtml(actionLabel)}</td>
          <td>${targetBadge}<br><span class="small">${log.targetId}</span></td>
          <td><span class="small">${detailsText || 'No details'}</span></td>
        `;
        tbody.appendChild(row);
      });
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function exportAuditLogs() {
      let csv = 'Timestamp,Admin,Action,Target Type,Target ID,Details\n';
      
      filteredLogs.forEach(log => {
        const timestamp = new Date(log.timestamp).toLocaleString();
        const details = JSON.stringify(log.details || {}).replace(/"/g, '""');
        csv += `"${timestamp}","${log.adminEmail}","${log.action}","${log.targetType}","${log.targetId}","${details}"\n`;
      });
      
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `audit-log-${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      window.URL.revokeObjectURL(url);
    }

    // Load audit logs on page load
    loadAuditLogs();
    
    // Event listeners
    document.getElementById('backToDashboard').addEventListener('click', function() {
      location.href = '/admin.html';
    });
    
    document.getElementById('refreshAuditLogs').addEventListener('click', function() {
      loadAuditLogs();
    });
    
    document.getElementById('exportAuditLogs').addEventListener('click', function() {
      exportAuditLogs();
    });

  // Setup filter event listeners
  document.getElementById('actionFilter').addEventListener('change', applyFilters);
  document.getElementById('targetTypeFilter').addEventListener('change', applyFilters);
  document.getElementById('dateFrom').addEventListener('change', applyFilters);
  document.getElementById('dateTo').addEventListener('change', applyFilters);
  </script>

<footer class="footer" role="contentinfo">
  <div class="container" style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
    <div><strong>EventFlow</strong><br><span class="small">Event planning made simple.</span></div>
    <div class="version">Version: v17.0.0</div>
    <div class="small">
      <a href="/blog.html">Blog</a> ¬∑
      <a href="/credits.html">Credits</a> ¬∑
      <a href="/contact.html">Contact</a> ¬∑
      <a href="/legal.html">Legal Hub</a>
    </div>
  </div>
</footer>

<script src="/assets/js/components/footer-nav.js" defer></script>
<script src="/assets/js/cookie-consent.js" defer></script>
</body>
</html>
