<!DOCTYPE html>
<html lang="en-GB">
<head>
  <script src="/assets/js/dashboard-guard.js?v=17.0.2"></script>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Stock Photos - Admin Panel</title>
  <link rel="stylesheet" href="/assets/css/tokens.css?v=18.1.1">
  <link rel="stylesheet" href="/assets/css/styles.css?v=18.1.1">
  <link rel="stylesheet" href="/assets/css/eventflow-17.0.0.css?v=18.1.1">
  <link rel="stylesheet" href="/assets/css/utilities.css?v=18.1.1">
  <link rel="stylesheet" href="/assets/css/components.css?v=18.1.1">
  <link rel="stylesheet" href="/assets/css/animations.css?v=18.1.1">
  <link rel="stylesheet" href="/assets/css/mobile-optimizations.css?v=18.1.1">
  <link rel="stylesheet" href="/assets/css/admin.css?v=18.1.1">
  <link rel="stylesheet" href="/assets/css/admin-enhanced.css?v=18.1.1">
  <link rel="stylesheet" href="/assets/css/admin-navbar.css?v=18.1.1">
  <link rel="stylesheet" href="/assets/css/admin-cards.css?v=18.1.1">
  <link rel="stylesheet" href="/assets/css/ui-ux-fixes.css?v=18.1.1">
  <link rel="stylesheet" href="/assets/css/admin-ui-improvements.css?v=18.1.0">
  <link rel="stylesheet" href="/assets/css/admin-pexels.css?v=18.1.1">
  <link rel="icon" href="/favicon.svg">
  <script src="/assets/js/components.js?v=18.1.1" defer></script>
  <script src="/assets/js/admin-navbar.js?v=18.1.1" defer></script>
</head>
<body class="has-admin-navbar admin">
<!-- Modern Top Navbar -->
<nav class="admin-top-navbar">
  <div class="admin-navbar-content">
    <!-- Brand -->
    <div class="admin-navbar-brand">
      <a href="/admin.html" class="admin-navbar-logo">EventFlow</a>
      <span class="admin-navbar-title">Admin Panel</span>
    </div>

    <!-- Mobile Hamburger -->
    <button class="admin-hamburger" id="adminHamburger" aria-label="Toggle menu">
      <span></span>
      <span></span>
      <span></span>
    </button>

    <!-- Navigation Links -->
    <div class="admin-navbar-nav" id="adminNavbarNav">
      <a href="/admin.html" class="admin-nav-btn">
        <span class="nav-icon">üìä</span>
        <span class="nav-label">Dashboard</span>
      </a>
      <a href="/admin-users.html" class="admin-nav-btn">
        <span class="nav-icon">üë•</span>
        <span class="nav-label">Users</span>
      </a>
      <a href="/admin-suppliers.html" class="admin-nav-btn">
        <span class="nav-icon">üè¢</span>
        <span class="nav-label">Suppliers</span>
      </a>
      <a href="/admin-packages.html" class="admin-nav-btn">
        <span class="nav-icon">üì¶</span>
        <span class="nav-label">Packages</span>
      </a>
      <a href="/admin-marketplace.html" class="admin-nav-btn">
        <span class="nav-icon">üõí</span>
        <span class="nav-label">Marketplace</span>
      </a>
      <a href="/admin-photos.html" class="admin-nav-btn">
        <span class="nav-icon">üì∏</span>
        <span class="nav-label">Photos</span>
      </a>
      <a href="/admin-tickets.html" class="admin-nav-btn">
        <span class="nav-icon">üé´</span>
        <span class="nav-label">Tickets</span>
      </a>
      <a href="/admin-reports.html" class="admin-nav-btn">
        <span class="nav-icon">üìà</span>
        <span class="nav-label">Reports</span>
      </a>
      <a href="/admin-audit.html" class="admin-nav-btn">
        <span class="nav-icon">üìã</span>
        <span class="nav-label">Audit</span>
      </a>
      <a href="/admin-homepage.html" class="admin-nav-btn">
        <span class="nav-icon">üè†</span>
        <span class="nav-label">Homepage</span>
      </a>
      <a href="/admin-payments.html" class="admin-nav-btn">
        <span class="nav-icon">üí≥</span>
        <span class="nav-label">Payments</span>
      </a>
      <a href="/admin-content.html" class="admin-nav-btn">
        <span class="nav-icon">‚úèÔ∏è</span>
        <span class="nav-label">Content</span>
      </a>
      <a href="/admin-settings.html" class="admin-nav-btn">
        <span class="nav-icon">‚öôÔ∏è</span>
        <span class="nav-label">Settings</span>
      </a>
    </div>

    <!-- Right Actions -->
    <div class="admin-navbar-actions">
      <!-- Database Status -->
      <div class="db-status-badge db-loading" id="dbStatusBadge" title="Database status">
        <span class="db-status-dot"></span> Loading...
      </div>

      <!-- Refresh Button -->
      <button class="navbar-icon-btn" id="navRefreshBtn" title="Refresh data">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
        </svg>
      </button>

      <!-- User Dropdown -->
      <div class="admin-user-dropdown">
        <button class="admin-user-btn" id="adminUserBtn">
          <div class="admin-user-avatar">A</div>
          <span>Admin</span>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="6 9 12 15 18 9"></polyline>
          </svg>
        </button>
        <div class="admin-dropdown-menu" id="adminDropdownMenu">
          <a href="/admin-settings.html" class="admin-dropdown-item">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="3"></circle>
              <path d="M12 1v6m0 6v6m4.22-13.22l-4.24 4.24m0 5.96l-4.24 4.24M23 12h-6m-6 0H1m18.78 4.22l-4.24-4.24m-5.96 0l-4.24 4.24"></path>
            </svg>
            Settings
          </a>
          <div class="admin-dropdown-divider"></div>
          <button class="admin-dropdown-item" id="adminLogoutBtn">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
              <polyline points="16 17 21 12 16 7"></polyline>
              <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
            Sign Out
          </button>
        </div>
      </div>
    </div>
  </div>
</nav>

<main id="main-content" class="admin-main">
  <div class="admin-container">
    <div class="admin-header">
      <div>
        <h1>Stock Photos from Pexels</h1>
        <p class="admin-subtitle">Browse and select professional stock photos for category images and site content</p>
      </div>
    </div>

    <div class="admin-card">
      <!-- Search Bar -->
      <div class="search-bar">
        <input 
          type="text" 
          id="searchInput" 
          placeholder="Search for photos (e.g., 'wedding', 'catering', 'venue')..."
        >
        <button id="searchBtn">Search</button>
        <button id="curatedBtn" class="pexels-btn-secondary">Curated</button>
      </div>

      <!-- Category Quick Search -->
      <div class="category-chips" id="categoryChips"></div>

      <!-- Results Info -->
      <div id="resultsInfo" style="margin-bottom: 1rem; color: #666; font-size: 0.875rem;"></div>

      <!-- Loading/Error States -->
      <div id="loadingState" class="loading" style="display: none;">
        <p>Loading photos...</p>
      </div>
      <div id="errorState" class="error" style="display: none;"></div>

      <!-- Photo Grid -->
      <div class="pexels-grid" id="photoGrid"></div>

      <!-- Pagination -->
      <div class="pagination" id="pagination" style="display: none;">
        <button id="prevBtn">‚Üê Previous</button>
        <span class="pagination-info" id="pageInfo"></span>
        <button id="nextBtn">Next ‚Üí</button>
      </div>
    </div>
  </div>
</main>

<!-- Photo Detail Modal -->
<div class="modal" id="photoModal">
  <div class="modal-content">
    <button class="modal-close" id="modalClose">√ó</button>
    <img class="modal-image" id="modalImage" src="" alt="">
    <div class="modal-info">
      <p id="modalPhotographer"></p>
      <p id="modalDimensions"></p>
      <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
        <button class="pexels-btn pexels-btn-primary" id="modalCopyUrl">Copy Image URL</button>
        <button class="pexels-btn pexels-btn-secondary" id="modalViewPexels">View on Pexels</button>
      </div>
    </div>
  </div>
</div>

<script src="/assets/js/admin-shared.js?v=18.1.1"></script>
<script>
(function() {
  let currentPage = 1;
  let currentQuery = '';
  let currentMode = 'search'; // 'search' or 'curated'
  let selectedPhoto = null;

  // Check if Pexels is configured
  async function checkPexelsStatus() {
    try {
      const response = await AdminShared.api('/api/pexels/status');
      if (!response.configured) {
        showError('Pexels API is not configured. Please set PEXELS_API_KEY in your environment variables.');
        return false;
      }
      return true;
    } catch (error) {
      showError('Failed to check Pexels status: ' + error.message);
      return false;
    }
  }

  // Load categories
  async function loadCategories() {
    try {
      const response = await AdminShared.api('/api/pexels/categories');
      const container = document.getElementById('categoryChips');
      container.innerHTML = response.categories.map(cat => 
        `<div class="category-chip" data-query="${AdminShared.escapeHtml(cat.query)}">
          ${cat.icon} ${AdminShared.escapeHtml(cat.category)}
        </div>`
      ).join('');

      // Add click handlers
      container.querySelectorAll('.category-chip').forEach(chip => {
        chip.addEventListener('click', () => {
          const query = chip.dataset.query;
          document.getElementById('searchInput').value = query;
          searchPhotos(query);
        });
      });
    } catch (error) {
      console.error('Failed to load categories:', error);
    }
  }

  // Search photos
  async function searchPhotos(query, page = 1) {
    if (!query) {
      AdminShared.showToast('Please enter a search term', 'warning');
      return;
    }

    currentQuery = query;
    currentPage = page;
    currentMode = 'search';

    showLoading();
    hideError();

    try {
      const response = await AdminShared.api(`/api/pexels/search?q=${encodeURIComponent(query)}&page=${page}&perPage=15`);
      displayPhotos(response);
    } catch (error) {
      showError('Failed to search photos: ' + error.message);
    } finally {
      hideLoading();
    }
  }

  // Get curated photos
  async function getCuratedPhotos(page = 1) {
    currentPage = page;
    currentMode = 'curated';
    currentQuery = '';

    showLoading();
    hideError();

    try {
      const response = await AdminShared.api(`/api/pexels/curated?page=${page}&perPage=15`);
      displayPhotos(response);
    } catch (error) {
      showError('Failed to fetch curated photos: ' + error.message);
    } finally {
      hideLoading();
    }
  }

  // Display photos
  function displayPhotos(response) {
    const grid = document.getElementById('photoGrid');
    const resultsInfo = document.getElementById('resultsInfo');
    const pagination = document.getElementById('pagination');

    if (!response.photos || response.photos.length === 0) {
      grid.innerHTML = '<p style="text-align: center; padding: 2rem; color: #666;">No photos found. Try a different search term.</p>';
      resultsInfo.textContent = '';
      pagination.style.display = 'none';
      return;
    }

    // Results info
    resultsInfo.textContent = `Found ${response.totalResults.toLocaleString()} photos`;

    // Photo grid
    grid.innerHTML = response.photos.map(photo => `
      <div class="pexels-card" data-photo-id="${photo.id}">
        <img src="${AdminShared.escapeHtml(photo.src.medium)}" alt="${AdminShared.escapeHtml(photo.alt)}" loading="lazy">
        <div class="pexels-card-info">
          <p class="pexels-photographer">üì∏ ${AdminShared.escapeHtml(photo.photographer)}</p>
          <div class="pexels-actions">
            <button class="pexels-btn pexels-btn-primary" data-action="view" data-photo-id="${photo.id}">View</button>
            <button class="pexels-btn pexels-btn-secondary" data-action="copy" data-url="${AdminShared.escapeHtml(photo.src.large)}">Copy URL</button>
          </div>
        </div>
      </div>
    `).join('');

    // Add event listeners
    grid.querySelectorAll('[data-action="view"]').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const photoId = btn.dataset.photoId;
        const photo = response.photos.find(p => p.id === parseInt(photoId));
        showPhotoModal(photo);
      });
    });

    grid.querySelectorAll('[data-action="copy"]').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        copyToClipboard(btn.dataset.url);
      });
    });

    // Pagination
    const pageInfo = document.getElementById('pageInfo');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');

    pageInfo.textContent = `Page ${response.page}`;
    prevBtn.disabled = !response.prevPage;
    nextBtn.disabled = !response.nextPage;

    pagination.style.display = 'flex';
  }

  // Show photo modal
  function showPhotoModal(photo) {
    selectedPhoto = photo;
    const modal = document.getElementById('photoModal');
    const img = document.getElementById('modalImage');
    const photographer = document.getElementById('modalPhotographer');
    const dimensions = document.getElementById('modalDimensions');

    img.src = photo.src.large2x || photo.src.large;
    img.alt = photo.alt;
    photographer.textContent = `Photo by ${photo.photographer}`;
    dimensions.textContent = `${photo.width} √ó ${photo.height} pixels`;

    modal.classList.add('active');
  }

  // Copy to clipboard
  function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
      AdminShared.showToast('Image URL copied to clipboard!', 'success');
    }).catch(err => {
      AdminShared.showToast('Failed to copy URL', 'error');
    });
  }

  // Helper functions
  function showLoading() {
    document.getElementById('loadingState').style.display = 'block';
    document.getElementById('photoGrid').style.display = 'none';
  }

  function hideLoading() {
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('photoGrid').style.display = 'grid';
  }

  function showError(message) {
    const errorEl = document.getElementById('errorState');
    errorEl.textContent = message;
    errorEl.style.display = 'block';
  }

  function hideError() {
    document.getElementById('errorState').style.display = 'none';
  }

  // Event listeners
  document.getElementById('searchBtn').addEventListener('click', () => {
    const query = document.getElementById('searchInput').value.trim();
    searchPhotos(query);
  });

  document.getElementById('searchInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      const query = e.target.value.trim();
      searchPhotos(query);
    }
  });

  document.getElementById('curatedBtn').addEventListener('click', () => {
    getCuratedPhotos();
  });

  document.getElementById('prevBtn').addEventListener('click', () => {
    if (currentMode === 'search') {
      searchPhotos(currentQuery, currentPage - 1);
    } else {
      getCuratedPhotos(currentPage - 1);
    }
  });

  document.getElementById('nextBtn').addEventListener('click', () => {
    if (currentMode === 'search') {
      searchPhotos(currentQuery, currentPage + 1);
    } else {
      getCuratedPhotos(currentPage + 1);
    }
  });

  // Modal event listeners
  document.getElementById('modalClose').addEventListener('click', () => {
    document.getElementById('photoModal').classList.remove('active');
  });

  document.getElementById('photoModal').addEventListener('click', (e) => {
    if (e.target.id === 'photoModal') {
      document.getElementById('photoModal').classList.remove('active');
    }
  });

  document.getElementById('modalCopyUrl').addEventListener('click', () => {
    if (selectedPhoto) {
      copyToClipboard(selectedPhoto.src.large);
    }
  });

  document.getElementById('modalViewPexels').addEventListener('click', () => {
    if (selectedPhoto) {
      window.open(selectedPhoto.url, '_blank');
    }
  });

  // Initialize
  async function init() {
    const isConfigured = await checkPexelsStatus();
    if (isConfigured) {
      await loadCategories();
      getCuratedPhotos(); // Load curated photos by default
    }
  }

  init();
})();
</script>
<script src="/assets/js/cookie-consent.js" defer></script>
</body>
</html>
