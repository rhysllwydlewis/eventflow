<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collage Widget Test - EventFlow</title>
    <link rel="stylesheet" href="/assets/css/styles.css?v=18.0.0">
    <link rel="stylesheet" href="/assets/css/eventflow-17.0.0.css?v=18.0.0">
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
        }
        
        .test-header {
            background: linear-gradient(135deg, #0B8073, #13b6a2);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
        }
        
        .test-header h1 {
            margin: 0 0 10px 0;
        }
        
        .debug-panel {
            background: white;
            border: 2px solid #0B8073;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .debug-panel h2 {
            margin-top: 0;
            color: #0B8073;
        }
        
        .debug-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .debug-item {
            background: #f9fafb;
            padding: 12px;
            border-radius: 6px;
            border-left: 4px solid #0B8073;
        }
        
        .debug-item strong {
            color: #0B8073;
            display: block;
            margin-bottom: 5px;
        }
        
        .debug-item.pass {
            border-left-color: #10b981;
            background: #d1fae5;
        }
        
        .debug-item.fail {
            border-left-color: #ef4444;
            background: #fee2e2;
        }
        
        .collage-container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
        }
        
        .collage {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .collage .frame {
            position: relative;
            overflow: hidden;
            border-radius: 8px;
            background: #e5e7eb;
            aspect-ratio: 1;
        }
        
        .collage .frame img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: opacity 0.3s ease;
        }
        
        .collage .frame img.fading {
            opacity: 0;
        }
        
        .collage .frame.loading-pexels::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 30px;
            height: 30px;
            border: 3px solid #f3f4f6;
            border-top-color: #0B8073;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }
        
        .pexels-credit {
            position: absolute;
            bottom: 5px;
            left: 5px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
        }
        
        .pexels-credit a {
            color: white;
            text-decoration: underline;
        }
        
        .console-log {
            background: #1f2937;
            color: #10b981;
            font-family: 'Courier New', monospace;
            padding: 20px;
            border-radius: 8px;
            max-height: 400px;
            overflow-y: auto;
            font-size: 13px;
            line-height: 1.5;
        }
        
        .console-log .log-line {
            margin: 5px 0;
        }
        
        .console-log .log-line.error {
            color: #ef4444;
        }
        
        .console-log .log-line.warn {
            color: #f59e0b;
        }
        
        .console-log .log-line.debug {
            color: #3b82f6;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            background: #0B8073;
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }
        
        .btn:hover {
            background: #097263;
        }
        
        .btn.secondary {
            background: #6b7280;
        }
        
        .btn.secondary:hover {
            background: #4b5563;
        }
        
        @media (max-width: 768px) {
            .collage {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="test-header">
        <h1>üé® Collage Widget Test Page</h1>
        <p>Debug and verify the homepage collage widget functionality</p>
    </div>

    <div class="debug-panel">
        <h2>üîç Debug Information</h2>
        
        <div class="controls">
            <button class="btn" onclick="refreshDebugInfo()">üîÑ Refresh Debug Info</button>
            <button class="btn secondary" onclick="manualRetry()">üîÅ Manual Retry Init</button>
            <button class="btn secondary" onclick="clearConsoleLog()">üóëÔ∏è Clear Console</button>
        </div>
        
        <div class="debug-info" id="debug-info">
            <div class="debug-item">
                <strong>Loading...</strong>
                <span>Fetching debug information...</span>
            </div>
        </div>
        
        <h3>API Configuration</h3>
        <pre id="api-config" style="background: #f9fafb; padding: 15px; border-radius: 6px; overflow-x: auto;">Loading...</pre>
        
        <h3>Console Output</h3>
        <div class="console-log" id="console-log">
            <div class="log-line">Console output will appear here...</div>
        </div>
    </div>

    <div class="collage-container">
        <h2 style="color: #0B8073; margin-top: 0;">Collage Preview</h2>
        <div class="collage" aria-hidden="true">
            <div class="frame">
                <picture>
                    <source type="image/webp" srcset="/assets/images/collage-venue.webp" />
                    <img
                        src="/assets/images/collage-venue.jpg"
                        alt="Venues - default hero image"
                        onerror="this.style.background='linear-gradient(135deg, #667eea 0%, #764ba2 100%)'; this.style.minHeight='200px'; this.src='';"
                    />
                </picture>
            </div>

            <div class="frame">
                <picture>
                    <source type="image/webp" srcset="/assets/images/collage-catering.webp" />
                    <img
                        src="/assets/images/collage-catering.jpg"
                        alt="Catering - default hero image"
                        onerror="this.style.background='linear-gradient(135deg, #f093fb 0%, #f5576c 100%)'; this.style.minHeight='200px'; this.src='';"
                    />
                </picture>
            </div>

            <div class="frame">
                <picture>
                    <source type="image/webp" srcset="/assets/images/collage-entertainment.webp" />
                    <img
                        src="/assets/images/collage-entertainment.jpg"
                        alt="Entertainment - default hero image"
                        onerror="this.style.background='linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)'; this.style.minHeight='200px'; this.src='';"
                    />
                </picture>
            </div>

            <div class="frame">
                <picture>
                    <source type="image/webp" srcset="/assets/images/collage-photography.webp" />
                    <img
                        src="/assets/images/collage-photography.jpg"
                        alt="Photography - default hero image"
                        onerror="this.style.background='linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)'; this.style.minHeight='200px'; this.src='';"
                    />
                </picture>
            </div>
        </div>
    </div>

    <script>
        // Capture console logs
        const consoleLogs = [];
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        function addToConsoleLog(message, type = 'log') {
            const timestamp = new Date().toLocaleTimeString();
            consoleLogs.push({ message, type, timestamp });
            updateConsoleDisplay();
        }
        
        console.log = function(...args) {
            const message = args.join(' ');
            addToConsoleLog(message, 'log');
            originalLog.apply(console, args);
        };
        
        console.error = function(...args) {
            const message = args.join(' ');
            addToConsoleLog(message, 'error');
            originalError.apply(console, args);
        };
        
        console.warn = function(...args) {
            const message = args.join(' ');
            addToConsoleLog(message, 'warn');
            originalWarn.apply(console, args);
        };
        
        function updateConsoleDisplay() {
            const consoleLog = document.getElementById('console-log');
            if (consoleLogs.length === 0) {
                consoleLog.innerHTML = '<div class="log-line">No console output yet...</div>';
                return;
            }
            
            consoleLog.innerHTML = consoleLogs
                .slice(-50) // Show last 50 logs
                .map(log => {
                    const className = log.message.includes('[Collage Debug]') ? 'debug' : log.type;
                    return `<div class="log-line ${className}">[${log.timestamp}] ${log.message}</div>`;
                })
                .join('');
            
            // Auto-scroll to bottom
            consoleLog.scrollTop = consoleLog.scrollHeight;
        }
        
        function clearConsoleLog() {
            consoleLogs.length = 0;
            updateConsoleDisplay();
        }
        
        async function refreshDebugInfo() {
            const debugInfo = document.getElementById('debug-info');
            
            try {
                // Get API configuration
                const response = await fetch('/api/public/homepage-settings');
                const config = await response.json();
                
                document.getElementById('api-config').textContent = JSON.stringify(config, null, 2);
                
                // Check collage state
                const debugData = [
                    {
                        label: 'Collage Initialized',
                        value: window.__collageWidgetInitialized ? '‚úì Yes' : '‚úó No',
                        pass: !!window.__collageWidgetInitialized
                    },
                    {
                        label: 'Interval ID',
                        value: window.pexelsCollageIntervalId || 'Not set',
                        pass: typeof window.pexelsCollageIntervalId === 'number'
                    },
                    {
                        label: 'Debug Enabled',
                        value: typeof isDebugEnabled === 'function' ? isDebugEnabled() : 'Function not found',
                        pass: typeof isDebugEnabled === 'function' && isDebugEnabled()
                    },
                    {
                        label: 'loadHeroCollageImages',
                        value: typeof loadHeroCollageImages === 'function' ? '‚úì Available' : '‚úó Not found',
                        pass: typeof loadHeroCollageImages === 'function'
                    },
                    {
                        label: 'API Collage Enabled',
                        value: config.collageWidget?.enabled ? '‚úì Yes' : '‚úó No',
                        pass: config.collageWidget?.enabled === true
                    },
                    {
                        label: 'Collage Source',
                        value: config.collageWidget?.source || 'Not set',
                        pass: !!config.collageWidget?.source
                    },
                    {
                        label: 'Has Pexels Queries',
                        value: config.collageWidget?.pexelsQueries ? '‚úì Yes' : '‚úó No',
                        pass: !!config.collageWidget?.pexelsQueries
                    },
                    {
                        label: 'Interval (seconds)',
                        value: config.collageWidget?.intervalSeconds || 'Not set',
                        pass: true
                    }
                ];
                
                debugInfo.innerHTML = debugData.map(item => `
                    <div class="debug-item ${item.pass ? 'pass' : 'fail'}">
                        <strong>${item.label}</strong>
                        <span>${item.value}</span>
                    </div>
                `).join('');
                
                console.log('[Test Page] Debug info refreshed');
            } catch (error) {
                debugInfo.innerHTML = `
                    <div class="debug-item fail">
                        <strong>Error</strong>
                        <span>${error.message}</span>
                    </div>
                `;
                console.error('[Test Page] Failed to fetch debug info:', error);
            }
        }
        
        function manualRetry() {
            console.log('[Test Page] Manual retry triggered');
            if (typeof loadHeroCollageImages === 'function') {
                // Reset initialization flag to allow retry
                window.__collageWidgetInitialized = false;
                loadHeroCollageImages();
                setTimeout(refreshDebugInfo, 1000);
            } else {
                console.error('[Test Page] loadHeroCollageImages function not found');
            }
        }
        
        // Initial load
        document.addEventListener('DOMContentLoaded', () => {
            console.log('[Test Page] Test page loaded');
            setTimeout(refreshDebugInfo, 1000);
            
            // Auto-refresh every 5 seconds
            setInterval(() => {
                refreshDebugInfo();
            }, 5000);
        });
    </script>
    
    <!-- Load the actual home-init.js script -->
    <script src="/assets/js/pages/home-init.js"></script>
</body>
</html>
