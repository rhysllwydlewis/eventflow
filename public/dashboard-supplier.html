<!DOCTYPE html><html lang='en-GB'><head><meta charset='utf-8'><meta name='viewport' content='width=device-width,initial-scale=1'><title>Supplier dashboard ‚Äî EventFlow</title><link rel='stylesheet' href='/assets/css/design-tokens.css?v=18.2.0'><link rel='stylesheet' href='/assets/css/styles.css?v=18.2.0'><link rel='stylesheet' href='/assets/css/eventflow-17.0.0.css?v=18.2.0'><link rel='stylesheet' href='/assets/css/utilities.css?v=18.2.0'><link rel='stylesheet' href='/assets/css/components.css?v=18.2.0'><link rel='stylesheet' href='/assets/css/animations.css?v=18.2.0'><link rel='stylesheet' href='/assets/css/mobile-optimizations.css?v=18.2.0'><link rel='stylesheet' href='/assets/css/ui-ux-fixes.css?v=18.2.0'><link rel='stylesheet' href='/assets/css/navbar.css?v=18.2.0'><link rel='stylesheet' href='/assets/css/skeleton.css?v=18.2.0'><link rel='stylesheet' href='/assets/css/dashboard-animations.css?v=18.2.0'><link rel='stylesheet' href='/assets/css/p3-features.css?v=18.2.0'><link rel='stylesheet' href='/assets/css/liquid-glass.css?v=18.2.0'><link rel='stylesheet' href='/assets/css/supplier-dashboard-improvements.css?v=18.2.0'><link rel='stylesheet' href='/assets/css/dashboard-hero.css?v=18.2.0'><script src="/assets/js/dashboard-guard.js?v=17.0.2"></script>
<script src="/assets/js/toast-notifications.js?v=18.2.0"></script>
<script>
// Global image error handler for supplier avatars and other images
document.addEventListener('DOMContentLoaded', function() {
  document.addEventListener('error', function(e) {
    if (e.target.tagName === 'IMG') {
      const img = e.target;
      // Only handle once per image
      if (img.dataset.errorHandled) return;
      img.dataset.errorHandled = 'true';
      
      // Prevent error propagation (note: browser console errors may still appear)
      e.stopPropagation();
      
      // Check if it's a supplier avatar, profile image, or package image
      if (img.src && (
        img.src.includes('/uploads/suppliers/') || 
        img.src.includes('/uploads/packages/') ||
        img.classList.contains('supplier-avatar') || 
        img.classList.contains('profile-image') ||
        img.classList.contains('package-image') ||
        img.closest('.package-card') ||
        img.closest('.supplier-card')
      )) {
        // Determine the appropriate placeholder based on context
        let placeholderSvg;
        
        if (img.src.includes('/uploads/packages/') || img.classList.contains('package-image') || img.closest('.package-card')) {
          // Package placeholder with box icon
          placeholderSvg = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"%3E%3Crect width="100" height="100" fill="%23f3f4f6"/%3E%3Cpath d="M50 25L25 37.5v25L50 75l25-12.5v-25L50 25zm0 5l18.75 9.375L50 48.75l-18.75-9.375L50 30zm-20 12.5L45 50v17.5L30 60V42.5zm40 0v17.5L55 67.5V50l15-7.5z" fill="%239ca3af"/%3E%3C/svg%3E';
          img.alt = 'Package image placeholder';
          img.title = 'Package image not available';
        } else {
          // Profile placeholder with person icon
          placeholderSvg = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"%3E%3Crect width="100" height="100" fill="%23e5e7eb"/%3E%3Cpath d="M50 45c8.284 0 15-6.716 15-15s-6.716-15-15-15-15 6.716-15 15 6.716 15 15 15zm0 5c-10 0-30 5-30 15v10h60V65c0-10-20-15-30-15z" fill="%239ca3af"/%3E%3C/svg%3E';
          img.alt = 'Profile placeholder';
          img.title = 'Image not available';
        }
        
        img.src = placeholderSvg;
        
        // Maintain aspect ratio and theme styling
        img.style.objectFit = 'cover';
        img.style.backgroundColor = '#f3f4f6';
      }
    }
  }, true);
});
</script>
  </head><body>
<!-- Screen Reader Announcer -->
<div id="sr-announcer" aria-live="polite" aria-atomic="true"></div>
<script>
// Screen reader announcement helper
window.announceToSR = function(message) {
  const announcer = document.getElementById('sr-announcer');
  if (announcer) {
    announcer.textContent = message;
    setTimeout(() => { announcer.textContent = ''; }, 1000);
  }
};
</script>
<a href="#main-content" class="skip-link">Skip to main content</a>
<!-- modern-ui -->
<!-- TOP NAVBAR - GOLD STANDARD REBUILD -->
<header class="ef-header" role="banner">
  <div class="ef-container">
    <div class="ef-header-content">
      <!-- Brand Logo - Enhanced Animated -->
      <a href="/" class="ef-brand" aria-label="EventFlow - Return to homepage">
        <div class="ef-logo" aria-hidden="true">
          <div class="ef-logo-inner"></div>
        </div>
        <span class="ef-brand-text">EventFlow</span>
      </a>

      <!-- Desktop Navigation -->
      <nav class="ef-nav-desktop" aria-label="Main navigation">
        <a href="/start" class="ef-nav-link">Plan</a>
        <a href="/suppliers" class="ef-nav-link">Suppliers</a>
        <a href="/marketplace" class="ef-nav-link">Marketplace</a>
        <a href="/blog" class="ef-nav-link">Guides</a>
        <a href="/pricing" class="ef-nav-link">Pricing</a>
      </nav>

      <!-- Actions -->
      <div class="ef-header-actions">
        <!-- Notification Bell (hidden by default, shown when logged in) -->
        <button 
          id="ef-notification-btn" 
          class="ef-icon-btn" 
          type="button" 
          aria-label="View notifications"
          style="display: none;"
        >
          <svg class="ef-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
            <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
          </svg>
          <span id="ef-notification-badge" class="ef-badge" style="display: none;">0</span>
        </button>

        <!-- Auth Button (Desktop) -->
        <a href="/auth" id="ef-auth-link" class="ef-btn ef-btn-primary">
          Log in
        </a>

        <!-- Dashboard Link (Desktop, hidden by default) -->
        <a href="#" id="ef-dashboard-link" class="ef-nav-link" style="display: none;">
          Dashboard
        </a>

        <!-- Mobile Menu Toggle -->
        <button 
          id="ef-mobile-toggle" 
          class="ef-mobile-toggle" 
          type="button"
          aria-label="Toggle menu"
          aria-expanded="false"
          aria-controls="ef-mobile-menu"
        >
          <span class="ef-toggle-line"></span>
          <span class="ef-toggle-line"></span>
          <span class="ef-toggle-line"></span>
        </button>
      </div>
    </div>
  </div>

  <!-- Mobile Menu -->
  <div id="ef-mobile-menu" class="ef-mobile-menu" role="dialog" aria-modal="true" aria-label="Mobile navigation">
    <nav class="ef-mobile-nav" aria-label="Primary navigation">
      <a href="/start" class="ef-mobile-link">Plan an Event</a>
      <a href="/suppliers" class="ef-mobile-link">Browse Suppliers</a>
      <a href="/marketplace" class="ef-mobile-link">Marketplace</a>
      <a href="/pricing" class="ef-mobile-link">Pricing</a>
      <a href="/blog" class="ef-mobile-link">Guides</a>
      <a href="/for-suppliers" class="ef-mobile-link">For Suppliers</a>
      <a href="/faq" class="ef-mobile-link">FAQ</a>
      <div class="ef-mobile-divider"></div>
      <a href="/auth" id="ef-mobile-auth" class="ef-mobile-link ef-mobile-primary">Log in</a>
      <a href="#" id="ef-mobile-dashboard" class="ef-mobile-link" style="display: none;">Dashboard</a>
      <a href="/settings.html" id="ef-mobile-settings" class="ef-mobile-link" style="display: none;">‚öôÔ∏è Settings</a>
      <a href="#" id="ef-mobile-logout" class="ef-mobile-link" style="display: none;">Log out</a>
    </nav>
  </div>
</header>

<!-- Load auth state manager first -->
<script src="/assets/js/utils/auth-state.js" defer></script>
<!-- Burger menu - simple standalone implementation -->
<script src="/assets/js/burger-menu.js" defer></script>
<script src="/assets/js/navbar.js" defer></script>

<script src="/assets/js/websocket-client.js" defer></script>

<!-- Mobile Section Navigation -->
<nav class="dashboard-mobile-nav" aria-label="Dashboard sections" data-test="supplier-mobile-nav">
  <div class="mobile-nav-pills" data-test="mobile-nav-pills">
    <button class="mobile-nav-pill active" data-section="welcome-section" data-test="nav-overview">üè† Overview</button>
    <button class="mobile-nav-pill" data-section="supplier-stats-grid" data-test="nav-stats">üìä Stats</button>
    <button class="mobile-nav-pill" data-section="my-suppliers" data-test="nav-profiles">üë§ Profiles</button>
    <button class="mobile-nav-pill" data-section="my-packages" data-test="nav-packages">üì¶ Packages</button>
    <button class="mobile-nav-pill" data-section="threads-sup" data-test="nav-messages">üí¨ Messages <span class="pill-badge" id="mobile-msg-badge" style="display:none;">0</span></button>
    <button class="mobile-nav-pill" data-section="tickets-sup" data-test="nav-tickets">üé´ Tickets</button>
  </div>
</nav>

<main id="main-content" class='section'><div class='container'>
  <div id="supplier-pro-ribbon" class="pro-ribbon" style="display:none"></div>

<!-- New Dashboard Hero Section - Built from Scratch -->
<section id="welcome-section" class="dashboard-hero" aria-labelledby="welcome-heading" data-test="welcome-card">
  <!-- Animated Background Elements -->
  <div class="dashboard-hero__bg">
    <div class="dashboard-hero__gradient"></div>
    <div class="dashboard-hero__blob dashboard-hero__blob--1"></div>
    <div class="dashboard-hero__blob dashboard-hero__blob--2"></div>
    <div class="dashboard-hero__grid"></div>
  </div>

  <!-- Main Content -->
  <div class="dashboard-hero__content">
    <!-- Header Section -->
    <div class="dashboard-hero__header">
      <div class="dashboard-hero__greeting-wrapper">
        <span class="dashboard-hero__greeting" id="welcome-greeting" data-test="time-greeting">Good day</span>
        <h1 id="welcome-heading" class="dashboard-hero__title">
          <span class="dashboard-hero__title-main">Your Dashboard</span>
          <span class="dashboard-hero__title-highlight">Command Center</span>
        </h1>
        <p class="dashboard-hero__subtitle">Manage your business, track performance, and grow your presence</p>
      </div>

      <!-- Quick Stats Grid -->
      <div class="dashboard-hero__stats">
        <div class="dashboard-stat-card dashboard-stat-card--primary" data-test="stat-counter-enquiries">
          <div class="dashboard-stat-card__icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
            </svg>
          </div>
          <div class="dashboard-stat-card__content">
            <div class="dashboard-stat-card__value" id="quick-stat-enquiries" data-target="12">0</div>
            <div class="dashboard-stat-card__label">New Enquiries</div>
          </div>
          <div class="dashboard-stat-card__trend dashboard-stat-card__trend--up">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
              <polyline points="17 6 23 6 23 12"/>
            </svg>
            <span>+12%</span>
          </div>
        </div>

        <div class="dashboard-stat-card dashboard-stat-card--secondary" data-test="stat-counter-profiles">
          <div class="dashboard-stat-card__icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
              <circle cx="12" cy="7" r="4"/>
            </svg>
          </div>
          <div class="dashboard-stat-card__content">
            <div class="dashboard-stat-card__value" id="quick-stat-profiles" data-target="4">0</div>
            <div class="dashboard-stat-card__label">Active Profiles</div>
          </div>
          <div class="dashboard-stat-card__badge">Live</div>
        </div>

        <div class="dashboard-stat-card dashboard-stat-card--accent">
          <div class="dashboard-stat-card__icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
            </svg>
          </div>
          <div class="dashboard-stat-card__content">
            <div class="dashboard-stat-card__value">4.8</div>
            <div class="dashboard-stat-card__label">Avg. Rating</div>
          </div>
          <div class="dashboard-stat-card__stars">
            <span>‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Quick Actions Bar -->
    <div class="dashboard-hero__actions">
      <button class="dashboard-action-chip dashboard-action-chip--primary" onclick="document.getElementById('sup-name').focus();document.getElementById('sup-name').scrollIntoView({behavior:'smooth',block:'center'});">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <line x1="12" y1="8" x2="12" y2="16"/>
          <line x1="8" y1="12" x2="16" y2="12"/>
        </svg>
        <span>Create Profile</span>
      </button>
      
      <button class="dashboard-action-chip" onclick="document.getElementById('pkg-title').focus();document.getElementById('pkg-title').scrollIntoView({behavior:'smooth',block:'center'});">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="18" height="18" rx="2"/>
          <path d="M3 9h18"/>
          <path d="M9 21V9"/>
        </svg>
        <span>New Package</span>
      </button>
      
      <button class="dashboard-action-chip" id="viewConversationsBtn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
        </svg>
        <span>Messages</span>
      </button>
      
      <button class="dashboard-action-chip" onclick="showEarningsComingSoon();">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" y1="1" x2="12" y2="23"/>
          <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
        </svg>
        <span>View Earnings</span>
      </button>

      <button class="dashboard-action-chip" onclick="document.getElementById('supplier-stats-grid').scrollIntoView({behavior:'smooth',block:'start'});">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="7" height="7"/>
          <rect x="14" y="3" width="7" height="7"/>
          <rect x="14" y="14" width="7" height="7"/>
          <rect x="3" y="14" width="7" height="7"/>
        </svg>
        <span>View Stats</span>
      </button>

      <button class="dashboard-action-chip" onclick="window.location.href='mailto:support@eventflow.com?subject=Supplier Support Request';">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
          <line x1="12" y1="17" x2="12.01" y2="17"/>
        </svg>
        <span>Get Help</span>
      </button>

      <!-- Pro Tip Badge -->
      <div class="dashboard-hero__tip" id="welcome-pro-tip" aria-live="polite" data-test="pro-tip">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <path d="M12 16v-4"/>
          <path d="M12 8h.01"/>
        </svg>
        <span id="pro-tip-text">Tip: Fast responses lead to more bookings</span>
      </div>
    </div>
  </div>

  <!-- Dismiss Button -->
  <button class="dashboard-hero__dismiss" id="welcome-dismiss-btn" aria-label="Dismiss welcome section" title="Dismiss" data-test="welcome-dismiss">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <line x1="18" y1="6" x2="6" y2="18"/>
      <line x1="6" y1="6" x2="18" y2="18"/>
    </svg>
  </button>
</section>

<!-- Statistics Widgets -->
<h2 id="stats-heading" class="sr-only">Dashboard Statistics</h2>
<section id="supplier-stats-grid" aria-labelledby="stats-heading" role="region"></section>

<!-- Performance Analytics Chart -->
<div id="supplier-performance-chart"></div>

<!-- Enquiry Trend Chart -->
<div id="enquiry-trend-chart"></div>

<!-- Earnings Overview Section (Placeholder) -->
<section id="earnings-overview" class="card" style="margin-top: 2rem; padding: 2rem;" aria-labelledby="earnings-heading">
  <h2 id="earnings-heading" style="margin-bottom: 1rem; font-size: 1.5rem;">üí∞ Earnings Overview</h2>
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
    <div style="padding: 1rem; background: linear-gradient(135deg, #10B981 0%, #34D399 100%); border-radius: 8px; color: white;">
      <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Total Revenue</div>
      <div style="font-size: 2rem; font-weight: 600;">¬£0.00</div>
    </div>
    <div style="padding: 1rem; background: linear-gradient(135deg, #3B82F6 0%, #60A5FA 100%); border-radius: 8px; color: white;">
      <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">This Month</div>
      <div style="font-size: 2rem; font-weight: 600;">¬£0.00</div>
    </div>
    <div style="padding: 1rem; background: linear-gradient(135deg, #F59E0B 0%, #FBBF24 100%); border-radius: 8px; color: white;">
      <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Pending</div>
      <div style="font-size: 2rem; font-weight: 600;">¬£0.00</div>
    </div>
  </div>
  <div style="padding: 1.5rem; background: #F9FAFB; border-radius: 8px; text-align: center;">
    <p style="margin-bottom: 1rem; color: #6B7280;">Full earnings tracking and payment management coming soon!</p>
    <p style="font-size: 0.875rem; color: #9CA3AF;">Track revenue, manage invoices, view payment history, and export financial reports.</p>
  </div>
</section>

<!-- Profile Completeness Checklist -->
<div id="profile-completeness-widget"></div>

<!-- Calendar & Availability Widget -->
<section id="availability-calendar" class="card" style="margin-top: 2rem; padding: 2rem;" aria-labelledby="calendar-heading">
  <div class="supplier-card-header" style="border-bottom: 1px solid #E5E7EB; padding-bottom: 1rem; margin-bottom: 1.5rem;">
    <div class="supplier-card-header__content">
      <h2 id="calendar-heading" style="font-size: 1.5rem; margin: 0;">üìÖ Availability Calendar</h2>
      <p class="small" style="margin: 0; color: #6B7280;">Manage your available dates and bookings</p>
    </div>
  </div>
  
  <div style="display: grid; grid-template-columns: 1fr auto; gap: 2rem; align-items: start;">
    <div>
      <div style="background: #F9FAFB; padding: 2rem; border-radius: 8px; text-align: center; min-height: 300px; display: flex; flex-direction: column; justify-content: center;">
        <div style="font-size: 4rem; margin-bottom: 1rem;">üìÜ</div>
        <h3 style="font-size: 1.25rem; margin-bottom: 0.5rem;">Calendar Coming Soon</h3>
        <p style="color: #6B7280; margin-bottom: 1rem;">Interactive calendar for managing bookings and availability</p>
        <div style="display: flex; gap: 0.5rem; justify-content: center; flex-wrap: wrap; font-size: 0.875rem;">
          <span style="padding: 0.5rem 1rem; background: white; border-radius: 4px; border: 1px solid #E5E7EB;">‚úÖ View bookings</span>
          <span style="padding: 0.5rem 1rem; background: white; border-radius: 4px; border: 1px solid #E5E7EB;">üö´ Block dates</span>
          <span style="padding: 0.5rem 1rem; background: white; border-radius: 4px; border: 1px solid #E5E7EB;">üîÑ Recurring patterns</span>
        </div>
      </div>
    </div>
    
    <div style="min-width: 250px;">
      <h4 style="font-size: 1rem; margin-bottom: 1rem; color: #374151;">Upcoming Bookings</h4>
      <div style="background: #F9FAFB; padding: 1.5rem; border-radius: 8px; text-align: center;">
        <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìã</div>
        <p style="font-size: 0.875rem; color: #6B7280; margin: 0;">No upcoming bookings</p>
      </div>
      
      <h4 style="font-size: 1rem; margin: 1.5rem 0 1rem; color: #374151;">Quick Actions</h4>
      <div style="display: flex; flex-direction: column; gap: 0.5rem;">
        <button style="padding: 0.75rem; background: white; border: 1px solid #E5E7EB; border-radius: 4px; cursor: pointer; text-align: left; transition: background 0.2s;" onmouseover="this.style.background='#F9FAFB'" onmouseout="this.style.background='white'">
          <div style="font-weight: 600; margin-bottom: 0.25rem;">Block Date Range</div>
          <div style="font-size: 0.75rem; color: #6B7280;">Mark dates as unavailable</div>
        </button>
        <button style="padding: 0.75rem; background: white; border: 1px solid #E5E7EB; border-radius: 4px; cursor: pointer; text-align: left; transition: background 0.2s;" onmouseover="this.style.background='#F9FAFB'" onmouseout="this.style.background='white'">
          <div style="font-weight: 600; margin-bottom: 0.25rem;">Set Availability</div>
          <div style="font-size: 0.75rem; color: #6B7280;">Configure weekly schedule</div>
        </button>
      </div>
    </div>
  </div>
</section>

<h2 id="profiles-heading">Your supplier profiles</h2>
<div class="card" role="region" aria-labelledby="profiles-heading">
  <div class="supplier-card-header">
    <div class="supplier-card-header__content">
      <h3>Profile management</h3>
      <p class="small">
        Experimental: each profile gets a simple listing health score based on photos, description and details you&apos;ve added.
      </p>
    </div>
    <button type="button" class="form-toggle-btn" id="toggle-profile-form" data-test="toggle-profile-form" aria-expanded="false" aria-controls="profile-form-section" aria-label="Toggle profile creation form">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18" aria-hidden="true">
        <line x1="12" y1="5" x2="12" y2="19"/>
        <line x1="5" y1="12" x2="19" y2="12"/>
      </svg>
      <span class="label">Create Profile</span>
    </button>
  </div>
  
  <div id="my-suppliers" class="section" data-test="my-suppliers-list">
    <div class="skeleton skeleton-text skeleton-text-long"></div>
    <div class="skeleton skeleton-text skeleton-text-medium"></div>
  </div>
  
  <!-- Collapsible Profile Form Section -->
  <div id="profile-form-section" class="form-section-collapsible" data-test="profile-form-section">
    <h3 class="supplier-section-header">Create / Edit profile</h3>
    <form id="supplier-form" action="#">
      <input type="hidden" id="sup-id" name="id">
      <div class="form-row supplier-form-grid">
        <div>
          <label for="sup-name">Business name</label>
          <input id="sup-name" name="name">
        </div>
        <div>
          <label>Category</label>
          <select id="sup-category" name="category">
            <option value="">Choose a category‚Ä¶</option>
            <option>Venues</option>
            <option>Catering</option>
            <option>Photography</option>
            <option>Entertainment</option>
            <option>Flowers & d√©cor</option>
            <option>Transport</option>
            <option>Extras & add-ons</option>
          </select>
        </div>
        <div>
          <label>Location</label>
          <input id="sup-location" name="location" placeholder="City, region">
        </div>
        <div>
          <label>Price display</label>
          <input id="sup-price" name="price_display" placeholder="e.g. From ¬£500 or ¬£¬£">
        </div>
      </div>

      <div class="form-row">
        <label>Short description</label>
        <input id="sup-short" name="description_short">
      </div>

      <div class="form-row">
        <label>Long description</label>
        <textarea id="sup-long" name="description_long" rows="4"></textarea>
      </div>

      <div class="form-row">
        <label>Website</label>
        <input id="sup-website" name="website" placeholder="your-website-url">
      </div>

      <div class="form-row">
        <label>License / Insurance</label>
        <input id="sup-license" name="license" placeholder="e.g. PLI ¬£5m">
      </div>

      <div class="form-row">
        <label>Amenities (comma-separated)</label>
        <input id="sup-amenities" name="amenities" placeholder="Parking, Garden, PA system">
      </div>

      <div class="form-row">
        <label>Max guests</label>
        <input id="sup-max" name="maxGuests" type="number" min="0" step="1">
      </div>

      <div class="form-row form-row-hidden" id="venue-postcode-row">
        <label for="sup-venue-postcode">Venue postcode <span class="form-required">*</span></label>
        <input id="sup-venue-postcode" name="venuePostcode" placeholder="e.g. SW1A 1AA" aria-describedby="venue-postcode-help venue-postcode-error" aria-required="false">
        <p class="small form-help-text" id="venue-postcode-help">Required for Venues category. Enter a valid UK postcode.</p>
        <p class="small form-error-text" id="venue-postcode-error" role="alert" aria-live="polite"></p>
      </div>

      <div class="form-row form-row-hidden">
        <label>Photos (one URL per line)</label>
        <textarea id="sup-photos" name="photos" rows="3"></textarea>
      </div>

      <div class="form-row">
        <label>Upload photos</label>
        <div id="sup-photo-drop" class="photo-drop-zone">
          Drag &amp; drop images here, or click to choose files.
        </div>
        <div id="sup-photo-preview" class="photo-preview-grid"></div>
        <p class="tiny">
          You can upload multiple photos ‚Äì they&apos;ll be shown on your public listing.
        </p>
      </div>

      <!-- Profile Customization Link -->
      <div class="form-row supplier-cta-section">
        <div class="supplier-cta-banner">
          <div class="supplier-cta-banner-content">
            <h3 class="supplier-cta-banner-title">
              ‚ú® Profile Customization 
              <span class="supplier-cta-banner-badge">New</span>
            </h3>
            <p class="supplier-cta-banner-text">
              Make your profile stand out with custom banners, taglines, highlights, and social media links
            </p>
          </div>
          <a href="/supplier/profile-customization.html" class="supplier-cta-banner-button">
            Customize Profile ‚Üí
          </a>
        </div>
      </div>

      <div class="form-actions supplier-form-actions">
        <button class="cta" id="sup-create" type="submit">Save profile</button>
        <button type="button" id="sup-preview" class="cta secondary">üëÅÔ∏è Preview Profile</button>
        <button type="button" class="cta secondary" id="cancel-profile-form" style="display: none;">Cancel</button>
        <span class="small" id="sup-status"></span>
      </div>
    </form>
  </div>
</div>

<script>
// Show/hide venue postcode field based on category selection
(function() {
  const categorySelect = document.getElementById('sup-category');
  const venuePostcodeRow = document.getElementById('venue-postcode-row');
  const venuePostcodeInput = document.getElementById('sup-venue-postcode');
  const venuePostcodeError = document.getElementById('venue-postcode-error');

  if (!categorySelect || !venuePostcodeRow || !venuePostcodeInput) {
    return;
  }

  // UK postcode validation regex (matches backend validation)
  const ukPostcodeRegex = /^[A-Z]{1,2}\d{1,2}[A-Z]?\s*\d[A-Z]{2}$/i;

  function validatePostcode(postcode) {
    if (!postcode || !postcode.trim()) {
      return { valid: false, message: 'Postcode is required for Venues' };
    }
    if (!ukPostcodeRegex.test(postcode.trim())) {
      return { valid: false, message: 'Please enter a valid UK postcode (e.g., SW1A 1AA)' };
    }
    return { valid: true, message: '' };
  }

  function updateVenuePostcodeVisibility() {
    const selectedCategory = categorySelect.value;
    if (selectedCategory === 'Venues') {
      venuePostcodeRow.classList.remove('form-row-hidden');
      venuePostcodeInput.setAttribute('aria-required', 'true');
    } else {
      venuePostcodeRow.classList.add('form-row-hidden');
      venuePostcodeInput.value = ''; // Clear value when not Venues
      venuePostcodeInput.setAttribute('aria-required', 'false');
      venuePostcodeError.classList.remove('visible');
    }
  }

  // Real-time validation on input
  venuePostcodeInput.addEventListener('input', function() {
    if (categorySelect.value !== 'Venues') {
      return;
    }
    const result = validatePostcode(this.value);
    if (!result.valid && this.value.trim()) {
      venuePostcodeError.textContent = result.message;
      venuePostcodeError.classList.add('visible');
    } else {
      venuePostcodeError.classList.remove('visible');
    }
  });

  // Validate on blur
  venuePostcodeInput.addEventListener('blur', function() {
    if (categorySelect.value !== 'Venues') {
      return;
    }
    const result = validatePostcode(this.value);
    if (!result.valid) {
      venuePostcodeError.textContent = result.message;
      venuePostcodeError.classList.add('visible');
    }
  });

  // Update visibility on category change
  categorySelect.addEventListener('change', updateVenuePostcodeVisibility);

  // Initialize visibility on page load
  updateVenuePostcodeVisibility();

  // Make validation function available globally for form submission
  window.validateVenuePostcode = function() {
    if (categorySelect.value === 'Venues') {
      const result = validatePostcode(venuePostcodeInput.value);
      if (!result.valid) {
        venuePostcodeError.textContent = result.message;
        venuePostcodeError.classList.add('visible');
        venuePostcodeInput.focus();
        // Scroll to the error field smoothly
        venuePostcodeInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
        return false;
      }
    }
    return true;
  };
})();
</script>

<div class="card supplier-dashboard-card">
  <div class="supplier-card-header">
    <div class="supplier-card-header__content">
      <h3>Your packages</h3>
      <p class="small" id="pkg-limit-note">Checking your package allowance‚Ä¶</p>
    </div>
    <button type="button" class="form-toggle-btn" id="toggle-package-form" data-test="toggle-package-form" aria-expanded="false" aria-controls="package-form-section" aria-label="Toggle package creation form">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18" aria-hidden="true">
        <line x1="12" y1="5" x2="12" y2="19"/>
        <line x1="5" y1="12" x2="19" y2="12"/>
      </svg>
      <span class="label">Create Package</span>
    </button>
  </div>
  
  <div id="my-packages" class="section" data-test="my-packages-list">
    <div class="skeleton skeleton-text skeleton-text-long"></div>
    <div class="skeleton skeleton-text skeleton-text-medium"></div>
  </div>
  
  <!-- Collapsible Package Form Section -->
  <div id="package-form-section" class="form-section-collapsible" data-test="package-form-section">
    <h3 class="supplier-section-header">Create a package</h3>
    <form id="package-form" action="#">
      <div class="form-row supplier-form-grid">
        <div><label>For supplier</label><select id="pkg-supplier"></select></div>
        <div><label>Title</label><input id="pkg-title" name="title"></div>
        <div><label>Price</label><input id="pkg-price" name="price" placeholder="e.g. ¬£999 or ¬£45 pp"></div>
      </div>
      <div class="form-row supplier-form-grid">
        <div>
          <label>Primary Category <span class="form-required">*</span></label>
          <select id="pkg-category" name="primaryCategoryKey" required>
            <option value="">Choose a category‚Ä¶</option>
            <option value="venues">Venues</option>
            <option value="photography">Photography</option>
            <option value="catering">Catering</option>
            <option value="flowers">Flowers & D√©cor</option>
            <option value="hair-makeup">Hair & Makeup</option>
            <option value="entertainment">Entertainment</option>
            <option value="transport">Transport</option>
            <option value="extras">Extras & Add-ons</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Event Types <span class="required">*</span></label>
          <div class="checkbox-group">
            <label class="checkbox-inline">
              <input type="checkbox" id="pkg-event-wedding" name="eventTypes" value="wedding" class="form-checkbox">
              <span class="checkbox-text">Wedding</span>
            </label>
            <label class="checkbox-inline">
              <input type="checkbox" id="pkg-event-other" name="eventTypes" value="other" class="form-checkbox">
              <span class="checkbox-text">Other Events</span>
            </label>
          </div>
          <p class="form-help">Select at least one</p>
        </div>
      </div>
      <div class="form-row"><label>Description</label><textarea id="pkg-desc" name="description" rows="4"></textarea></div>
      <div class="form-row form-row-hidden">
        <label>Image URL (optional)</label>
        <input id="pkg-image" name="image" placeholder="your-website-url">
      </div>
      <div class="form-row">
        <label>Upload image (optional)</label>
        <div id="pkg-photo-drop" class="photo-drop-zone">Drag &amp; drop an image here, or click to choose a file.</div>
        <div id="pkg-photo-preview" class="photo-preview-grid"></div>
      </div>
      <div class="form-actions supplier-form-actions">
        <button class="cta" type="submit">Save package</button>
        <button type="button" class="cta secondary" id="cancel-package-form" style="display: none;">Cancel</button>
        <span class="small" id="pkg-status"></span>
      </div>
      <input type="hidden" name="supplierId" id="pkg-supplier-id-hidden">
      <input type="hidden" name="id" id="pkg-id-hidden">
    </form>
  </div>
</div>

<!-- Subscription Card -->
<div class="card supplier-dashboard-card">
  <div class="supplier-card-header">
    <div class="supplier-card-header__content">
      <h3>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20" class="supplier-card-header__icon" aria-hidden="true">
          <rect x="2" y="5" width="20" height="14" rx="2"/>
          <line x1="2" y1="10" x2="22" y2="10"/>
        </svg>
        Subscription
      </h3>
      <p class="small">Manage your plan and billing</p>
    </div>
  </div>
  <div id="supplier-subscription-card" class="section">
    <p class="small">Checking subscription status‚Ä¶</p>
  </div>
</div>

<!-- Lead Quality Card -->
<div class="card supplier-dashboard-card">
  <div class="supplier-card-header">
    <div class="supplier-card-header__content">
      <h3>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20" class="supplier-card-header__icon" aria-hidden="true">
          <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
        </svg>
        Lead Quality Overview
      </h3>
      <p class="small">Track the quality of your enquiries</p>
    </div>
  </div>
  <div id="lead-quality-breakdown" class="section">
    <div class="skeleton skeleton-text skeleton-text-long"></div>
    <div class="skeleton skeleton-text skeleton-text-medium"></div>
  </div>
</div>


<section class="card supplier-dashboard-card" role="region" aria-labelledby="tickets-heading">
  <div class="supplier-card-header">
    <h3 id="tickets-heading">Support Tickets</h3>
    <button class="cta supplier-card-action-btn" id="createSupplierTicketBtn">Create Ticket</button>
  </div>
  <div id="tickets-sup" class="section">
    <div class="skeleton skeleton-text skeleton-text-long"></div>
    <div class="skeleton skeleton-text skeleton-text-medium"></div>
  </div>
</section>

<section class="card supplier-dashboard-card" role="region" aria-labelledby="messages-heading">
  <div class="supplier-card-header">
    <h3 id="messages-heading">Messages</h3>
    <span id="unreadMessageBadge" class="badge badge-info supplier-unread-badge" aria-label="0 unread messages">0 unread</span>
  </div>
  <div id="threads-sup" class="section">
    <div class="skeleton skeleton-text skeleton-text-long"></div>
    <div class="skeleton skeleton-text skeleton-text-medium"></div>
  </div>
</section>

<!-- Reviews & Ratings Section -->
<section class="card supplier-dashboard-card" role="region" aria-labelledby="reviews-heading">
  <div class="supplier-card-header">
    <div class="supplier-card-header__content">
      <h3 id="reviews-heading">‚≠ê Reviews & Ratings</h3>
      <p class="small">Manage customer feedback and respond to reviews</p>
    </div>
  </div>
  <div id="supplier-reviews-section" class="section">
    <div style="padding: 2rem; text-align: center; background: #F9FAFB; border-radius: 8px;">
      <div style="font-size: 3rem; margin-bottom: 1rem;">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
      <div style="font-size: 1.5rem; font-weight: 600; margin-bottom: 0.5rem;">No reviews yet</div>
      <p style="color: #6B7280; margin-bottom: 1.5rem;">Reviews from customers will appear here once you complete your first booking.</p>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; max-width: 600px; margin: 0 auto;">
        <div style="padding: 1rem; background: white; border-radius: 8px; border: 1px solid #E5E7EB;">
          <div style="font-size: 0.875rem; color: #9CA3AF; margin-bottom: 0.25rem;">Average Rating</div>
          <div style="font-size: 1.5rem; font-weight: 600;">0.0</div>
        </div>
        <div style="padding: 1rem; background: white; border-radius: 8px; border: 1px solid #E5E7EB;">
          <div style="font-size: 0.875rem; color: #9CA3AF; margin-bottom: 0.25rem;">Total Reviews</div>
          <div style="font-size: 1.5rem; font-weight: 600;">0</div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  // Quick Actions: Handle view conversations button
  document.addEventListener('DOMContentLoaded', () => {
    const viewConvBtn = document.getElementById('viewConversationsBtn');
    if (viewConvBtn) {
      viewConvBtn.addEventListener('click', () => {
        const threadsSection = document.getElementById('threads-sup');
        if (threadsSection) {
          threadsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      });
    }
  });
</script>

<!-- Mobile Navigation Scroll Spy -->
<script>
(function() {
  'use strict';
  
  const mobileNav = document.querySelector('.dashboard-mobile-nav');
  if (!mobileNav) return;
  
  const pills = mobileNav.querySelectorAll('.mobile-nav-pill');
  const sections = [];
  
  // Collect section elements
  pills.forEach(pill => {
    const sectionId = pill.dataset.section;
    const section = document.getElementById(sectionId);
    if (section) {
      sections.push({ id: sectionId, element: section, pill: pill });
    }
  });
  
  // Click handler for pills
  pills.forEach(pill => {
    pill.addEventListener('click', function() {
      const sectionId = this.dataset.section;
      const section = document.getElementById(sectionId);
      if (section) {
        section.scrollIntoView({ behavior: 'smooth', block: 'start' });
        
        // Update active state
        pills.forEach(p => p.classList.remove('active'));
        this.classList.add('active');
        
        // Scroll pill into view
        this.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
      }
    });
  });
  
  // Scroll spy
  const STICKY_NAV_OFFSET = 120; // Height of header + mobile nav
  let ticking = false;
  function updateActiveSection() {
    const scrollPosition = window.scrollY + STICKY_NAV_OFFSET;
    
    let activeSection = sections[0];
    
    for (const section of sections) {
      if (section.element.offsetTop <= scrollPosition) {
        activeSection = section;
      }
    }
    
    if (activeSection) {
      pills.forEach(p => p.classList.remove('active'));
      activeSection.pill.classList.add('active');
      // ‚úÖ REMOVED scrollIntoView - no more feedback loop
    }
    
    ticking = false;
  }
  
  window.addEventListener('scroll', function() {
    if (!ticking) {
      window.requestAnimationFrame(updateActiveSection);
      ticking = true;
    }
  }, { passive: true });
})();
</script>

<script src="/assets/js/app.js?v=18.2.0"></script>
<script src="/assets/js/components.js?v=18.2.0"></script>
<script type="module" src="/assets/js/supplier-tickets.js?v=18.2.0"></script>
<script type="module" src="/assets/js/supplier-messages.js?v=18.2.0"></script>
<script type="module" src="/assets/js/supplier-gallery.js?v=18.2.0"></script>
<script type="module">
  // Display subscription status on dashboard using MongoDB API
  import { 
    initializeFeatureAccess, 
    displayPackageLimitNotice, 
    enforcePackageLimit 
  } from '/supplier/js/feature-access.js';
  
  import { createStatsGrid, createProfileChecklist } from '/assets/js/dashboard-widgets.js';
  import { createPerformanceChart, createAnalyticsSummary, createEnquiryTrendChart } from '/assets/js/supplier-analytics-chart.js';
  import { initCountUp } from '/assets/js/count-up-animation.js';
  
  // Initialize feature access control (non-blocking)
  initializeFeatureAccess().catch(err => {
    console.error('Error initializing feature access:', err);
  });
  
  // Placeholder function for earnings feature (coming soon)
  window.showEarningsComingSoon = function() {
    if (typeof Toast !== 'undefined') {
      Toast.info('Earnings dashboard coming soon! Track your revenue, payments, and invoices.');
    } else {
      alert('Earnings dashboard coming soon! Track your revenue, payments, and invoices.');
    }
  };
  
  // Initialize supplier dashboard widgets
  async function initSupplierDashboardWidgets() {
    try {
      // Fetch real analytics from the supplier analytics API
      let analytics = null;
      let totalEnquiries = 0;
      let views7d = 0;
      let responseRate = 100;
      let avgResponseTime = 0;
      
      try {
        // Fetch analytics using the real tracking system
        const analyticsResponse = await fetch('/api/supplier/analytics?days=7', { credentials: 'include' });
        if (analyticsResponse.ok) {
          const analyticsData = await analyticsResponse.json();
          analytics = analyticsData.analytics;
          
          // Extract values from real analytics
          totalEnquiries = analytics.totalEnquiries || 0;
          views7d = analytics.totalViews || 0;
          responseRate = analytics.responseRate || 100;
          avgResponseTime = analytics.avgResponseTime || 0;
        } else {
          console.warn('Analytics API not available, fetching threads for basic stats');
          // Fallback to basic thread count
          const threadsResponse = await fetch('/api/threads/my', { credentials: 'include' });
          if (threadsResponse.ok) {
            const threadsData = await threadsResponse.json();
            totalEnquiries = (threadsData.items || []).length;
          }
        }
      } catch (err) {
        console.error('Error fetching analytics:', err);
      }
      
      // Create statistics widgets with real data
      createStatsGrid([
        {
          icon: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>',
          value: views7d,
          label: 'Profile Views (7d)',
          format: 'number',
          color: 'linear-gradient(135deg, #3B82F6 0%, #60A5FA 100%)',
        },
        {
          icon: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>',
          value: totalEnquiries,
          label: 'Total Enquiries',
          format: 'number',
          color: 'linear-gradient(135deg, #10B981 0%, #34D399 100%)',
        },
        {
          icon: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>',
          value: responseRate,
          label: 'Response Rate',
          format: 'percent',
          color: 'linear-gradient(135deg, #F59E0B 0%, #FBBF24 100%)',
        },
        {
          icon: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>',
          value: avgResponseTime,
          label: 'Avg Response Time',
          format: 'time',
          color: 'linear-gradient(135deg, #8B5CF6 0%, #A78BFA 100%)',
          pulse: true,
        },
      ], 'supplier-stats-grid');
      
      // Prepare chart data from analytics
      const labels = [];
      const viewsData = [];
      const enquiriesData = [];
      
      if (analytics && analytics.dailyData && analytics.dailyData.length > 0) {
        // Use real daily data from analytics
        analytics.dailyData.forEach(day => {
          labels.push(day.label);
          viewsData.push(day.views);
          enquiriesData.push(day.enquiries);
        });
      } else {
        // Fallback: generate placeholder data for 7 days
        for (let i = 6; i >= 0; i--) {
          const date = new Date();
          date.setDate(date.getDate() - i);
          labels.push(date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }));
          viewsData.push(0);
          enquiriesData.push(0);
        }
      }
      
      await createPerformanceChart('supplier-performance-chart', viewsData, enquiriesData, labels);
      
      // Create enquiry trend chart
      await createEnquiryTrendChart('enquiry-trend-chart');
      
      // Fetch supplier profiles to check completion
      let hasProfile = false;
      let hasPhotos = false;
      let hasBanner = false;
      let hasTagline = false;
      let hasHighlights = false;
      let hasSocialLinks = false;
      
      try {
        const suppliersResponse = await fetch('/api/me/suppliers', { credentials: 'include' });
        if (suppliersResponse.ok) {
          const suppliersData = await suppliersResponse.json();
          const suppliers = suppliersData.items || [];
          hasProfile = suppliers.length > 0;
          if (hasProfile && suppliers[0]) {
            const supplier = suppliers[0];
            hasPhotos = supplier.photos && supplier.photos.length >= 5;
            hasBanner = !!supplier.bannerUrl;
            hasTagline = !!supplier.tagline;
            hasHighlights = supplier.highlights && supplier.highlights.length >= 3;
            hasSocialLinks = supplier.socialLinks && Object.keys(supplier.socialLinks).length >= 2;
          }
        }
      } catch (err) {
        console.error('Error fetching suppliers:', err);
      }
      
      // Fetch packages to check if at least one exists
      let hasPackage = false;
      
      try {
        const packagesResponse = await fetch('/api/me/packages', { credentials: 'include' });
        if (packagesResponse.ok) {
          const packagesData = await packagesResponse.json();
          const packages = packagesData.items || [];
          hasPackage = packages.length > 0;
        }
      } catch (err) {
        console.error('Error fetching packages:', err);
      }
      
      // Check email verification status
      let emailVerified = false;
      
      try {
        const userResponse = await fetch('/api/auth/me', { credentials: 'include' });
        if (userResponse.ok) {
          const userData = await userResponse.json();
          emailVerified = userData.user?.emailVerified || false;
        }
      } catch (err) {
        console.error('Error checking email verification:', err);
      }
      
      // Create profile completeness checklist with new fields
      createProfileChecklist({
        basicInfo: hasProfile,
        photos: hasPhotos,
        package: hasPackage,
        emailVerified: emailVerified,
        banner: hasBanner,
        tagline: hasTagline,
        highlights: hasHighlights,
        socialLinks: hasSocialLinks,
        firstReview: false, // Would check reviews API
      }, 'profile-completeness-widget');
      
    } catch (error) {
      console.error('Error initializing supplier dashboard widgets:', error);
    }
  }
  
  // Initialize widgets after page loads
  window.addEventListener('load', () => {
    setTimeout(() => {
      initSupplierDashboardWidgets();
    }, 500);
  });
  
  async function displaySubscriptionStatus() {
    const container = document.getElementById('supplier-subscription-card');
    if (!container) return;
    
    try {
      // Load subscription status from payments API
      const response = await fetch('/api/payments', {
        credentials: 'include'
      });
      
      if (response.ok) {
        const data = await response.json();
        
        // Find active subscription
        const activeSubscription = data.payments.find(
          p => p.type === 'subscription' && 
               p.status === 'succeeded' &&
               p.subscriptionDetails &&
               !p.subscriptionDetails.cancelAtPeriodEnd
        );
        
        if (activeSubscription) {
          const details = activeSubscription.subscriptionDetails;
          const endDate = new Date(details.currentPeriodEnd);
          
          container.innerHTML = `
            <p class="small"><strong>Active Plan:</strong> ${details.planName || 'Pro Plan'}</p>
            <p class="small"><strong>Renews:</strong> ${endDate.toLocaleDateString('en-GB')}</p>
            <p class="small"><strong>Status:</strong> <span class="subscription-status-active">‚úì Active</span></p>
            <a href="/supplier/subscription.html" class="btn btn-secondary subscription-action-btn">Manage Subscription</a>
          `;
        } else {
          container.innerHTML = `
            <p class="small">You're currently on the <strong>Free Plan</strong></p>
            <p class="small">Upgrade to unlock premium features and boost your visibility!</p>
            <a href="/supplier/subscription.html" class="btn btn-primary subscription-action-btn">Upgrade to Pro</a>
          `;
        }
      } else {
        // API error - show basic message
        container.innerHTML = `
          <p class="small">Manage your subscription and unlock premium features.</p>
          <a href="/supplier/subscription.html" class="btn btn-secondary subscription-action-btn">View Plans</a>
        `;
      }
      
      // Update package limit display
      await updatePackageLimitDisplay();
      
    } catch (error) {
      console.error('Error loading subscription status:', error);
      container.innerHTML = `
        <p class="small">Unable to load subscription status.</p>
        <a href="/supplier/subscription.html" class="btn btn-secondary subscription-action-btn">View Subscription</a>
      `;
    }
  }
  
  async function updatePackageLimitDisplay() {
    const limitContainer = document.getElementById('pkg-limit-note');
    if (!limitContainer) return;
    
    try {
      // Fetch package count from MongoDB API
      const packagesResponse = await fetch('/api/me/packages', { credentials: 'include' });
      if (packagesResponse.ok) {
        const packagesData = await packagesResponse.json();
        const packages = packagesData.items || [];
        
        // Hide limit notice if user has packages (implementation can be enhanced later)
        limitContainer.style.display = 'none';
      }
      
    } catch (error) {
      console.error('Error checking package limit:', error);
    }
  }
  
  
  // Display lead quality breakdown
  async function displayLeadQualityBreakdown() {
    const container = document.getElementById("lead-quality-breakdown");
    if (!container) return;

    // Load badges CSS
    if (!document.getElementById("badges-css")) {
      const link = document.createElement("link");
      link.id = "badges-css";
      link.rel = "stylesheet";
      link.href = "/assets/css/badges.css";
      document.head.appendChild(link);
    }

    try {
      // Fetch threads and supplier profile
      const [threadsResponse, supplierResponse] = await Promise.all([
        fetch("/api/threads/my"),
        fetch("/api/me/suppliers")
      ]);
      
      if (!threadsResponse.ok) {
        throw new Error("Failed to fetch threads");
      }
      const data = await threadsResponse.json();
      const threads = data.items || [];
      
      let supplierProfile = {};
      if (supplierResponse.ok) {
        const supplierData = await supplierResponse.json();
        supplierProfile = supplierData.items?.[0] || {};
      }

      if (threads.length === 0) {
        container.innerHTML = "<p class=\"small\">No enquiries yet. Lead quality statistics will appear here when customers contact you.</p>";
        return;
      }

      // Import lead quality helper (inline since we're in a script tag)
      const { calculateLeadQuality } = await import('/assets/js/utils/lead-quality-helper.js');

      // Calculate new quality scores
      const counts = { Hot: 0, High: 0, Good: 0, Low: 0 };
      let totalScore = 0;
      
      threads.forEach(thread => {
        const quality = calculateLeadQuality(thread, supplierProfile);
        counts[quality.label] = (counts[quality.label] || 0) + 1;
        totalScore += quality.score;
      });

      const total = threads.length;
      const hotPercent = Math.round((counts.Hot / total) * 100) || 0;
      const highPercent = Math.round((counts.High / total) * 100) || 0;
      const goodPercent = Math.round((counts.Good / total) * 100) || 0;
      const lowPercent = Math.round((counts.Low / total) * 100) || 0;
      const avgScore = Math.round(totalScore / total);

      container.innerHTML = `
        <div class="lead-quality-item">
          <div class="lead-quality-header">
            <span class="lead-quality-label">üî• Hot (80+)</span>
            <span class="lead-quality-value">${counts.Hot} (${hotPercent}%)</span>
          </div>
          <div class="lead-quality-bar">
            <div class="lead-quality-fill lead-quality-fill--hot" style="width: ${hotPercent}%;"></div>
          </div>
        </div>
        
        <div class="lead-quality-item">
          <div class="lead-quality-header">
            <span class="lead-quality-label">‚≠ê High (60-79)</span>
            <span class="lead-quality-value">${counts.High} (${highPercent}%)</span>
          </div>
          <div class="lead-quality-bar">
            <div class="lead-quality-fill lead-quality-fill--high" style="width: ${highPercent}%;"></div>
          </div>
        </div>
        
        <div class="lead-quality-item">
          <div class="lead-quality-header">
            <span class="lead-quality-label">‚úì Good (40-59)</span>
            <span class="lead-quality-value">${counts.Good} (${goodPercent}%)</span>
          </div>
          <div class="lead-quality-bar">
            <div class="lead-quality-fill lead-quality-fill--good" style="width: ${goodPercent}%;"></div>
          </div>
        </div>
        
        <div class="lead-quality-item">
          <div class="lead-quality-header">
            <span class="lead-quality-label">‚óØ Low (&lt;40)</span>
            <span class="lead-quality-value">${counts.Low} (${lowPercent}%)</span>
          </div>
          <div class="lead-quality-bar">
            <div class="lead-quality-fill lead-quality-fill--low" style="width: ${lowPercent}%;"></div>
          </div>
        </div>
        
        <div class="lead-quality-summary">
          <div class="lead-quality-summary-label">Average Lead Score</div>
          <div class="lead-quality-summary-value">${avgScore}/100</div>
        </div>
      `;
    } catch (error) {
      console.error("Error fetching lead quality breakdown:", error);
      container.innerHTML = "<p class=\"small text-error\">Error loading lead quality statistics.</p>";
    }
  }

  displayLeadQualityBreakdown();

  displaySubscriptionStatus();
</script>
<script>window.__EF_PAGE__='dash_supplier'</script>
<script>
// Escape HTML helper
function escapeHtml(unsafe) {
  if (typeof unsafe !== 'string') return '';
  const div = document.createElement('div');
  div.textContent = unsafe;
  return div.innerHTML;
}

// Check auth and personalize dashboard
(async function() {
  try {
    const response = await fetch('/api/auth/me', { credentials: 'include' });
    if (!response.ok) {
      // Redirect to login if not authenticated
      window.location.href = '/auth.html?redirect=' + encodeURIComponent(window.location.pathname);
      return;
    }
    const data = await response.json();
    const user = data.user;
    
    if (user) {
      // Personalize welcome message - using textContent is safe but also escape for consistency
      const welcomeHeading = document.getElementById('welcome-heading');
      if (welcomeHeading) {
        if (user.firstName) {
          welcomeHeading.textContent = `Welcome ${escapeHtml(user.firstName)}!`;
        } else if (user.name) {
          const firstName = user.name.split(' ')[0];
          welcomeHeading.textContent = `Welcome ${escapeHtml(firstName)}!`;
        } else {
          welcomeHeading.textContent = `Welcome to your Supplier Dashboard!`;
        }
      }
    }
  } catch (error) {
    console.error('Failed to load user data:', error);
  }
})();
</script>
</div></main>
<!-- BOTTOM NAVBAR - GOLD STANDARD REBUILD (Mobile Only) -->
<nav class="ef-bottom-nav" role="navigation" aria-label="Mobile bottom navigation">
  <a href="/start" class="ef-bottom-link" aria-label="Plan your event">
    <svg class="ef-bottom-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <path d="M12 20h9"/>
      <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/>
    </svg>
    <span class="ef-bottom-label">Plan</span>
  </a>
  
  <a href="/suppliers" class="ef-bottom-link" aria-label="Browse suppliers">
    <svg class="ef-bottom-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <circle cx="11" cy="11" r="8"/>
      <path d="m21 21-4.35-4.35"/>
    </svg>
    <span class="ef-bottom-label">Suppliers</span>
  </a>
  
  <a href="/blog" class="ef-bottom-link" aria-label="View guides">
    <svg class="ef-bottom-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
      <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
    </svg>
    <span class="ef-bottom-label">Guides</span>
  </a>
  
  <!-- Dashboard with notification badge (shown when logged in, replaces Alerts) -->
  <a href="#" id="ef-bottom-dashboard" class="ef-bottom-link" style="display: none;" aria-label="Go to dashboard">
    <svg class="ef-bottom-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <rect x="3" y="3" width="7" height="7" rx="1"/>
      <rect x="14" y="3" width="7" height="7" rx="1"/>
      <rect x="14" y="14" width="7" height="7" rx="1"/>
      <rect x="3" y="14" width="7" height="7" rx="1"/>
    </svg>
    <span class="ef-bottom-label">Dashboard</span>
    <span id="ef-bottom-dashboard-badge" class="ef-badge" style="display: none;">0</span>
  </a>
  
  <!-- Alerts button (shown when logged out) -->
  <a href="/blog" id="ef-bottom-alerts" class="ef-bottom-link" aria-label="View guides and alerts">
    <svg class="ef-bottom-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
      <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
    </svg>
    <span class="ef-bottom-label">Alerts</span>
  </a>
  
  <button 
    id="ef-bottom-menu" 
    class="ef-bottom-link" 
    type="button"
    aria-label="Open menu"
    aria-expanded="false"
    aria-controls="ef-mobile-menu"
  >
    <svg class="ef-bottom-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <line x1="3" y1="12" x2="21" y2="12"/>
      <line x1="3" y1="6" x2="21" y2="6"/>
      <line x1="3" y1="18" x2="21" y2="18"/>
    </svg>
    <span class="ef-bottom-label">Menu</span>
  </button>
</nav>


<footer class="footer" role="contentinfo">
  <div class="container supplier-footer-content">
    <div><strong>EventFlow</strong><br><span class="small">Event planning made simple.</span></div>
    <div class="version">Version: v17.0.0</div>
    <div class="small"><a href="/blog">Blog</a> ¬∑
      <a href="/credits">Credits</a> ¬∑ <a href="/contact">Contact</a> ¬∑ <a href="/legal">Legal Hub</a></div>
  </div>
</footer>
<script src="/assets/js/cookie-consent.js" defer></script>

<!-- JadeAssist Chat Widget -->
<script src="https://cdn.jsdelivr.net/gh/rhysllwydlewis/JadeAssist@abbf580487e0bcf7739a0857d4d940213fe2e176/packages/widget/dist/jade-widget.js" defer></script>
<script src="/assets/js/jadeassist-init.v2.js" defer></script>

<!-- Supplier Enquiry Notifications -->
<script>
(function() {
  'use strict';
  
  let ws = null;
  let reconnectAttempts = 0;
  const MAX_RECONNECT_ATTEMPTS = 5;
  const BASE_RECONNECT_DELAY = 3000;
  let originalTitle = document.title;
  let enquiryCount = 0;
  let fallbackNotificationShown = false;
  
  // Show user-facing notification when real-time is unavailable
  function showFallbackNotification() {
    if (fallbackNotificationShown) return;
    fallbackNotificationShown = true;
    
    if (typeof Toast !== 'undefined' && Toast.info) {
      Toast.info('Real-time notifications temporarily unavailable. Refresh page to see new enquiries.', {
        duration: 8000
      });
    }
  }
  
  function initWebSocket() {
    if (typeof WebSocket === 'undefined') {
      if (reconnectAttempts === 0) {
        console.info('WebSocket not supported in this browser');
        showFallbackNotification();
      }
      return;
    }
    
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const host = window.location.host;
    const wsUrl = `${protocol}//${host}`;
    
    try {
      ws = new WebSocket(wsUrl);
      
      ws.onopen = function() {
        if (reconnectAttempts > 0) {
          console.info('WebSocket reconnected successfully');
        }
        reconnectAttempts = 0;
        fallbackNotificationShown = false;
        
        const user = window.AuthState?.getUser?.();
        if (user?.uid) {
          ws.send(JSON.stringify({
            type: 'subscribe',
            channel: 'enquiries',
            userId: user.uid
          }));
        }
      };
      
      ws.onmessage = function(event) {
        try {
          const data = JSON.parse(event.data);
          
          if (data.type === 'new_enquiry') {
            handleNewEnquiry(data);
          }
        } catch (e) {
          console.error('Error parsing WebSocket message:', e);
        }
      };
      
      ws.onerror = function(error) {
        // Only log once per connection attempt
        if (reconnectAttempts === 0) {
          console.warn('WebSocket connection failed');
        }
      };
      
      ws.onclose = function() {
        attemptReconnect();
      };
    } catch (error) {
      if (reconnectAttempts === 0) {
        console.error('Failed to create WebSocket:', error);
      }
      attemptReconnect();
    }
  }
  
  function attemptReconnect() {
    if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
      reconnectAttempts++;
      
      // Exponential backoff with jitter
      const jitter = Math.random() * 1000;
      const delay = Math.min(BASE_RECONNECT_DELAY * Math.pow(2, reconnectAttempts - 1) + jitter, 30000);
      
      // Only log every 3rd attempt to reduce noise
      if (reconnectAttempts % 3 === 1) {
        console.info(`Reconnecting in ${Math.round(delay / 1000)}s... (attempt ${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS})`);
      }
      
      setTimeout(initWebSocket, delay);
    } else {
      // Max attempts reached - show user notification
      console.warn('WebSocket connection failed after maximum attempts. Real-time updates unavailable.');
      showFallbackNotification();
    }
  }
  
  function handleNewEnquiry(data) {
    enquiryCount++;
    
    updateBadge();
    
    if ('Notification' in window && Notification.permission === 'granted') {
      showDesktopNotification(data);
    } else if ('Notification' in window && Notification.permission === 'default') {
      Notification.requestPermission().then(function(permission) {
        if (permission === 'granted') {
          showDesktopNotification(data);
        }
      });
    }
    
    playNotificationSound();
    updateTabTitle();
  }
  
  function updateBadge() {
    const badge = document.getElementById('enquiry-badge') 
      || document.querySelector('[data-enquiry-badge]')
      || document.getElementById('ef-notification-badge');
      
    if (badge) {
      badge.textContent = enquiryCount > 99 ? '99+' : enquiryCount.toString();
      badge.style.display = 'inline-block';
      
      badge.classList.add('badge-pulse');
      setTimeout(() => badge.classList.remove('badge-pulse'), 300);
    }
  }
  
  function showDesktopNotification(data) {
    const notification = new Notification('New Enquiry', {
      body: data.message || 'You have a new customer enquiry',
      icon: '/favicon.svg',
      badge: '/favicon.svg',
      tag: 'enquiry-' + Date.now()
    });
    
    notification.onclick = function() {
      window.focus();
      notification.close();
    };
    
    setTimeout(() => notification.close(), 10000);
  }
  
  function playNotificationSound() {
    try {
      // Check if notification sounds are enabled
      const soundEnabled = localStorage.getItem('ef_notification_sound_enabled');
      if (soundEnabled === 'false') {
        return; // Don't play sound if disabled
      }
      
      // Get volume from settings (default 30%)
      const volumePercent = parseInt(localStorage.getItem('ef_notification_volume') || '30', 10);
      const volume = volumePercent / 100;
      
      // Create notification sound using Web Audio API
      // This approach is consistent with public/assets/js/notifications.js
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      // 800Hz sine wave (pleasant notification tone)
      oscillator.frequency.value = 800;
      oscillator.type = 'sine';
      
      // Volume control with fade out
      gainNode.gain.setValueAtTime(volume, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
      
      // Play for 0.5 seconds
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.5);
      
      // Clean up AudioContext after playback to prevent resource leaks
      oscillator.onended = function() {
        audioContext.close();
      };
    } catch (error) {
      console.error('Error playing notification sound:', error);
    }
  }
  
  function updateTabTitle() {
    document.title = `(${enquiryCount}) ${originalTitle}`;
  }
  
  window.addEventListener('focus', function() {
    enquiryCount = 0;
    document.title = originalTitle;
    updateBadge();
  });
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initWebSocket);
  } else {
    initWebSocket();
  }
  
  window.addEventListener('beforeunload', function() {
    if (ws) {
      ws.close();
    }
  });
})();
</script>
<script src="/assets/js/keyboard-shortcuts.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
<script src="/assets/js/utils/p3-features.js" defer></script>
<script src="/assets/js/supplier-dashboard-enhancements.js" defer></script>
</body></html>
