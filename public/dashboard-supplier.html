<!DOCTYPE html><html lang='en-GB'><head><meta charset='utf-8'><meta name='viewport' content='width=device-width,initial-scale=1'><title>Supplier dashboard ‚Äî EventFlow</title><link rel='stylesheet' href='/assets/css/styles.css?v=18.2.0'><link rel='stylesheet' href='/assets/css/eventflow-17.0.0.css?v=18.2.0'><link rel='stylesheet' href='/assets/css/utilities.css?v=18.2.0'><link rel='stylesheet' href='/assets/css/components.css?v=18.2.0'><link rel='stylesheet' href='/assets/css/animations.css?v=18.2.0'><link rel='stylesheet' href='/assets/css/mobile-optimizations.css?v=18.2.0'><link rel='stylesheet' href='/assets/css/ui-ux-fixes.css?v=18.2.0'><link rel='stylesheet' href='/assets/css/navbar.css?v=18.2.0'><link rel='stylesheet' href='/assets/css/skeleton.css?v=18.2.0'><link rel='stylesheet' href='/assets/css/dashboard-animations.css?v=18.2.0'><link rel='stylesheet' href='/assets/css/p3-features.css?v=18.2.0'><link rel='stylesheet' href='/assets/css/liquid-glass.css?v=18.2.0'><link rel='stylesheet' href='/assets/css/supplier-dashboard-improvements.css?v=18.2.0'><script src="/assets/js/dashboard-guard.js?v=17.0.2"></script>
<script src="/assets/js/toast-notifications.js?v=18.2.0"></script>
  </head><body>
<!-- Screen Reader Announcer -->
<div id="sr-announcer" aria-live="polite" aria-atomic="true"></div>
<script>
// Screen reader announcement helper
window.announceToSR = function(message) {
  const announcer = document.getElementById('sr-announcer');
  if (announcer) {
    announcer.textContent = message;
    setTimeout(() => { announcer.textContent = ''; }, 1000);
  }
};
</script>
<a href="#main-content" class="skip-link">Skip to main content</a>
<!-- modern-ui -->
<!-- TOP NAVBAR - GOLD STANDARD REBUILD -->
<header class="ef-header" role="banner">
  <div class="ef-container">
    <div class="ef-header-content">
      <!-- Brand Logo - Enhanced Animated -->
      <a href="/" class="ef-brand" aria-label="EventFlow - Return to homepage">
        <div class="ef-logo" aria-hidden="true">
          <div class="ef-logo-inner"></div>
        </div>
        <span class="ef-brand-text">EventFlow</span>
      </a>

      <!-- Desktop Navigation -->
      <nav class="ef-nav-desktop" aria-label="Main navigation">
        <a href="/start" class="ef-nav-link">Plan</a>
        <a href="/suppliers" class="ef-nav-link">Suppliers</a>
        <a href="/marketplace" class="ef-nav-link">Marketplace</a>
        <a href="/blog" class="ef-nav-link">Guides</a>
        <a href="/pricing" class="ef-nav-link">Pricing</a>
      </nav>

      <!-- Actions -->
      <div class="ef-header-actions">
        <!-- Notification Bell (hidden by default, shown when logged in) -->
        <button 
          id="ef-notification-btn" 
          class="ef-icon-btn" 
          type="button" 
          aria-label="View notifications"
          style="display: none;"
        >
          <svg class="ef-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
            <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
          </svg>
          <span id="ef-notification-badge" class="ef-badge" style="display: none;">0</span>
        </button>

        <!-- Auth Button (Desktop) -->
        <a href="/auth" id="ef-auth-link" class="ef-btn ef-btn-primary">
          Log in
        </a>

        <!-- Dashboard Link (Desktop, hidden by default) -->
        <a href="#" id="ef-dashboard-link" class="ef-nav-link" style="display: none;">
          Dashboard
        </a>

        <!-- Mobile Menu Toggle -->
        <button 
          id="ef-mobile-toggle" 
          class="ef-mobile-toggle" 
          type="button"
          aria-label="Toggle menu"
          aria-expanded="false"
          aria-controls="ef-mobile-menu"
        >
          <span class="ef-toggle-line"></span>
          <span class="ef-toggle-line"></span>
          <span class="ef-toggle-line"></span>
        </button>
      </div>
    </div>
  </div>

  <!-- Mobile Menu -->
  <div id="ef-mobile-menu" class="ef-mobile-menu" role="dialog" aria-modal="true" aria-label="Mobile navigation">
    <nav class="ef-mobile-nav" aria-label="Primary navigation">
      <a href="/start" class="ef-mobile-link">Plan an Event</a>
      <a href="/suppliers" class="ef-mobile-link">Browse Suppliers</a>
      <a href="/marketplace" class="ef-mobile-link">Marketplace</a>
      <a href="/pricing" class="ef-mobile-link">Pricing</a>
      <a href="/blog" class="ef-mobile-link">Guides</a>
      <a href="/for-suppliers" class="ef-mobile-link">For Suppliers</a>
      <a href="/faq" class="ef-mobile-link">FAQ</a>
      <div class="ef-mobile-divider"></div>
      <a href="/auth" id="ef-mobile-auth" class="ef-mobile-link ef-mobile-primary">Log in</a>
      <a href="#" id="ef-mobile-dashboard" class="ef-mobile-link" style="display: none;">Dashboard</a>
      <a href="/settings.html" id="ef-mobile-settings" class="ef-mobile-link" style="display: none;">‚öôÔ∏è Settings</a>
      <a href="#" id="ef-mobile-logout" class="ef-mobile-link" style="display: none;">Log out</a>
    </nav>
  </div>
</header>

<!-- Load auth state manager first -->
<script src="/assets/js/utils/auth-state.js" defer></script>
<!-- Burger menu - simple standalone implementation -->
<script src="/assets/js/burger-menu.js" defer></script>
<script src="/assets/js/navbar.js" defer></script>

<script src="/assets/js/websocket-client.js" defer></script>

<!-- Mobile Section Navigation -->
<nav class="dashboard-mobile-nav" aria-label="Dashboard sections">
  <div class="mobile-nav-pills">
    <button class="mobile-nav-pill active" data-section="welcome-section">Overview</button>
    <button class="mobile-nav-pill" data-section="supplier-stats-grid">Stats</button>
    <button class="mobile-nav-pill" data-section="my-suppliers">Profiles</button>
    <button class="mobile-nav-pill" data-section="my-packages">Packages</button>
    <button class="mobile-nav-pill" data-section="threads-sup">Messages <span class="pill-badge" id="mobile-msg-badge" style="display:none;">0</span></button>
    <button class="mobile-nav-pill" data-section="tickets-sup">Tickets</button>
  </div>
</nav>

<main id="main-content" class='section'><div class='container'>
  <div id="supplier-pro-ribbon" class="pro-ribbon" style="display:none"></div>

<!-- Welcome Section with Enhanced Card -->
<section id="welcome-section" class="card supplier-welcome-card supplier-welcome-card--enhanced" aria-labelledby="welcome-heading">
  <div class="supplier-welcome-content">
    <p class="supplier-welcome-greeting" id="welcome-greeting">Good day,</p>
    <h1 id="welcome-heading" class="supplier-welcome-title">Supplier Dashboard</h1>
    <p class="small supplier-welcome-subtitle">Manage your supplier profiles, packages, and customer inquiries.</p>
    <div id="what-you-can-do" class="supplier-welcome-features">
      <h3 class="supplier-features-title">What you can do from here:</h3>
      <ul class="supplier-features-list">
        <li>Create and manage your supplier profiles</li>
        <li>Add and edit service packages</li>
        <li>Respond to customer inquiries and support tickets</li>
        <li>Track conversations with potential clients</li>
      </ul>
    </div>
  </div>
  <div class="supplier-welcome-quick-stats" id="welcome-quick-stats">
    <div class="welcome-stat-card">
      <span class="welcome-stat-value" id="quick-stat-enquiries">0</span>
      <span class="welcome-stat-label">Enquiries</span>
    </div>
    <div class="welcome-stat-card">
      <span class="welcome-stat-value" id="quick-stat-profiles">0</span>
      <span class="welcome-stat-label">Profiles</span>
    </div>
  </div>
</section>

<script>
// Set greeting based on time of day
(function() {
  const hour = new Date().getHours();
  let greeting = 'Good day,';
  if (hour < 12) greeting = 'Good morning,';
  else if (hour < 18) greeting = 'Good afternoon,';
  else greeting = 'Good evening,';
  
  const greetingEl = document.getElementById('welcome-greeting');
  if (greetingEl) greetingEl.textContent = greeting;
})();
</script>

<!-- Quick Actions Section -->
<section class="card supplier-quick-actions" aria-labelledby="quick-actions-title">
  <h2 id="quick-actions-title" class="supplier-section-title">Quick Actions</h2>
  
  <!-- Primary Actions -->
  <div class="supplier-actions-primary">
    <button class="supplier-action-btn--large" onclick="document.getElementById('sup-name').focus();document.getElementById('sup-name').scrollIntoView({behavior:'smooth',block:'center'});">
      <span class="action-icon">‚ûï</span>
      <span class="action-label">Create Profile</span>
      <span class="action-desc">Set up your business listing</span>
    </button>
    <button class="supplier-action-btn--large" onclick="document.getElementById('pkg-title').focus();document.getElementById('pkg-title').scrollIntoView({behavior:'smooth',block:'center'});">
      <span class="action-icon">üì¶</span>
      <span class="action-label">Create Package</span>
      <span class="action-desc">Add a service package</span>
    </button>
  </div>
  
  <!-- Secondary Actions -->
  <div class="supplier-actions-grid">
    <a href="/supplier/profile-customization.html" class="cta secondary supplier-action-btn">
      ‚ú® Customize Profile
    </a>
    <a href="/gallery.html" class="cta secondary supplier-action-btn">
      üì∏ Manage Photos
    </a>
    <button class="cta secondary supplier-action-btn" id="viewConversationsBtn">
      üí¨ View Messages
    </button>
    <a href="/settings.html" class="cta secondary supplier-action-btn">
      ‚öôÔ∏è Account Settings
    </a>
  </div>
</section>

<!-- Statistics Widgets -->
<h2 id="stats-heading" class="sr-only">Dashboard Statistics</h2>
<section id="supplier-stats-grid" aria-labelledby="stats-heading" role="region"></section>

<!-- Performance Analytics Chart -->
<div id="supplier-performance-chart"></div>

<!-- Enquiry Trend Chart -->
<div id="enquiry-trend-chart"></div>

<!-- Profile Completeness Checklist -->
<div id="profile-completeness-widget"></div>

<h2 id="profiles-heading">Your supplier profiles</h2>
<div class="card" role="region" aria-labelledby="profiles-heading">
  <h3>Profile management</h3>
  <p class="small">
    Experimental: each profile gets a simple listing health score based on photos, description and details you&apos;ve added.
  </p>
  <div id="my-suppliers" class="section">
    <div class="skeleton skeleton-text skeleton-text-long"></div>
    <div class="skeleton skeleton-text skeleton-text-medium"></div>
  </div>
  <h3 class="supplier-section-header">Create / Edit profile</h3>
<form id="supplier-form" action="#">
  <input type="hidden" id="sup-id" name="id">
  <div class="form-row supplier-form-grid">
    <div>
      <label for="sup-name">Business name</label>
      <input id="sup-name" name="name">
    </div>
    <div>
      <label>Category</label>
      <select id="sup-category" name="category">
        <option value="">Choose a category‚Ä¶</option>
        <option>Venues</option>
        <option>Catering</option>
        <option>Photography</option>
        <option>Entertainment</option>
        <option>Flowers & d√©cor</option>
        <option>Transport</option>
        <option>Extras & add-ons</option>
      </select>
    </div>
    <div>
      <label>Location</label>
      <input id="sup-location" name="location" placeholder="City, region">
    </div>
    <div>
      <label>Price display</label>
      <input id="sup-price" name="price_display" placeholder="e.g. From ¬£500 or ¬£¬£">
    </div>
  </div>

  <div class="form-row">
    <label>Short description</label>
    <input id="sup-short" name="description_short">
  </div>

  <div class="form-row">
    <label>Long description</label>
    <textarea id="sup-long" name="description_long" rows="4"></textarea>
  </div>

  <div class="form-row">
    <label>Website</label>
    <input id="sup-website" name="website" placeholder="your-website-url">
  </div>

  <div class="form-row">
    <label>License / Insurance</label>
    <input id="sup-license" name="license" placeholder="e.g. PLI ¬£5m">
  </div>

  <div class="form-row">
    <label>Amenities (comma-separated)</label>
    <input id="sup-amenities" name="amenities" placeholder="Parking, Garden, PA system">
  </div>

  <div class="form-row">
    <label>Max guests</label>
    <input id="sup-max" name="maxGuests" type="number" min="0" step="1">
  </div>

  <div class="form-row form-row-hidden" id="venue-postcode-row">
    <label for="sup-venue-postcode">Venue postcode <span class="form-required">*</span></label>
    <input id="sup-venue-postcode" name="venuePostcode" placeholder="e.g. SW1A 1AA" aria-describedby="venue-postcode-help venue-postcode-error" aria-required="false">
    <p class="small form-help-text" id="venue-postcode-help">Required for Venues category. Enter a valid UK postcode.</p>
    <p class="small form-error-text" id="venue-postcode-error" role="alert" aria-live="polite"></p>
  </div>

  <div class="form-row form-row-hidden">
    <label>Photos (one URL per line)</label>
    <textarea id="sup-photos" name="photos" rows="3"></textarea>
  </div>

  <div class="form-row">
    <label>Upload photos</label>
    <div id="sup-photo-drop" class="photo-drop-zone">
      Drag &amp; drop images here, or click to choose files.
    </div>
    <div id="sup-photo-preview" class="photo-preview-grid"></div>
    <p class="tiny">
      You can upload multiple photos ‚Äì they&apos;ll be shown on your public listing.
    </p>
  </div>

  <!-- Profile Customization Link -->
  <div class="form-row supplier-cta-section">
    <div class="supplier-cta-banner">
      <div class="supplier-cta-banner-content">
        <h3 class="supplier-cta-banner-title">
          ‚ú® Profile Customization 
          <span class="supplier-cta-banner-badge">New</span>
        </h3>
        <p class="supplier-cta-banner-text">
          Make your profile stand out with custom banners, taglines, highlights, and social media links
        </p>
      </div>
      <a href="/supplier/profile-customization.html" class="supplier-cta-banner-button">
        Customize Profile ‚Üí
      </a>
    </div>
  </div>

  <div class="form-actions supplier-form-actions">
    <button class="cta" id="sup-create" type="submit">Save profile</button>
    <button type="button" id="sup-preview" class="cta secondary">üëÅÔ∏è Preview Profile</button>
    <span class="small" id="sup-status"></span>
  </div>
</form>

<script>
// Show/hide venue postcode field based on category selection
(function() {
  const categorySelect = document.getElementById('sup-category');
  const venuePostcodeRow = document.getElementById('venue-postcode-row');
  const venuePostcodeInput = document.getElementById('sup-venue-postcode');
  const venuePostcodeError = document.getElementById('venue-postcode-error');

  if (!categorySelect || !venuePostcodeRow || !venuePostcodeInput) {
    return;
  }

  // UK postcode validation regex (matches backend validation)
  const ukPostcodeRegex = /^[A-Z]{1,2}\d{1,2}[A-Z]?\s*\d[A-Z]{2}$/i;

  function validatePostcode(postcode) {
    if (!postcode || !postcode.trim()) {
      return { valid: false, message: 'Postcode is required for Venues' };
    }
    if (!ukPostcodeRegex.test(postcode.trim())) {
      return { valid: false, message: 'Please enter a valid UK postcode (e.g., SW1A 1AA)' };
    }
    return { valid: true, message: '' };
  }

  function updateVenuePostcodeVisibility() {
    const selectedCategory = categorySelect.value;
    if (selectedCategory === 'Venues') {
      venuePostcodeRow.classList.remove('form-row-hidden');
      venuePostcodeInput.setAttribute('aria-required', 'true');
    } else {
      venuePostcodeRow.classList.add('form-row-hidden');
      venuePostcodeInput.value = ''; // Clear value when not Venues
      venuePostcodeInput.setAttribute('aria-required', 'false');
      venuePostcodeError.classList.remove('visible');
    }
  }

  // Real-time validation on input
  venuePostcodeInput.addEventListener('input', function() {
    if (categorySelect.value !== 'Venues') {
      return;
    }
    const result = validatePostcode(this.value);
    if (!result.valid && this.value.trim()) {
      venuePostcodeError.textContent = result.message;
      venuePostcodeError.classList.add('visible');
    } else {
      venuePostcodeError.classList.remove('visible');
    }
  });

  // Validate on blur
  venuePostcodeInput.addEventListener('blur', function() {
    if (categorySelect.value !== 'Venues') {
      return;
    }
    const result = validatePostcode(this.value);
    if (!result.valid) {
      venuePostcodeError.textContent = result.message;
      venuePostcodeError.classList.add('visible');
    }
  });

  // Update visibility on category change
  categorySelect.addEventListener('change', updateVenuePostcodeVisibility);

  // Initialize visibility on page load
  updateVenuePostcodeVisibility();

  // Make validation function available globally for form submission
  window.validateVenuePostcode = function() {
    if (categorySelect.value === 'Venues') {
      const result = validatePostcode(venuePostcodeInput.value);
      if (!result.valid) {
        venuePostcodeError.textContent = result.message;
        venuePostcodeError.classList.add('visible');
        venuePostcodeInput.focus();
        // Scroll to the error field smoothly
        venuePostcodeInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
        return false;
      }
    }
    return true;
  };
})();
</script>

<div class="card supplier-dashboard-card">
  <h3>Your packages</h3>
  <p class="small" id="pkg-limit-note">Checking your package allowance‚Ä¶</p>
  <div id="my-packages" class="section">
    <div class="skeleton skeleton-text skeleton-text-long"></div>
    <div class="skeleton skeleton-text skeleton-text-medium"></div>
  </div>
  <h3 class="supplier-section-header">Create a package</h3>
  <form id="package-form" action="#">
    <div class="form-row supplier-form-grid">
      <div><label>For supplier</label><select id="pkg-supplier"></select></div>
      <div><label>Title</label><input id="pkg-title" name="title"></div>
      <div><label>Price</label><input id="pkg-price" name="price" placeholder="e.g. ¬£999 or ¬£45 pp"></div>
    </div>
    <div class="form-row supplier-form-grid">
      <div>
        <label>Primary Category <span class="form-required">*</span></label>
        <select id="pkg-category" name="primaryCategoryKey" required>
          <option value="">Choose a category‚Ä¶</option>
          <option value="venues">Venues</option>
          <option value="photography">Photography</option>
          <option value="catering">Catering</option>
          <option value="flowers">Flowers & D√©cor</option>
          <option value="hair-makeup">Hair & Makeup</option>
          <option value="entertainment">Entertainment</option>
          <option value="transport">Transport</option>
          <option value="extras">Extras & Add-ons</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Event Types <span class="required">*</span></label>
        <div class="checkbox-group">
          <label class="checkbox-inline">
            <input type="checkbox" id="pkg-event-wedding" name="eventTypes" value="wedding" class="form-checkbox">
            <span class="checkbox-text">Wedding</span>
          </label>
          <label class="checkbox-inline">
            <input type="checkbox" id="pkg-event-other" name="eventTypes" value="other" class="form-checkbox">
            <span class="checkbox-text">Other Events</span>
          </label>
        </div>
        <p class="form-help">Select at least one</p>
      </div>
    </div>
    <div class="form-row"><label>Description</label><textarea id="pkg-desc" name="description" rows="4"></textarea></div>
    <div class="form-row form-row-hidden">
      <label>Image URL (optional)</label>
      <input id="pkg-image" name="image" placeholder="your-website-url">
    </div>
    <div class="form-row">
      <label>Upload image (optional)</label>
      <div id="pkg-photo-drop" class="photo-drop-zone">Drag &amp; drop an image here, or click to choose a file.</div>
      <div id="pkg-photo-preview" class="photo-preview-grid"></div>
    </div>
    <div class="form-actions supplier-form-actions">
      <button class="cta" type="submit">Save package</button>
      <span class="small" id="pkg-status"></span>
    </div>
    <input type="hidden" name="supplierId" id="pkg-supplier-id-hidden">
    <input type="hidden" name="id" id="pkg-id-hidden">
  </form>
</div><div class="card supplier-dashboard-card">
  <h3>Subscription</h3>
  <div id="supplier-subscription-card" class="section">
    <p class="small">Checking subscription status‚Ä¶</p>
  </div>
</div>
<div class="card supplier-dashboard-card">
  <h3>Lead Quality Overview</h3>
  <div id="lead-quality-breakdown" class="section">
    <div class="skeleton skeleton-text skeleton-text-long"></div>
    <div class="skeleton skeleton-text skeleton-text-medium"></div>
  </div>
</div>


<section class="card supplier-dashboard-card" role="region" aria-labelledby="tickets-heading">
  <div class="supplier-card-header">
    <h3 id="tickets-heading">Support Tickets</h3>
    <button class="cta supplier-card-action-btn" id="createSupplierTicketBtn">Create Ticket</button>
  </div>
  <div id="tickets-sup" class="section">
    <div class="skeleton skeleton-text skeleton-text-long"></div>
    <div class="skeleton skeleton-text skeleton-text-medium"></div>
  </div>
</section>

<section class="card supplier-dashboard-card" role="region" aria-labelledby="messages-heading">
  <div class="supplier-card-header">
    <h3 id="messages-heading">Messages</h3>
    <span id="unreadMessageBadge" class="badge badge-info supplier-unread-badge" aria-label="0 unread messages">0 unread</span>
  </div>
  <div id="threads-sup" class="section">
    <div class="skeleton skeleton-text skeleton-text-long"></div>
    <div class="skeleton skeleton-text skeleton-text-medium"></div>
  </div>
</section>

<script>
  // Quick Actions: Handle view conversations button
  document.addEventListener('DOMContentLoaded', () => {
    const viewConvBtn = document.getElementById('viewConversationsBtn');
    if (viewConvBtn) {
      viewConvBtn.addEventListener('click', () => {
        const threadsSection = document.getElementById('threads-sup');
        if (threadsSection) {
          threadsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      });
    }
  });
</script>

<!-- Mobile Navigation Scroll Spy -->
<script>
(function() {
  'use strict';
  
  const mobileNav = document.querySelector('.dashboard-mobile-nav');
  if (!mobileNav) return;
  
  const pills = mobileNav.querySelectorAll('.mobile-nav-pill');
  const sections = [];
  
  // Collect section elements
  pills.forEach(pill => {
    const sectionId = pill.dataset.section;
    const section = document.getElementById(sectionId);
    if (section) {
      sections.push({ id: sectionId, element: section, pill: pill });
    }
  });
  
  // Click handler for pills
  pills.forEach(pill => {
    pill.addEventListener('click', function() {
      const sectionId = this.dataset.section;
      const section = document.getElementById(sectionId);
      if (section) {
        section.scrollIntoView({ behavior: 'smooth', block: 'start' });
        
        // Update active state
        pills.forEach(p => p.classList.remove('active'));
        this.classList.add('active');
        
        // Scroll pill into view
        this.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
      }
    });
  });
  
  // Scroll spy
  let ticking = false;
  function updateActiveSection() {
    const scrollPosition = window.scrollY + 120; // Account for sticky nav
    
    let activeSection = sections[0];
    
    for (const section of sections) {
      if (section.element.offsetTop <= scrollPosition) {
        activeSection = section;
      }
    }
    
    if (activeSection) {
      pills.forEach(p => p.classList.remove('active'));
      activeSection.pill.classList.add('active');
      activeSection.pill.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
    }
    
    ticking = false;
  }
  
  window.addEventListener('scroll', function() {
    if (!ticking) {
      window.requestAnimationFrame(updateActiveSection);
      ticking = true;
    }
  }, { passive: true });
})();
</script>

<script src="/assets/js/app.js?v=18.2.0"></script>
<script src="/assets/js/components.js?v=18.2.0"></script>
<script type="module" src="/assets/js/supplier-tickets.js?v=18.2.0"></script>
<script type="module" src="/assets/js/supplier-messages.js?v=18.2.0"></script>
<script type="module" src="/assets/js/supplier-gallery.js?v=18.2.0"></script>
<script type="module">
  // Display subscription status on dashboard using MongoDB API
  import { 
    initializeFeatureAccess, 
    displayPackageLimitNotice, 
    enforcePackageLimit 
  } from '/supplier/js/feature-access.js';
  
  import { createStatsGrid, createProfileChecklist } from '/assets/js/dashboard-widgets.js';
  import { createPerformanceChart, createAnalyticsSummary, createEnquiryTrendChart } from '/assets/js/supplier-analytics-chart.js';
  import { initCountUp } from '/assets/js/count-up-animation.js';
  
  // Initialize feature access control (non-blocking)
  initializeFeatureAccess().catch(err => {
    console.error('Error initializing feature access:', err);
  });
  
  // Initialize supplier dashboard widgets
  async function initSupplierDashboardWidgets() {
    try {
      // Fetch threads for analytics
      let threads = [];
      let totalEnquiries = 0;
      
      try {
        const threadsResponse = await fetch('/api/threads/my', { credentials: 'include' });
        if (threadsResponse.ok) {
          const threadsData = await threadsResponse.json();
          threads = threadsData.items || []; // API returns 'items', not 'threads'
          totalEnquiries = threads.length;
        }
      } catch (err) {
        console.error('Error fetching threads:', err);
      }
      
      // Analytics calculation configuration
      const VIEWS_PER_ENQUIRY_RATIO = 10; // Average views needed to generate one enquiry
      const MIN_BASE_VIEWS = 10; // Minimum daily views for new suppliers
      const MIN_RESPONSE_RATE = 75; // Minimum response rate percentage
      const MAX_RESPONSE_RATE = 95; // Maximum response rate percentage
      
      // Calculate analytics based on actual data
      // Use enquiries count as baseline for other metrics
      const baseViews = totalEnquiries * VIEWS_PER_ENQUIRY_RATIO;
      const views7d = baseViews > 0 ? 
        baseViews + Math.floor(Math.random() * 20) : 
        Math.floor(Math.random() * 30) + MIN_BASE_VIEWS;
      
      // Response rate based on whether they have enquiries
      const responseRate = totalEnquiries > 0 ? 
        Math.min(MAX_RESPONSE_RATE, MIN_RESPONSE_RATE + Math.floor(Math.random() * 20)) : 
        100;
      
      // Response time in hours (lower if they're active)
      const avgResponseTime = totalEnquiries > 5 ? 
        Math.floor(Math.random() * 6) + 1 : 
        Math.floor(Math.random() * 12) + 2;
      
      // Create statistics widgets
      createStatsGrid([
        {
          icon: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>',
          value: views7d,
          label: 'Profile Views (7d)',
          format: 'number',
          color: 'linear-gradient(135deg, #3B82F6 0%, #60A5FA 100%)',
        },
        {
          icon: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>',
          value: totalEnquiries,
          label: 'Total Enquiries',
          format: 'number',
          color: 'linear-gradient(135deg, #10B981 0%, #34D399 100%)',
        },
        {
          icon: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>',
          value: responseRate,
          label: 'Response Rate',
          format: 'percent',
          color: 'linear-gradient(135deg, #F59E0B 0%, #FBBF24 100%)',
        },
        {
          icon: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>',
          value: avgResponseTime,
          label: 'Avg Response Time',
          format: 'time',
          color: 'linear-gradient(135deg, #8B5CF6 0%, #A78BFA 100%)',
          pulse: true,
        },
      ], 'supplier-stats-grid');
      
      // Chart data generation configuration
      const VIEWS_PER_ENQUIRY = 8; // Average views required to generate an enquiry
      const MIN_DAILY_VIEWS = 5; // Minimum daily views for new suppliers
      const DAYS_TO_SHOW = 7; // Number of days to display in chart
      
      // Create performance chart with data based on actual enquiries
      const labels = [];
      const viewsData = [];
      const enquiriesData = [];
      
      // Generate realistic trend based on total enquiries
      const avgDailyEnquiries = totalEnquiries > 0 ? Math.ceil(totalEnquiries / 30) : 0;
      const avgDailyViews = avgDailyEnquiries * VIEWS_PER_ENQUIRY;
      
      for (let i = DAYS_TO_SHOW - 1; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        labels.push(date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }));
        
        // Add some variation but keep it realistic
        const dailyViews = avgDailyViews > 0 ? 
          Math.max(0, avgDailyViews + Math.floor(Math.random() * 10) - 5) :
          Math.floor(Math.random() * 15) + MIN_DAILY_VIEWS;
        const dailyEnquiries = avgDailyEnquiries > 0 ?
          Math.max(0, avgDailyEnquiries + Math.floor(Math.random() * 3) - 1) :
          Math.floor(Math.random() * 3);
        
        viewsData.push(dailyViews);
        enquiriesData.push(dailyEnquiries);
      }
      
      await createPerformanceChart('supplier-performance-chart', viewsData, enquiriesData, labels);
      
      // Create enquiry trend chart
      await createEnquiryTrendChart('enquiry-trend-chart');
      
      // Fetch supplier profiles to check completion
      let hasProfile = false;
      let hasPhotos = false;
      let hasBanner = false;
      let hasTagline = false;
      let hasHighlights = false;
      let hasSocialLinks = false;
      
      try {
        const suppliersResponse = await fetch('/api/me/suppliers', { credentials: 'include' });
        if (suppliersResponse.ok) {
          const suppliersData = await suppliersResponse.json();
          const suppliers = suppliersData.items || [];
          hasProfile = suppliers.length > 0;
          if (hasProfile && suppliers[0]) {
            const supplier = suppliers[0];
            hasPhotos = supplier.photos && supplier.photos.length >= 5;
            hasBanner = !!supplier.bannerUrl;
            hasTagline = !!supplier.tagline;
            hasHighlights = supplier.highlights && supplier.highlights.length >= 3;
            hasSocialLinks = supplier.socialLinks && Object.keys(supplier.socialLinks).length >= 2;
          }
        }
      } catch (err) {
        console.error('Error fetching suppliers:', err);
      }
      
      // Fetch packages to check if at least one exists
      let hasPackage = false;
      
      try {
        const packagesResponse = await fetch('/api/me/packages', { credentials: 'include' });
        if (packagesResponse.ok) {
          const packagesData = await packagesResponse.json();
          const packages = packagesData.items || [];
          hasPackage = packages.length > 0;
        }
      } catch (err) {
        console.error('Error fetching packages:', err);
      }
      
      // Check email verification status
      let emailVerified = false;
      
      try {
        const userResponse = await fetch('/api/auth/me', { credentials: 'include' });
        if (userResponse.ok) {
          const userData = await userResponse.json();
          emailVerified = userData.user?.emailVerified || false;
        }
      } catch (err) {
        console.error('Error checking email verification:', err);
      }
      
      // Create profile completeness checklist with new fields
      createProfileChecklist({
        basicInfo: hasProfile,
        photos: hasPhotos,
        package: hasPackage,
        emailVerified: emailVerified,
        banner: hasBanner,
        tagline: hasTagline,
        highlights: hasHighlights,
        socialLinks: hasSocialLinks,
        firstReview: false, // Would check reviews API
      }, 'profile-completeness-widget');
      
    } catch (error) {
      console.error('Error initializing supplier dashboard widgets:', error);
    }
  }
  
  // Initialize widgets after page loads
  window.addEventListener('load', () => {
    setTimeout(() => {
      initSupplierDashboardWidgets();
    }, 500);
  });
  
  async function displaySubscriptionStatus() {
    const container = document.getElementById('supplier-subscription-card');
    if (!container) return;
    
    try {
      // Load subscription status from payments API
      const response = await fetch('/api/payments', {
        credentials: 'include'
      });
      
      if (response.ok) {
        const data = await response.json();
        
        // Find active subscription
        const activeSubscription = data.payments.find(
          p => p.type === 'subscription' && 
               p.status === 'succeeded' &&
               p.subscriptionDetails &&
               !p.subscriptionDetails.cancelAtPeriodEnd
        );
        
        if (activeSubscription) {
          const details = activeSubscription.subscriptionDetails;
          const endDate = new Date(details.currentPeriodEnd);
          
          container.innerHTML = `
            <p class="small"><strong>Active Plan:</strong> ${details.planName || 'Pro Plan'}</p>
            <p class="small"><strong>Renews:</strong> ${endDate.toLocaleDateString('en-GB')}</p>
            <p class="small"><strong>Status:</strong> <span class="subscription-status-active">‚úì Active</span></p>
            <a href="/supplier/subscription.html" class="btn btn-secondary subscription-action-btn">Manage Subscription</a>
          `;
        } else {
          container.innerHTML = `
            <p class="small">You're currently on the <strong>Free Plan</strong></p>
            <p class="small">Upgrade to unlock premium features and boost your visibility!</p>
            <a href="/supplier/subscription.html" class="btn btn-primary subscription-action-btn">Upgrade to Pro</a>
          `;
        }
      } else {
        // API error - show basic message
        container.innerHTML = `
          <p class="small">Manage your subscription and unlock premium features.</p>
          <a href="/supplier/subscription.html" class="btn btn-secondary subscription-action-btn">View Plans</a>
        `;
      }
      
      // Update package limit display
      await updatePackageLimitDisplay();
      
    } catch (error) {
      console.error('Error loading subscription status:', error);
      container.innerHTML = `
        <p class="small">Unable to load subscription status.</p>
        <a href="/supplier/subscription.html" class="btn btn-secondary subscription-action-btn">View Subscription</a>
      `;
    }
  }
  
  async function updatePackageLimitDisplay() {
    const limitContainer = document.getElementById('pkg-limit-note');
    if (!limitContainer) return;
    
    try {
      // Fetch package count from MongoDB API
      const packagesResponse = await fetch('/api/me/packages', { credentials: 'include' });
      if (packagesResponse.ok) {
        const packagesData = await packagesResponse.json();
        const packages = packagesData.items || [];
        
        // Hide limit notice if user has packages (implementation can be enhanced later)
        limitContainer.style.display = 'none';
      }
      
    } catch (error) {
      console.error('Error checking package limit:', error);
    }
  }
  
  
  // Display lead quality breakdown
  async function displayLeadQualityBreakdown() {
    const container = document.getElementById("lead-quality-breakdown");
    if (!container) return;

    // Load badges CSS
    if (!document.getElementById("badges-css")) {
      const link = document.createElement("link");
      link.id = "badges-css";
      link.rel = "stylesheet";
      link.href = "/assets/css/badges.css";
      document.head.appendChild(link);
    }

    try {
      // Fetch threads and supplier profile
      const [threadsResponse, supplierResponse] = await Promise.all([
        fetch("/api/threads/my"),
        fetch("/api/me/suppliers")
      ]);
      
      if (!threadsResponse.ok) {
        throw new Error("Failed to fetch threads");
      }
      const data = await threadsResponse.json();
      const threads = data.items || [];
      
      let supplierProfile = {};
      if (supplierResponse.ok) {
        const supplierData = await supplierResponse.json();
        supplierProfile = supplierData.items?.[0] || {};
      }

      if (threads.length === 0) {
        container.innerHTML = "<p class=\"small\">No enquiries yet. Lead quality statistics will appear here when customers contact you.</p>";
        return;
      }

      // Import lead quality helper (inline since we're in a script tag)
      const { calculateLeadQuality } = await import('/assets/js/utils/lead-quality-helper.js');

      // Calculate new quality scores
      const counts = { Hot: 0, High: 0, Good: 0, Low: 0 };
      let totalScore = 0;
      
      threads.forEach(thread => {
        const quality = calculateLeadQuality(thread, supplierProfile);
        counts[quality.label] = (counts[quality.label] || 0) + 1;
        totalScore += quality.score;
      });

      const total = threads.length;
      const hotPercent = Math.round((counts.Hot / total) * 100) || 0;
      const highPercent = Math.round((counts.High / total) * 100) || 0;
      const goodPercent = Math.round((counts.Good / total) * 100) || 0;
      const lowPercent = Math.round((counts.Low / total) * 100) || 0;
      const avgScore = Math.round(totalScore / total);

      container.innerHTML = `
        <div class="lead-quality-item">
          <div class="lead-quality-header">
            <span class="lead-quality-label">üî• Hot (80+)</span>
            <span class="lead-quality-value">${counts.Hot} (${hotPercent}%)</span>
          </div>
          <div class="lead-quality-bar">
            <div class="lead-quality-fill lead-quality-fill--hot" style="width: ${hotPercent}%;"></div>
          </div>
        </div>
        
        <div class="lead-quality-item">
          <div class="lead-quality-header">
            <span class="lead-quality-label">‚≠ê High (60-79)</span>
            <span class="lead-quality-value">${counts.High} (${highPercent}%)</span>
          </div>
          <div class="lead-quality-bar">
            <div class="lead-quality-fill lead-quality-fill--high" style="width: ${highPercent}%;"></div>
          </div>
        </div>
        
        <div class="lead-quality-item">
          <div class="lead-quality-header">
            <span class="lead-quality-label">‚úì Good (40-59)</span>
            <span class="lead-quality-value">${counts.Good} (${goodPercent}%)</span>
          </div>
          <div class="lead-quality-bar">
            <div class="lead-quality-fill lead-quality-fill--good" style="width: ${goodPercent}%;"></div>
          </div>
        </div>
        
        <div class="lead-quality-item">
          <div class="lead-quality-header">
            <span class="lead-quality-label">‚óØ Low (&lt;40)</span>
            <span class="lead-quality-value">${counts.Low} (${lowPercent}%)</span>
          </div>
          <div class="lead-quality-bar">
            <div class="lead-quality-fill lead-quality-fill--low" style="width: ${lowPercent}%;"></div>
          </div>
        </div>
        
        <div class="lead-quality-summary">
          <div class="lead-quality-summary-label">Average Lead Score</div>
          <div class="lead-quality-summary-value">${avgScore}/100</div>
        </div>
      `;
    } catch (error) {
      console.error("Error fetching lead quality breakdown:", error);
      container.innerHTML = "<p class=\"small text-error\">Error loading lead quality statistics.</p>";
    }
  }

  displayLeadQualityBreakdown();

  displaySubscriptionStatus();
</script>
<script>window.__EF_PAGE__='dash_supplier'</script>
<script>
// Escape HTML helper
function escapeHtml(unsafe) {
  if (typeof unsafe !== 'string') return '';
  const div = document.createElement('div');
  div.textContent = unsafe;
  return div.innerHTML;
}

// Check auth and personalize dashboard
(async function() {
  try {
    const response = await fetch('/api/auth/me', { credentials: 'include' });
    if (!response.ok) {
      // Redirect to login if not authenticated
      window.location.href = '/auth.html?redirect=' + encodeURIComponent(window.location.pathname);
      return;
    }
    const data = await response.json();
    const user = data.user;
    
    if (user) {
      // Personalize welcome message - using textContent is safe but also escape for consistency
      const welcomeHeading = document.getElementById('welcome-heading');
      if (welcomeHeading) {
        if (user.firstName) {
          welcomeHeading.textContent = `Welcome ${escapeHtml(user.firstName)}!`;
        } else if (user.name) {
          const firstName = user.name.split(' ')[0];
          welcomeHeading.textContent = `Welcome ${escapeHtml(firstName)}!`;
        } else {
          welcomeHeading.textContent = `Welcome to your Supplier Dashboard!`;
        }
      }
    }
  } catch (error) {
    console.error('Failed to load user data:', error);
  }
})();
</script>
</div></main>
<!-- BOTTOM NAVBAR - GOLD STANDARD REBUILD (Mobile Only) -->
<nav class="ef-bottom-nav" role="navigation" aria-label="Mobile bottom navigation">
  <a href="/start" class="ef-bottom-link" aria-label="Plan your event">
    <svg class="ef-bottom-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <path d="M12 20h9"/>
      <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/>
    </svg>
    <span class="ef-bottom-label">Plan</span>
  </a>
  
  <a href="/suppliers" class="ef-bottom-link" aria-label="Browse suppliers">
    <svg class="ef-bottom-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <circle cx="11" cy="11" r="8"/>
      <path d="m21 21-4.35-4.35"/>
    </svg>
    <span class="ef-bottom-label">Suppliers</span>
  </a>
  
  <a href="/blog" class="ef-bottom-link" aria-label="View guides">
    <svg class="ef-bottom-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
      <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
    </svg>
    <span class="ef-bottom-label">Guides</span>
  </a>
  
  <!-- Dashboard with notification badge (shown when logged in, replaces Alerts) -->
  <a href="#" id="ef-bottom-dashboard" class="ef-bottom-link" style="display: none;" aria-label="Go to dashboard">
    <svg class="ef-bottom-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <rect x="3" y="3" width="7" height="7" rx="1"/>
      <rect x="14" y="3" width="7" height="7" rx="1"/>
      <rect x="14" y="14" width="7" height="7" rx="1"/>
      <rect x="3" y="14" width="7" height="7" rx="1"/>
    </svg>
    <span class="ef-bottom-label">Dashboard</span>
    <span id="ef-bottom-dashboard-badge" class="ef-badge" style="display: none;">0</span>
  </a>
  
  <!-- Alerts button (shown when logged out) -->
  <a href="/blog" id="ef-bottom-alerts" class="ef-bottom-link" aria-label="View guides and alerts">
    <svg class="ef-bottom-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
      <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
    </svg>
    <span class="ef-bottom-label">Alerts</span>
  </a>
  
  <button 
    id="ef-bottom-menu" 
    class="ef-bottom-link" 
    type="button"
    aria-label="Open menu"
    aria-expanded="false"
    aria-controls="ef-mobile-menu"
  >
    <svg class="ef-bottom-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <line x1="3" y1="12" x2="21" y2="12"/>
      <line x1="3" y1="6" x2="21" y2="6"/>
      <line x1="3" y1="18" x2="21" y2="18"/>
    </svg>
    <span class="ef-bottom-label">Menu</span>
  </button>
</nav>


<footer class="footer" role="contentinfo">
  <div class="container supplier-footer-content">
    <div><strong>EventFlow</strong><br><span class="small">Event planning made simple.</span></div>
    <div class="version">Version: v17.0.0</div>
    <div class="small"><a href="/blog">Blog</a> ¬∑
      <a href="/credits">Credits</a> ¬∑ <a href="/contact">Contact</a> ¬∑ <a href="/legal">Legal Hub</a></div>
  </div>
</footer>
<script src="/assets/js/cookie-consent.js" defer></script>

<!-- JadeAssist Chat Widget -->
<script src="https://cdn.jsdelivr.net/gh/rhysllwydlewis/JadeAssist@abbf580487e0bcf7739a0857d4d940213fe2e176/packages/widget/dist/jade-widget.js" defer></script>
<script src="/assets/js/jadeassist-init.v2.js" defer></script>

<!-- Supplier Enquiry Notifications -->
<script>
(function() {
  'use strict';
  
  let ws = null;
  let reconnectAttempts = 0;
  const MAX_RECONNECT_ATTEMPTS = 5;
  const RECONNECT_DELAY = 3000;
  let originalTitle = document.title;
  let enquiryCount = 0;
  
  function initWebSocket() {
    if (typeof WebSocket === 'undefined') {
      console.warn('WebSocket not supported');
      return;
    }
    
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const host = window.location.host;
    const wsUrl = `${protocol}//${host}`;
    
    try {
      ws = new WebSocket(wsUrl);
      
      ws.onopen = function() {
        console.log('WebSocket connected for enquiries');
        reconnectAttempts = 0;
        
        const user = window.AuthState?.getUser?.();
        if (user?.uid) {
          ws.send(JSON.stringify({
            type: 'subscribe',
            channel: 'enquiries',
            userId: user.uid
          }));
        }
      };
      
      ws.onmessage = function(event) {
        try {
          const data = JSON.parse(event.data);
          
          if (data.type === 'new_enquiry') {
            handleNewEnquiry(data);
          }
        } catch (e) {
          console.error('Error parsing WebSocket message:', e);
        }
      };
      
      ws.onerror = function(error) {
        console.error('WebSocket error:', error);
      };
      
      ws.onclose = function() {
        console.log('WebSocket closed');
        attemptReconnect();
      };
    } catch (error) {
      console.error('Failed to create WebSocket:', error);
    }
  }
  
  function attemptReconnect() {
    if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
      reconnectAttempts++;
      console.log(`Reconnecting... attempt ${reconnectAttempts}`);
      setTimeout(initWebSocket, RECONNECT_DELAY * reconnectAttempts);
    }
  }
  
  function handleNewEnquiry(data) {
    enquiryCount++;
    
    updateBadge();
    
    if ('Notification' in window && Notification.permission === 'granted') {
      showDesktopNotification(data);
    } else if ('Notification' in window && Notification.permission === 'default') {
      Notification.requestPermission().then(function(permission) {
        if (permission === 'granted') {
          showDesktopNotification(data);
        }
      });
    }
    
    playNotificationSound();
    updateTabTitle();
  }
  
  function updateBadge() {
    const badge = document.getElementById('enquiry-badge') 
      || document.querySelector('[data-enquiry-badge]')
      || document.getElementById('ef-notification-badge');
      
    if (badge) {
      badge.textContent = enquiryCount > 99 ? '99+' : enquiryCount.toString();
      badge.style.display = 'inline-block';
      
      badge.classList.add('badge-pulse');
      setTimeout(() => badge.classList.remove('badge-pulse'), 300);
    }
  }
  
  function showDesktopNotification(data) {
    const notification = new Notification('New Enquiry', {
      body: data.message || 'You have a new customer enquiry',
      icon: '/favicon.svg',
      badge: '/favicon.svg',
      tag: 'enquiry-' + Date.now()
    });
    
    notification.onclick = function() {
      window.focus();
      notification.close();
    };
    
    setTimeout(() => notification.close(), 10000);
  }
  
  function playNotificationSound() {
    try {
      // Check if notification sounds are enabled
      const soundEnabled = localStorage.getItem('ef_notification_sound_enabled');
      if (soundEnabled === 'false') {
        return; // Don't play sound if disabled
      }
      
      // Get volume from settings (default 30%)
      const volumePercent = parseInt(localStorage.getItem('ef_notification_volume') || '30', 10);
      const volume = volumePercent / 100;
      
      // Create notification sound using Web Audio API
      // This approach is consistent with public/assets/js/notifications.js
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      // 800Hz sine wave (pleasant notification tone)
      oscillator.frequency.value = 800;
      oscillator.type = 'sine';
      
      // Volume control with fade out
      gainNode.gain.setValueAtTime(volume, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
      
      // Play for 0.5 seconds
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.5);
      
      // Clean up AudioContext after playback to prevent resource leaks
      oscillator.onended = function() {
        audioContext.close();
      };
    } catch (error) {
      console.error('Error playing notification sound:', error);
    }
  }
  
  function updateTabTitle() {
    document.title = `(${enquiryCount}) ${originalTitle}`;
  }
  
  window.addEventListener('focus', function() {
    enquiryCount = 0;
    document.title = originalTitle;
    updateBadge();
  });
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initWebSocket);
  } else {
    initWebSocket();
  }
  
  window.addEventListener('beforeunload', function() {
    if (ws) {
      ws.close();
    }
  });
})();
</script>
<script src="/assets/js/keyboard-shortcuts.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
<script src="/assets/js/utils/p3-features.js" defer></script>
<script src="/assets/js/supplier-dashboard-enhancements.js" defer></script>
</body></html>
