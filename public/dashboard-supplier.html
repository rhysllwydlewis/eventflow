<!DOCTYPE html><html lang='en-GB'><head><meta charset='utf-8'><meta name='viewport' content='width=device-width,initial-scale=1'><title>Supplier dashboard â€” EventFlow</title><link rel='stylesheet' href='/assets/css/styles.css?v=17.0.1'><link rel='stylesheet' href='/assets/css/components.css?v=17.0.1'><link rel='stylesheet' href='/assets/css/ui-ux-fixes.css?v=17.0.1'></head><body>
<a href="#main-content" class="skip-link">Skip to main content</a>
<!-- modern-ui -->
<header class="header" role="banner">
  <div class="container header-inner">
    <a class="brand" href="/" aria-label="EventFlow home">
      <span class="logo" aria-hidden="true"></span>
      <span class="brand-text">EventFlow</span>
    </a>
    <div class="header-actions">
      <nav class="nav nav-inline" aria-label="Quick navigation">
        <a href="/start.html" class="nav-link nav-main">Plan an Event</a>
        <a href="/suppliers.html" class="nav-link nav-main">Suppliers</a>
        <a href="/pricing.html" class="nav-link nav-main">Pricing</a>
        <a href="/blog.html" class="nav-link nav-main">Blog</a>
        <a href="/auth.html" class="nav-link nav-main nav-main-login">Log in</a>
      </nav>
      <button id="notification-bell" class="icon-button" type="button" aria-label="Notifications" style="display:none;">
        <span class="notification-icon">ðŸ””</span>
        <span class="notification-badge" style="display:none;">0</span>
      </button>
      <button id="burger" class="nav-toggle" type="button" aria-label="Toggle navigation" aria-expanded="false">
        <span class="nav-toggle-bar"></span>
        <span class="nav-toggle-bar"></span>
        <span class="nav-toggle-bar"></span>
      </button>
    </div>
  </div>
  <nav class="nav nav-menu" aria-label="Primary navigation">
    <a href="/start.html">Plan an Event</a>
    <a href="/suppliers.html">Suppliers</a>
    <a href="/plan.html">My Plan</a>
    <a href="/blog.html">Blog</a>
    <a href="/for-suppliers.html">For Suppliers</a>
    <a href="/faq.html">FAQ</a>
    <a href="/settings.html">Settings</a>
    <a href="/auth.html" id="nav-auth">Log in</a>
    <a href="#" id="nav-dashboard" style="display:none">Dashboard</a>
    <a href="#" id="nav-signout" style="display:none">Sign out</a>
  </nav>
</header>
<script src="/assets/js/auth-nav.js" defer></script>
<script src="/assets/js/websocket-client.js" defer></script>
<main id="main-content" class='section'><div class='container'>
  <div id="supplier-pro-ribbon" class="pro-ribbon" style="display:none"></div>

<!-- Welcome Section -->
<div id="welcome-section" class="card" style="background:linear-gradient(135deg, #0B8073 0%, #0a6b5f 100%);color:white;margin-bottom:1rem;">
  <h1 id="welcome-heading" style="margin:0 0 0.5rem 0;color:white;">Supplier Dashboard</h1>
  <p class="small" style="color:rgba(255,255,255,0.9);margin:0 0 1rem 0;">Manage your supplier profiles, packages, and customer inquiries.</p>
  <div id="what-you-can-do" style="margin-top:1rem;padding-top:1rem;border-top:1px solid rgba(255,255,255,0.2);">
    <h3 style="margin:0 0 0.5rem 0;color:white;font-size:1.1rem;">What you can do from here:</h3>
    <ul style="margin:0;padding-left:1.25rem;color:rgba(255,255,255,0.95);font-size:0.95rem;">
      <li style="margin-bottom:0.25rem;">Create and manage your supplier profiles</li>
      <li style="margin-bottom:0.25rem;">Add and edit service packages</li>
      <li style="margin-bottom:0.25rem;">Respond to customer inquiries and support tickets</li>
      <li style="margin-bottom:0.25rem;">Track conversations with potential clients</li>
    </ul>
  </div>
</div>

<!-- Quick Actions Section -->
<div class="card" style="margin-bottom:1.5rem;">
  <h2 style="margin:0 0 1rem 0;font-size:1.25rem;color:#0B1220;">Quick Actions</h2>
  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:0.75rem;">
    <button class="cta secondary" onclick="document.getElementById('sup-name').focus();document.getElementById('sup-name').scrollIntoView({behavior:'smooth',block:'center'});" style="width:100%;text-align:center;">
      âž• Create Profile
    </button>
    <button class="cta secondary" onclick="document.getElementById('pkg-title').focus();document.getElementById('pkg-title').scrollIntoView({behavior:'smooth',block:'center'});" style="width:100%;text-align:center;">
      ðŸ“¦ Create Package
    </button>
    <a href="/supplier/photos.html" class="cta secondary" style="width:100%;text-align:center;text-decoration:none;display:inline-block;">
      ðŸ“¸ Manage Photos
    </a>
    <button class="cta secondary" id="viewConversationsBtn" style="width:100%;text-align:center;">
      ðŸ’¬ View Messages
    </button>
  </div>
</div>

<h2>Your supplier profiles</h2>
<div class="card">
  <h3>Profile management</h3>
  <p class="small">
    Experimental: each profile gets a simple listing health score based on photos, description and details you&apos;ve added.
  </p>
  <div id="my-suppliers" class="section"><p class="small">Loadingâ€¦</p></div>
  <h3 style="margin-top:16px">Create / Edit profile</h3>
<form id="supplier-form" action="#">
  <input type="hidden" id="sup-id" name="id">
  <div class="form-row" style="grid-template-columns:repeat(auto-fit,minmax(200px,1fr))">
    <div>
      <label>Business name</label>
      <input id="sup-name" name="name">
    </div>
    <div>
      <label>Category</label>
      <select id="sup-category" name="category">
        <option value="">Choose a categoryâ€¦</option>
        <option>Venues</option>
        <option>Catering</option>
        <option>Photography</option>
        <option>Entertainment</option>
        <option>Flowers & dÃ©cor</option>
        <option>Transport</option>
        <option>Extras & add-ons</option>
      </select>
    </div>
    <div>
      <label>Location</label>
      <input id="sup-location" name="location" placeholder="City, region">
    </div>
    <div>
      <label>Price display</label>
      <input id="sup-price" name="price_display" placeholder="e.g. From Â£500 or Â£Â£">
    </div>
  </div>

  <div class="form-row">
    <label>Short description</label>
    <input id="sup-short" name="description_short">
  </div>

  <div class="form-row">
    <label>Long description</label>
    <textarea id="sup-long" name="description_long" rows="4"></textarea>
  </div>

  <div class="form-row">
    <label>Website</label>
    <input id="sup-website" name="website" placeholder="your-website-url">
  </div>

  <div class="form-row">
    <label>License / Insurance</label>
    <input id="sup-license" name="license" placeholder="e.g. PLI Â£5m">
  </div>

  <div class="form-row">
    <label>Amenities (comma-separated)</label>
    <input id="sup-amenities" name="amenities" placeholder="Parking, Garden, PA system">
  </div>

  <div class="form-row">
    <label>Max guests</label>
    <input id="sup-max" name="maxGuests" type="number" min="0" step="1">
  </div>

  <div class="form-row" style="display:none">
    <label>Photos (one URL per line)</label>
    <textarea id="sup-photos" name="photos" rows="3"></textarea>
  </div>

  <div class="form-row">
    <label>Upload photos</label>
    <div id="sup-photo-drop" class="photo-drop-zone">
      Drag &amp; drop images here, or click to choose files.
    </div>
    <div id="sup-photo-preview" class="photo-preview-grid"></div>
    <p class="tiny">
      You can upload multiple photos â€“ they&apos;ll be shown on your public listing.
    </p>
  </div>

  <div class="form-actions" style="margin-top:10px">
    <button class="cta" id="sup-create" type="submit">Save profile</button>
    <span class="small" id="sup-status"></span>
  </div>
</form>


<div class="card" style="margin-top:16px">
  <h3>Your packages</h3>
  <p class="small" id="pkg-limit-note">Checking your package allowanceâ€¦</p>
  <div id="my-packages" class="section"><p class="small">Loadingâ€¦</p></div>
  <h3 style="margin-top:16px">Create a package</h3>
  <form id="package-form" action="#">
    <div class="form-row" style="grid-template-columns:repeat(auto-fit,minmax(200px,1fr))">
      <div><label>For supplier</label><select id="pkg-supplier"></select></div>
      <div><label>Title</label><input id="pkg-title" name="title"></div>
      <div><label>Price</label><input id="pkg-price" name="price" placeholder="e.g. Â£999 or Â£45 pp"></div>
    </div>
    <div class="form-row" style="grid-template-columns:repeat(auto-fit,minmax(200px,1fr))">
      <div>
        <label>Primary Category <span style="color:red">*</span></label>
        <select id="pkg-category" name="primaryCategoryKey" required>
          <option value="">Choose a categoryâ€¦</option>
          <option value="venues">Venues</option>
          <option value="photography">Photography</option>
          <option value="catering">Catering</option>
          <option value="flowers">Flowers & DÃ©cor</option>
          <option value="hair-makeup">Hair & Makeup</option>
          <option value="entertainment">Entertainment</option>
          <option value="transport">Transport</option>
          <option value="extras">Extras & Add-ons</option>
        </select>
      </div>
      <div>
        <label>Event Types <span style="color:red">*</span></label>
        <div style="display:flex;gap:1rem;align-items:center;padding-top:0.5rem;">
          <label style="display:flex;align-items:center;gap:0.5rem;cursor:pointer;">
            <input type="checkbox" id="pkg-event-wedding" name="eventTypes" value="wedding">
            <span>Wedding</span>
          </label>
          <label style="display:flex;align-items:center;gap:0.5rem;cursor:pointer;">
            <input type="checkbox" id="pkg-event-other" name="eventTypes" value="other">
            <span>Other Events</span>
          </label>
        </div>
        <p class="small" style="color:#667085;margin-top:0.25rem;">Select at least one</p>
      </div>
    </div>
    <div class="form-row"><label>Description</label><textarea id="pkg-desc" name="description" rows="4"></textarea></div>
    <div class="form-row" style="display:none">
      <label>Image URL (optional)</label>
      <input id="pkg-image" name="image" placeholder="your-website-url">
    </div>
    <div class="form-row">
      <label>Upload image (optional)</label>
      <div id="pkg-photo-drop" class="photo-drop-zone">Drag &amp; drop an image here, or click to choose a file.</div>
      <div id="pkg-photo-preview" class="photo-preview-grid"></div>
    </div>
    <div class="form-actions" style="margin-top:10px">
      <button class="cta" type="submit">Save package</button>
      <span class="small" id="pkg-status"></span>
    </div>
    <input type="hidden" name="supplierId" id="pkg-supplier-id-hidden">
    <input type="hidden" name="id" id="pkg-id-hidden">
  </form>
</div><div class="card" style="margin-top:16px;">
  <h3>Subscription</h3>
  <div id="supplier-subscription-card" class="section">
    <p class="small">Checking subscription statusâ€¦</p>
  </div>
</div>
<div class="card" style="margin-top:16px">
  <h3>Lead Quality Overview</h3>
  <div id="lead-quality-breakdown" class="section">
    <p class="small">Loading lead quality statisticsâ€¦</p>
  </div>
</div>


<div class="card" style="margin-top:16px">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
    <h3 style="margin:0;">Support Tickets</h3>
    <button class="cta" id="createSupplierTicketBtn" style="padding:0.5rem 1rem;font-size:14px;">Create Ticket</button>
  </div>
  <div id="tickets-sup" class="section"><p class="small">Loadingâ€¦</p></div>
</div>

<div class="card" style="margin-top:16px">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
    <h3 style="margin:0;">Messages</h3>
    <span id="unreadMessageBadge" class="badge badge-info" style="display:none;font-size:14px;">0 unread</span>
  </div>
  <div id="threads-sup" class="section"><p class="small">Loadingâ€¦</p></div>
</div>

<script>
  // Quick Actions: Handle view conversations button
  document.addEventListener('DOMContentLoaded', () => {
    const viewConvBtn = document.getElementById('viewConversationsBtn');
    if (viewConvBtn) {
      viewConvBtn.addEventListener('click', () => {
        const threadsSection = document.getElementById('threads-sup');
        if (threadsSection) {
          threadsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      });
    }
  });
</script>

<script src="/assets/js/app.js?v=17.0.1"></script>
<script src="/assets/js/components.js?v=17.0.1"></script>
<script type="module" src="/assets/js/supplier-tickets.js?v=17.0.1"></script>
<script type="module" src="/assets/js/supplier-messages.js?v=17.0.1"></script>
<script type="module" src="/assets/js/supplier-gallery.js?v=17.0.1"></script>
<script type="module">
  // Display subscription status on dashboard using MongoDB API
  import { 
    initializeFeatureAccess, 
    displayPackageLimitNotice, 
    enforcePackageLimit 
  } from '/supplier/js/feature-access.js';
  
  // Initialize feature access control (non-blocking)
  initializeFeatureAccess().catch(err => {
    console.error('Error initializing feature access:', err);
  });
  
  async function displaySubscriptionStatus() {
    const container = document.getElementById('supplier-subscription-card');
    if (!container) return;
    
    try {
      // Load subscription status from payments API
      const response = await fetch('/api/payments', {
        credentials: 'include'
      });
      
      if (response.ok) {
        const data = await response.json();
        
        // Find active subscription
        const activeSubscription = data.payments.find(
          p => p.type === 'subscription' && 
               p.status === 'succeeded' &&
               p.subscriptionDetails &&
               !p.subscriptionDetails.cancelAtPeriodEnd
        );
        
        if (activeSubscription) {
          const details = activeSubscription.subscriptionDetails;
          const endDate = new Date(details.currentPeriodEnd);
          
          container.innerHTML = `
            <p class="small"><strong>Active Plan:</strong> ${details.planName || 'Pro Plan'}</p>
            <p class="small"><strong>Renews:</strong> ${endDate.toLocaleDateString('en-GB')}</p>
            <p class="small"><strong>Status:</strong> <span style="color: #10b981;">âœ“ Active</span></p>
            <a href="/supplier/subscription.html" class="btn btn-secondary" style="margin-top: 0.5rem;">Manage Subscription</a>
          `;
        } else {
          container.innerHTML = `
            <p class="small">You're currently on the <strong>Free Plan</strong></p>
            <p class="small">Upgrade to unlock premium features and boost your visibility!</p>
            <a href="/supplier/subscription.html" class="btn btn-primary" style="margin-top: 0.5rem;">Upgrade to Pro</a>
          `;
        }
      } else {
        // API error - show basic message
        container.innerHTML = `
          <p class="small">Manage your subscription and unlock premium features.</p>
          <a href="/supplier/subscription.html" class="btn btn-secondary" style="margin-top: 0.5rem;">View Plans</a>
        `;
      }
      
      // Update package limit display
      await updatePackageLimitDisplay();
      
    } catch (error) {
      console.error('Error loading subscription status:', error);
      container.innerHTML = `
        <p class="small">Unable to load subscription status.</p>
        <a href="/supplier/subscription.html" class="btn btn-secondary" style="margin-top: 0.5rem;">View Subscription</a>
      `;
    }
  }
  
  async function updatePackageLimitDisplay() {
    const limitContainer = document.getElementById('pkg-limit-note');
    if (!limitContainer) return;
    
    try {
      // TODO: Fetch package count from MongoDB API
      // For now, just hide the limit notice
      limitContainer.style.display = 'none';
      
    } catch (error) {
      console.error('Error checking package limit:', error);
    }
  }
  
  
  // Display lead quality breakdown
  async function displayLeadQualityBreakdown() {
    const container = document.getElementById("lead-quality-breakdown");
    if (!container) return;

    // Load badges CSS
    if (!document.getElementById("badges-css")) {
      const link = document.createElement("link");
      link.id = "badges-css";
      link.rel = "stylesheet";
      link.href = "/assets/css/badges.css";
      document.head.appendChild(link);
    }

    try {
      const response = await fetch("/api/threads/my");
      if (!response.ok) {
        throw new Error("Failed to fetch threads");
      }
      const data = await response.json();
      const threads = data.threads || [];

      if (threads.length === 0) {
        container.innerHTML = "<p class=\"small\">No enquiries yet. Lead quality statistics will appear here when customers contact you.</p>";
        return;
      }

      // Calculate lead quality breakdown
      const counts = { High: 0, Medium: 0, Low: 0 };
      threads.forEach(thread => {
        if (thread.leadScore) {
          counts[thread.leadScore] = (counts[thread.leadScore] || 0) + 1;
        }
      });

      const total = threads.length;
      const highPercent = Math.round((counts.High / total) * 100) || 0;
      const mediumPercent = Math.round((counts.Medium / total) * 100) || 0;
      const lowPercent = Math.round((counts.Low / total) * 100) || 0;
      const avgScore = Math.round(
        threads.reduce((sum, t) => sum + (t.leadScoreRaw || 50), 0) / total
      );

      container.innerHTML = `
        <div style="margin-bottom: 1rem;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
            <span class="lead-badge lead-badge-high" style="font-size: 0.875rem;">High Quality</span>
            <span style="font-weight: 600;">${counts.High} (${highPercent}%)</span>
          </div>
          <div style="background: #e5e7eb; border-radius: 4px; height: 8px; overflow: hidden;">
            <div style="background: #10b981; height: 100%; width: ${highPercent}%; transition: width 0.3s;"></div>
          </div>
        </div>
        
        <div style="margin-bottom: 1rem;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
            <span class="lead-badge lead-badge-medium" style="font-size: 0.875rem;">Medium Quality</span>
            <span style="font-weight: 600;">${counts.Medium} (${mediumPercent}%)</span>
          </div>
          <div style="background: #e5e7eb; border-radius: 4px; height: 8px; overflow: hidden;">
            <div style="background: #f59e0b; height: 100%; width: ${mediumPercent}%; transition: width 0.3s;"></div>
          </div>
        </div>
        
        <div style="margin-bottom: 1rem;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
            <span class="lead-badge lead-badge-low" style="font-size: 0.875rem;">Low Quality</span>
            <span style="font-weight: 600;">${counts.Low} (${lowPercent}%)</span>
          </div>
          <div style="background: #e5e7eb; border-radius: 4px; height: 8px; overflow: hidden;">
            <div style="background: #ef4444; height: 100%; width: ${lowPercent}%; transition: width 0.3s;"></div>
          </div>
        </div>
        
        <div style="margin-top: 1.5rem; padding: 0.75rem; background: #f9fafb; border-radius: 6px; text-align: center;">
          <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.25rem;">Average Lead Score</div>
          <div style="font-size: 1.5rem; font-weight: 700; color: #111827;">${avgScore}/100</div>
        </div>
      `;
    } catch (error) {
      console.error("Error fetching lead quality breakdown:", error);
      container.innerHTML = "<p class=\"small\" style=\"color: #ef4444;\">Error loading lead quality statistics.</p>";
    }
  }

  displayLeadQualityBreakdown();

  displaySubscriptionStatus();
</script>
<script>window.__EF_PAGE__='dash_supplier'</script>
<script>
// Check auth and personalize dashboard
(async function() {
  try {
    const response = await fetch('/api/auth/me', { credentials: 'include' });
    if (!response.ok) {
      // Redirect to login if not authenticated
      window.location.href = '/auth.html?redirect=' + encodeURIComponent(window.location.pathname);
      return;
    }
    const data = await response.json();
    const user = data.user;
    
    if (user) {
      // Personalize welcome message
      const welcomeHeading = document.getElementById('welcome-heading');
      if (welcomeHeading && user.firstName) {
        welcomeHeading.textContent = `Welcome ${user.firstName} to your supplier dashboard!`;
      } else if (welcomeHeading && user.name) {
        const firstName = user.name.split(' ')[0];
        welcomeHeading.textContent = `Welcome ${firstName} to your supplier dashboard!`;
      }
    }
  } catch (error) {
    console.error('Failed to load user data:', error);
  }
})();
</script>
</div></main>
<footer class="footer" role="contentinfo">
  <div class="container" style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
    <div><strong>EventFlow</strong><br><span class="small">Event planning made simple.</span></div>
    <div class="version">Version: v17.0.0</div>
    <div class="small"><a href="/blog.html">Blog</a> Â·
      <a href="/credits.html">Credits</a> Â· <a href="/contact.html">Contact</a> Â· <a href="/legal.html">Legal Hub</a></div>
  </div>
</footer>
<script src="/assets/js/components/footer-nav.js" defer></script>
<script src="/assets/js/cookie-consent.js" defer></script>

<!-- JadeAssist Chat Widget -->
<script src="https://cdn.jsdelivr.net/gh/rhysllwydlewis/JadeAssist@abbf580487e0bcf7739a0857d4d940213fe2e176/packages/widget/dist/jade-widget.js" defer></script>
<script src="/assets/js/jadeassist-init.v2.js" defer></script>
</body></html>
