<!DOCTYPE html>
<html lang='en-GB'>
<head>
<meta charset='utf-8'>
<meta name='viewport' content='width=device-width,initial-scale=1'>
<title>Marketplace Management â€” EventFlow Admin</title>
<link rel='stylesheet' href='/assets/css/styles.css'>
<link rel='stylesheet' href='/assets/css/eventflow-17.0.0.css'>
<link rel='stylesheet' href='/assets/css/utilities.css'>
<link rel='stylesheet' href='/assets/css/components.css'>
<link rel='stylesheet' href='/assets/css/animations.css'>
<link rel='stylesheet' href='/assets/css/admin.css'>
<link rel='stylesheet' href='/assets/css/admin-enhanced.css'>
<link rel='stylesheet' href='/assets/css/admin-navbar.css'>
<link rel='stylesheet' href='/assets/css/admin-cards.css'>
<link rel='stylesheet' href='/assets/css/ui-ux-fixes.css'>
<link rel='icon' href='/favicon.svg'>
<style>
  .filter-btn.active {
    background: #0B8073 !important;
    color: white !important;
    border-color: #0B8073 !important;
  }
  .filter-btn:hover {
    background: #f3f4f6;
  }
  .filter-btn.active:hover {
    background: #0a6d61 !important;
  }
  .listing-card {
    display: grid;
    grid-template-columns: 120px 1fr auto;
    gap: 16px;
    padding: 16px;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    margin-bottom: 12px;
    background: white;
  }
  .listing-image {
    width: 120px;
    height: 120px;
    object-fit: cover;
    border-radius: 6px;
    background: #f3f4f6;
  }
  .listing-info h3 {
    margin: 0 0 8px 0;
    font-size: 16px;
  }
  .listing-meta {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    font-size: 13px;
    color: #6b7280;
  }
  .listing-actions {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .status-badge {
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
    display: inline-block;
  }
  .status-pending { background: #fef3c7; color: #92400e; }
  .status-active { background: #d1fae5; color: #065f46; }
  .status-sold { background: #e0e7ff; color: #3730a3; }
  .status-removed { background: #fee2e2; color: #991b1b; }
</style>
<script src="/assets/js/admin-shared.js"></script>
<script src="/assets/js/components.js" defer></script>
<script src="/assets/js/admin-navbar.js" defer></script>
</head>
<body class="has-admin-navbar">
<a href="#main-content" class="skip-link">Skip to main content</a>
<!-- Modern Top Navbar -->
<nav class="admin-top-navbar">
  <div class="admin-navbar-content">
    <!-- Brand -->
    <div class="admin-navbar-brand">
      <a href="/admin.html" class="admin-navbar-logo">EventFlow</a>
      <span class="admin-navbar-title">Admin Panel</span>
    </div>

    <!-- Mobile Hamburger -->
    <button class="admin-hamburger" id="adminHamburger" aria-label="Toggle menu">
      <span></span>
      <span></span>
      <span></span>
    </button>

    <!-- Navigation Links -->
    <div class="admin-navbar-nav" id="adminNavbarNav">
      <a href="/admin.html" class="admin-nav-btn">
        <span class="nav-icon">ğŸ“Š</span>
        <span class="nav-label">Dashboard</span>
      </a>
      <a href="/admin-users.html" class="admin-nav-btn">
        <span class="nav-icon">ğŸ‘¥</span>
        <span class="nav-label">Users</span>
      </a>
      <a href="/admin-suppliers.html" class="admin-nav-btn">
        <span class="nav-icon">ğŸ¢</span>
        <span class="nav-label">Suppliers</span>
      </a>
      <a href="/admin-packages.html" class="admin-nav-btn">
        <span class="nav-icon">ğŸ“¦</span>
        <span class="nav-label">Packages</span>
      </a>
      <a href="/admin-marketplace.html" class="admin-nav-btn active">
        <span class="nav-icon">ğŸ›’</span>
        <span class="nav-label">Marketplace</span>
      </a>
      <a href="/admin-photos.html" class="admin-nav-btn">
        <span class="nav-icon">ğŸ“¸</span>
        <span class="nav-label">Photos</span>
      </a>
      <a href="/admin-content.html" class="admin-nav-btn">
        <span class="nav-icon">ğŸ“</span>
        <span class="nav-label">Content</span>
      </a>
      <a href="/admin-settings.html" class="admin-nav-btn">
        <span class="nav-icon">âš™ï¸</span>
        <span class="nav-label">Settings</span>
      </a>
      <div class="admin-navbar-divider"></div>
      <a href="/" class="admin-nav-btn">
        <span class="nav-icon">ğŸ </span>
        <span class="nav-label">Site</span>
      </a>
      <button class="admin-nav-btn" id="signoutBtn">
        <span class="nav-icon">ğŸšª</span>
        <span class="nav-label">Sign Out</span>
      </button>
    </div>
  </div>
</nav>

<main id="main-content" class="admin-content" style="padding-top:80px;">
  <div class="container" style="max-width:1200px">
    <h1 class="admin-page-title">ğŸ›’ Marketplace Management</h1>
    <p class="small">Moderate and manage marketplace listings from users</p>

    <!-- Stats -->
    <div class="admin-stats-row" style="margin-bottom:24px">
      <div class="admin-stat-card">
        <div class="admin-stat-value" id="stat-total">0</div>
        <div class="admin-stat-label">Total Listings</div>
      </div>
      <div class="admin-stat-card">
        <div class="admin-stat-value" id="stat-pending">0</div>
        <div class="admin-stat-label">Pending Approval</div>
      </div>
      <div class="admin-stat-card">
        <div class="admin-stat-value" id="stat-active">0</div>
        <div class="admin-stat-label">Active Listings</div>
      </div>
      <div class="admin-stat-card">
        <div class="admin-stat-value" id="stat-sold">0</div>
        <div class="admin-stat-label">Sold</div>
      </div>
    </div>

    <!-- Filters -->
    <div class="card" style="margin-bottom:24px">
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px">
        <button class="filter-btn active" data-filter="all">All</button>
        <button class="filter-btn" data-filter="pending">Pending</button>
        <button class="filter-btn" data-filter="active">Active</button>
        <button class="filter-btn" data-filter="sold">Sold</button>
        <button class="filter-btn" data-filter="removed">Removed</button>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <input type="text" id="searchInput" placeholder="Search listings..." style="flex:1;min-width:200px">
        <select id="categoryFilter">
          <option value="">All Categories</option>
          <option value="attire">Attire</option>
          <option value="decor">DÃ©cor</option>
          <option value="av-equipment">AV Equipment</option>
          <option value="photography">Photography</option>
          <option value="party-supplies">Party Supplies</option>
          <option value="florals">Florals</option>
        </select>
      </div>
    </div>

    <!-- Listings -->
    <div id="listings-container">
      <div class="card"><p>Loading listings...</p></div>
    </div>
  </div>
</main>

<script>
(async function() {
  'use strict';

  let allListings = [];
  let currentFilter = 'all';

  // Fetch listings
  async function loadListings() {
    try {
      const res = await fetch('/api/admin/marketplace/listings', {
        credentials: 'include'
      });
      if (!res.ok) throw new Error('Failed to fetch listings');
      const data = await res.json();
      allListings = data.listings || [];
      updateStats();
      renderListings();
    } catch (error) {
      console.error('Error loading listings:', error);
      document.getElementById('listings-container').innerHTML = 
        '<div class="card"><p class="error">Failed to load listings</p></div>';
    }
  }

  // Update stats
  function updateStats() {
    document.getElementById('stat-total').textContent = allListings.length;
    document.getElementById('stat-pending').textContent = 
      allListings.filter(l => l.status === 'pending').length;
    document.getElementById('stat-active').textContent = 
      allListings.filter(l => l.status === 'active').length;
    document.getElementById('stat-sold').textContent = 
      allListings.filter(l => l.status === 'sold').length;
  }

  // Render listings
  function renderListings() {
    const container = document.getElementById('listings-container');
    const search = document.getElementById('searchInput').value.toLowerCase();
    const category = document.getElementById('categoryFilter').value;

    let filtered = allListings;

    // Apply status filter
    if (currentFilter !== 'all') {
      filtered = filtered.filter(l => l.status === currentFilter);
    }

    // Apply search
    if (search) {
      filtered = filtered.filter(l => 
        l.title.toLowerCase().includes(search) ||
        l.description.toLowerCase().includes(search) ||
        l.userEmail.toLowerCase().includes(search)
      );
    }

    // Apply category filter
    if (category) {
      filtered = filtered.filter(l => l.category === category);
    }

    if (filtered.length === 0) {
      container.innerHTML = '<div class="card"><p>No listings found</p></div>';
      return;
    }

    container.innerHTML = filtered.map(listing => `
      <div class="listing-card">
        <div>
          ${listing.images && listing.images[0] 
            ? `<img src="${listing.images[0]}" alt="${listing.title}" class="listing-image">`
            : '<div class="listing-image"></div>'
          }
        </div>
        <div class="listing-info">
          <h3>${escapeHtml(listing.title)}</h3>
          <p class="small">${escapeHtml(listing.description.slice(0, 150))}${listing.description.length > 150 ? '...' : ''}</p>
          <div class="listing-meta">
            <span><strong>Â£${listing.price.toFixed(2)}</strong></span>
            <span>ğŸ“ ${escapeHtml(listing.location || 'No location')}</span>
            <span>Category: ${escapeHtml(listing.category)}</span>
            <span>Condition: ${escapeHtml(listing.condition)}</span>
          </div>
          <div class="listing-meta" style="margin-top:8px">
            <span>Posted by: ${escapeHtml(listing.userEmail)}</span>
            <span>${new Date(listing.createdAt).toLocaleDateString()}</span>
          </div>
        </div>
        <div class="listing-actions">
          <span class="status-badge status-${listing.status}">${listing.status}</span>
          ${listing.status === 'pending' ? `
            <button class="cta" onclick="approveListing('${listing.id}', true)">Approve</button>
            <button class="cta secondary" onclick="approveListing('${listing.id}', false)">Reject</button>
          ` : ''}
          ${listing.status === 'active' ? `
            <button class="cta secondary" onclick="markAsSold('${listing.id}')">Mark Sold</button>
          ` : ''}
          <button class="cta ghost" onclick="deleteListing('${listing.id}')">Delete</button>
        </div>
      </div>
    `).join('');
  }

  // Approve/reject listing
  window.approveListing = async function(id, approved) {
    try {
      const res = await fetch(`/api/admin/marketplace/listings/${id}/approve`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ approved })
      });

      if (!res.ok) throw new Error('Failed to update listing');

      showToast(approved ? 'Listing approved' : 'Listing rejected');
      await loadListings();
    } catch (error) {
      console.error('Error updating listing:', error);
      showToast('Failed to update listing', 'error');
    }
  };

  // Mark as sold
  window.markAsSold = async function(id) {
    try {
      const res = await fetch(`/api/marketplace/listings/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ status: 'sold' })
      });

      if (!res.ok) throw new Error('Failed to update listing');

      showToast('Listing marked as sold');
      await loadListings();
    } catch (error) {
      console.error('Error updating listing:', error);
      showToast('Failed to update listing', 'error');
    }
  };

  // Delete listing
  window.deleteListing = async function(id) {
    if (!confirm('Are you sure you want to delete this listing?')) return;

    try {
      const res = await fetch(`/api/marketplace/listings/${id}`, {
        method: 'DELETE',
        credentials: 'include'
      });

      if (!res.ok) throw new Error('Failed to delete listing');

      showToast('Listing deleted');
      await loadListings();
    } catch (error) {
      console.error('Error deleting listing:', error);
      showToast('Failed to delete listing', 'error');
    }
  };

  // Show toast notification
  function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.textContent = message;
    toast.style.cssText = `
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: ${type === 'error' ? '#dc2626' : '#16a34a'};
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      z-index: 10000;
    `;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
  }

  // Escape HTML
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Filter buttons
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentFilter = btn.dataset.filter;
      renderListings();
    });
  });

  // Search and category filters
  document.getElementById('searchInput').addEventListener('input', renderListings);
  document.getElementById('categoryFilter').addEventListener('change', renderListings);

  // Sign out
  document.getElementById('signoutBtn').addEventListener('click', async () => {
    await fetch('/api/auth/signout', { method: 'POST', credentials: 'include' });
    window.location.href = '/auth.html';
  });

  // Initial load
  await loadListings();
})();
</script>
</body>
</html>
