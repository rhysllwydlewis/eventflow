<!DOCTYPE html>
<html lang='en-GB'>
<head>
  <script src="/assets/js/dashboard-guard.js?v=17.0.2"></script>
<meta charset='utf-8'>
<meta name='viewport' content='width=device-width,initial-scale=1'>
<title>Marketplace Management ‚Äî EventFlow Admin</title>
<link rel='stylesheet' href='/assets/css/styles.css?v=17.0.0'>
<link rel='stylesheet' href='/assets/css/eventflow-17.0.0.css?v=17.0.0'>
<link rel='stylesheet' href='/assets/css/utilities.css?v=17.0.0'>
<link rel='stylesheet' href='/assets/css/components.css?v=17.0.0'>
<link rel='stylesheet' href='/assets/css/animations.css?v=17.0.0'>
<link rel='stylesheet' href='/assets/css/admin.css?v=17.0.0'>
<link rel='stylesheet' href='/assets/css/admin-enhanced.css?v=17.0.0'>
<link rel='stylesheet' href='/assets/css/admin-navbar.css?v=17.0.0'>
<link rel='stylesheet' href='/assets/css/admin-cards.css?v=17.0.0'>
<link rel="stylesheet" href="/assets/css/mobile-optimizations.css?v=17.0.0"><link rel='stylesheet' href='/assets/css/ui-ux-fixes.css?v=17.0.0'>
<link rel='icon' href='/favicon.svg'>
<style>
  .filter-btn.active {
    background: #0B8073 !important;
    color: white !important;
    border-color: #0B8073 !important;
  }
  .filter-btn:hover {
    background: #f3f4f6;
  }
  .filter-btn.active:hover {
    background: #0a6d61 !important;
  }
  .listing-card {
    display: grid;
    grid-template-columns: 120px 1fr auto;
    gap: 16px;
    padding: 16px;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    margin-bottom: 12px;
    background: white;
  }
  .listing-image {
    width: 120px;
    height: 120px;
    object-fit: cover;
    border-radius: 6px;
    background: #f3f4f6;
  }
  .listing-info h3 {
    margin: 0 0 8px 0;
    font-size: 16px;
  }
  .listing-meta {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    font-size: 13px;
    color: #6b7280;
  }
  .listing-actions {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .status-badge {
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
    display: inline-block;
  }
  .status-pending { background: #fef3c7; color: #92400e; }
  .status-active { background: #d1fae5; color: #065f46; }
  .status-sold { background: #e0e7ff; color: #3730a3; }
  .status-removed { background: #fee2e2; color: #991b1b; }
</style>
<script src="/assets/js/admin-shared.js"></script>
<script src="/assets/js/components.js" defer></script>
<script src="/assets/js/admin-navbar.js" defer></script>
</head>
<body class="has-admin-navbar">
<a href="#main-content" class="skip-link">Skip to main content</a>
<!-- Modern Top Navbar -->
<nav class="admin-top-navbar">
  <div class="admin-navbar-content">
    <!-- Brand -->
    <div class="admin-navbar-brand">
      <a href="/admin.html" class="admin-navbar-logo">EventFlow</a>
      <span class="admin-navbar-title">Admin Panel</span>
    </div>

    <!-- Mobile Hamburger -->
    <button class="admin-hamburger" id="adminHamburger" aria-label="Toggle menu">
      <span></span>
      <span></span>
      <span></span>
    </button>

    <!-- Navigation Links -->
    <div class="admin-navbar-nav" id="adminNavbarNav">
      <a href="/admin.html" class="admin-nav-btn">
        <span class="nav-icon">üìä</span>
        <span class="nav-label">Dashboard</span>
      </a>
      <a href="/admin-users.html" class="admin-nav-btn">
        <span class="nav-icon">üë•</span>
        <span class="nav-label">Users</span>
      </a>
      <a href="/admin-suppliers.html" class="admin-nav-btn">
        <span class="nav-icon">üè¢</span>
        <span class="nav-label">Suppliers</span>
      </a>
      <a href="/admin-packages.html" class="admin-nav-btn">
        <span class="nav-icon">üì¶</span>
        <span class="nav-label">Packages</span>
      </a>
      <a href="/admin-marketplace.html" class="admin-nav-btn active">
        <span class="nav-icon">üõí</span>
        <span class="nav-label">Marketplace</span>
      </a>
      <a href="/admin-photos.html" class="admin-nav-btn">
        <span class="nav-icon">üì∏</span>
        <span class="nav-label">Photos</span>
      </a>
      <a href="/admin-content.html" class="admin-nav-btn">
        <span class="nav-icon">üìù</span>
        <span class="nav-label">Content</span>
      </a>
      <a href="/admin-settings.html" class="admin-nav-btn">
        <span class="nav-icon">‚öôÔ∏è</span>
        <span class="nav-label">Settings</span>
      </a>
      <div class="admin-navbar-divider"></div>
      <a href="/" class="admin-nav-btn">
        <span class="nav-icon">üè†</span>
        <span class="nav-label">Site</span>
      </a>
      <button class="admin-nav-btn" id="signoutBtn">
        <span class="nav-icon">üö™</span>
        <span class="nav-label">Sign Out</span>
      </button>
    </div>
  </div>
</nav>

<main id="main-content" class="admin-content" style="padding-top:80px;">
  <div class="container" style="max-width:1200px">
    <h1 class="admin-page-title">üõí Marketplace Management</h1>
    <p class="small">Moderate and manage marketplace listings from users</p>

    <!-- Stats -->
    <div class="admin-stats-row" style="margin-bottom:24px">
      <div class="admin-stat-card">
        <div class="admin-stat-value" id="stat-total">0</div>
        <div class="admin-stat-label">Total Listings</div>
      </div>
      <div class="admin-stat-card">
        <div class="admin-stat-value" id="stat-pending">0</div>
        <div class="admin-stat-label">Pending Approval</div>
      </div>
      <div class="admin-stat-card">
        <div class="admin-stat-value" id="stat-active">0</div>
        <div class="admin-stat-label">Active Listings</div>
      </div>
      <div class="admin-stat-card">
        <div class="admin-stat-value" id="stat-sold">0</div>
        <div class="admin-stat-label">Sold</div>
      </div>
    </div>

    <!-- Filters -->
    <div class="card" style="margin-bottom:24px">
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px">
        <button class="filter-btn active" data-filter="all">All</button>
        <button class="filter-btn" data-filter="pending">Pending</button>
        <button class="filter-btn" data-filter="active">Active</button>
        <button class="filter-btn" data-filter="sold">Sold</button>
        <button class="filter-btn" data-filter="removed">Removed</button>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <input type="text" id="searchInput" placeholder="Search listings..." style="flex:1;min-width:200px">
        <select id="categoryFilter">
          <option value="">All Categories</option>
          <option value="attire">Attire</option>
          <option value="decor">D√©cor</option>
          <option value="av-equipment">AV Equipment</option>
          <option value="photography">Photography</option>
          <option value="party-supplies">Party Supplies</option>
          <option value="florals">Florals</option>
        </select>
        <button class="cta secondary" id="exportListingsBtn" title="Export listings to CSV">
          üì• Export
        </button>
      </div>
    </div>

    <!-- Bulk Actions Bar -->
    <div id="bulkActionsBar" style="display:none;margin-bottom:16px;padding:12px 16px;background:#f3f4f6;border-radius:8px;align-items:center;gap:12px;">
      <input type="checkbox" id="selectAll" style="cursor:pointer">
      <span id="selectedCount" style="flex:1;font-weight:500;">0 selected</span>
      <button class="cta" onclick="bulkApprove()" style="padding:6px 12px;font-size:14px;">Approve Selected</button>
      <button class="cta secondary" onclick="bulkMarkSold()" style="padding:6px 12px;font-size:14px;">Mark Sold</button>
      <button class="cta ghost" onclick="bulkDelete()" style="padding:6px 12px;font-size:14px;">Delete Selected</button>
    </div>

    <!-- Listings -->
    <div id="listings-container">
      <div class="card"><p>Loading listings...</p></div>
    </div>
  </div>
</main>

<script>
(async function() {
  'use strict';

  let allListings = [];
  let currentFilter = 'all';
  const selectedListings = new Set();

  // Fetch listings
  async function loadListings() {
    try {
      const res = await fetch('/api/admin/marketplace/listings', {
        credentials: 'include'
      });
      if (!res.ok) throw new Error('Failed to fetch listings');
      const data = await res.json();
      allListings = data.listings || [];
      selectedListings.clear();
      updateStats();
      renderListings();
      updateBulkActionsBar();
    } catch (error) {
      console.error('Error loading listings:', error);
      document.getElementById('listings-container').innerHTML = 
        '<div class="card"><p class="error">Failed to load listings</p></div>';
    }
  }

  // Update stats
  function updateStats() {
    document.getElementById('stat-total').textContent = allListings.length;
    document.getElementById('stat-pending').textContent = 
      allListings.filter(l => l.status === 'pending').length;
    document.getElementById('stat-active').textContent = 
      allListings.filter(l => l.status === 'active').length;
    document.getElementById('stat-sold').textContent = 
      allListings.filter(l => l.status === 'sold').length;
  }

  // Render listings
  function renderListings() {
    const container = document.getElementById('listings-container');
    const search = document.getElementById('searchInput').value.toLowerCase();
    const category = document.getElementById('categoryFilter').value;

    let filtered = allListings;

    // Apply status filter
    if (currentFilter !== 'all') {
      filtered = filtered.filter(l => l.status === currentFilter);
    }

    // Apply search
    if (search) {
      filtered = filtered.filter(l => 
        l.title.toLowerCase().includes(search) ||
        l.description.toLowerCase().includes(search) ||
        l.userEmail.toLowerCase().includes(search)
      );
    }

    // Apply category filter
    if (category) {
      filtered = filtered.filter(l => l.category === category);
    }

    if (filtered.length === 0) {
      container.innerHTML = '<div class="card"><p>No listings found</p></div>';
      return;
    }

    container.innerHTML = filtered.map(listing => `
      <div class="listing-card">
        <div style="display:flex;align-items:flex-start;gap:8px;">
          <input type="checkbox" onchange="toggleSelection('${listing.id}')" ${selectedListings.has(listing.id) ? 'checked' : ''} style="margin-top:4px;cursor:pointer;">
          ${listing.images && listing.images[0] 
            ? `<img src="${listing.images[0]}" alt="${listing.title}" class="listing-image">`
            : '<div class="listing-image"></div>'
          }
        </div>
        <div class="listing-info">
          <h3>${escapeHtml(listing.title)}</h3>
          <p class="small">${escapeHtml(listing.description.slice(0, 150))}${listing.description.length > 150 ? '...' : ''}</p>
          <div class="listing-meta">
            <span><strong>¬£${listing.price.toFixed(2)}</strong></span>
            <span>üìç ${escapeHtml(listing.location || 'No location')}</span>
            <span>Category: ${escapeHtml(listing.category)}</span>
            <span>Condition: ${escapeHtml(listing.condition)}</span>
          </div>
          <div class="listing-meta" style="margin-top:8px">
            <span>Posted by: ${escapeHtml(listing.userEmail)}</span>
            <span>${new Date(listing.createdAt).toLocaleDateString()}</span>
          </div>
        </div>
        <div class="listing-actions">
          <span class="status-badge status-${listing.status}">${listing.status}</span>
          <button class="cta" onclick="editListing('${listing.id}')">‚úèÔ∏è Edit</button>
          ${listing.status === 'pending' ? `
            <button class="cta" onclick="approveListing('${listing.id}', true)">Approve</button>
            <button class="cta secondary" onclick="approveListing('${listing.id}', false)">Reject</button>
          ` : ''}
          ${listing.status === 'active' ? `
            <button class="cta secondary" onclick="markAsSold('${listing.id}')">Mark Sold</button>
          ` : ''}
          <button class="cta ghost" onclick="deleteListing('${listing.id}')">Delete</button>
        </div>
      </div>
    `).join('');
  }

  // Approve/reject listing
  window.approveListing = async function(id, approved) {
    try {
      const res = await fetch(`/api/admin/marketplace/listings/${id}/approve`, {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'X-CSRF-Token': window.__CSRF_TOKEN__ || ''
        },
        credentials: 'include',
        body: JSON.stringify({ approved })
      });

      if (!res.ok) throw new Error('Failed to update listing');

      showToast(approved ? 'Listing approved' : 'Listing rejected');
      await loadListings();
    } catch (error) {
      console.error('Error updating listing:', error);
      showToast('Failed to update listing', 'error');
    }
  };

  // Mark as sold
  window.markAsSold = async function(id) {
    try {
      const res = await fetch(`/api/marketplace/listings/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ status: 'sold' })
      });

      if (!res.ok) throw new Error('Failed to update listing');

      showToast('Listing marked as sold');
      await loadListings();
    } catch (error) {
      console.error('Error updating listing:', error);
      showToast('Failed to update listing', 'error');
    }
  };

  // Delete listing
  window.deleteListing = async function(id) {
    if (!confirm('Are you sure you want to delete this listing?')) return;

    try {
      const res = await fetch(`/api/marketplace/listings/${id}`, {
        method: 'DELETE',
        credentials: 'include'
      });

      if (!res.ok) throw new Error('Failed to delete listing');

      showToast('Listing deleted');
      await loadListings();
    } catch (error) {
      console.error('Error deleting listing:', error);
      showToast('Failed to delete listing', 'error');
    }
  };

  // Edit listing
  window.editListing = function(id) {
    const listing = allListings.find(l => l.id === id);
    if (!listing) return;

    // Create modal for editing
    const modal = document.createElement('div');
    modal.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      padding: 20px;
    `;

    modal.innerHTML = `
      <div style="background: white; border-radius: 12px; padding: 24px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2 style="margin: 0;">Edit Listing</h2>
          <button id="closeModal" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
        </div>
        <form id="editListingForm" style="display: flex; flex-direction: column; gap: 16px;">
          <div>
            <label style="display: block; margin-bottom: 4px; font-weight: 500;">Title</label>
            <input type="text" id="editTitle" value="${escapeHtml(listing.title)}" required style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
          </div>
          <div>
            <label style="display: block; margin-bottom: 4px; font-weight: 500;">Description</label>
            <textarea id="editDescription" rows="4" required style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">${escapeHtml(listing.description)}</textarea>
          </div>
          <div>
            <label style="display: block; margin-bottom: 4px; font-weight: 500;">Price (¬£)</label>
            <input type="number" id="editPrice" value="${listing.price}" required min="0" step="0.01" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
          </div>
          <div>
            <label style="display: block; margin-bottom: 4px; font-weight: 500;">Location</label>
            <input type="text" id="editLocation" value="${escapeHtml(listing.location || '')}" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
          </div>
          <div>
            <label style="display: block; margin-bottom: 4px; font-weight: 500;">Category</label>
            <select id="editCategory" required style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
              <option value="furniture" ${listing.category === 'furniture' ? 'selected' : ''}>Furniture</option>
              <option value="electronics" ${listing.category === 'electronics' ? 'selected' : ''}>Electronics</option>
              <option value="clothing" ${listing.category === 'clothing' ? 'selected' : ''}>Clothing</option>
              <option value="books" ${listing.category === 'books' ? 'selected' : ''}>Books</option>
              <option value="toys" ${listing.category === 'toys' ? 'selected' : ''}>Toys</option>
              <option value="sports" ${listing.category === 'sports' ? 'selected' : ''}>Sports</option>
              <option value="home" ${listing.category === 'home' ? 'selected' : ''}>Home & Garden</option>
              <option value="other" ${listing.category === 'other' ? 'selected' : ''}>Other</option>
            </select>
          </div>
          <div>
            <label style="display: block; margin-bottom: 4px; font-weight: 500;">Condition</label>
            <select id="editCondition" required style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
              <option value="new" ${listing.condition === 'new' ? 'selected' : ''}>New</option>
              <option value="like-new" ${listing.condition === 'like-new' ? 'selected' : ''}>Like New</option>
              <option value="good" ${listing.condition === 'good' ? 'selected' : ''}>Good</option>
              <option value="fair" ${listing.condition === 'fair' ? 'selected' : ''}>Fair</option>
              <option value="poor" ${listing.condition === 'poor' ? 'selected' : ''}>Poor</option>
            </select>
          </div>
          <div>
            <label style="display: block; margin-bottom: 4px; font-weight: 500;">Status</label>
            <select id="editStatus" required style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
              <option value="pending" ${listing.status === 'pending' ? 'selected' : ''}>Pending</option>
              <option value="active" ${listing.status === 'active' ? 'selected' : ''}>Active</option>
              <option value="sold" ${listing.status === 'sold' ? 'selected' : ''}>Sold</option>
              <option value="removed" ${listing.status === 'removed' ? 'selected' : ''}>Removed</option>
            </select>
          </div>
          <div style="display: flex; gap: 12px; margin-top: 8px;">
            <button type="submit" class="cta" style="flex: 1;">Save Changes</button>
            <button type="button" id="cancelEdit" class="cta secondary" style="flex: 1;">Cancel</button>
          </div>
        </form>
      </div>
    `;

    document.body.appendChild(modal);

    // Close modal handlers
    const closeModal = () => modal.remove();
    modal.querySelector('#closeModal').addEventListener('click', closeModal);
    modal.querySelector('#cancelEdit').addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => {
      if (e.target === modal) closeModal();
    });

    // Form submit
    modal.querySelector('#editListingForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const updatedData = {
        title: modal.querySelector('#editTitle').value,
        description: modal.querySelector('#editDescription').value,
        price: parseFloat(modal.querySelector('#editPrice').value),
        location: modal.querySelector('#editLocation').value,
        category: modal.querySelector('#editCategory').value,
        condition: modal.querySelector('#editCondition').value,
        status: modal.querySelector('#editStatus').value
      };

      try {
        const res = await fetch(`/api/marketplace/listings/${id}`, {
          method: 'PUT',
          headers: { 
            'Content-Type': 'application/json',
            'X-CSRF-Token': window.__CSRF_TOKEN__ || ''
          },
          credentials: 'include',
          body: JSON.stringify(updatedData)
        });

        if (!res.ok) throw new Error('Failed to update listing');

        showToast('Listing updated successfully');
        closeModal();
        await loadListings();
      } catch (error) {
        console.error('Error updating listing:', error);
        showToast('Failed to update listing', 'error');
      }
    });
  };

  // Show toast notification
  function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.textContent = message;
    toast.style.cssText = `
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: ${type === 'error' ? '#dc2626' : '#16a34a'};
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      z-index: 10000;
    `;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
  }

  // Escape HTML
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Toggle selection
  window.toggleSelection = function(id) {
    if (selectedListings.has(id)) {
      selectedListings.delete(id);
    } else {
      selectedListings.add(id);
    }
    updateBulkActionsBar();
  };

  // Update bulk actions bar
  function updateBulkActionsBar() {
    const bar = document.getElementById('bulkActionsBar');
    const count = document.getElementById('selectedCount');
    const selectAll = document.getElementById('selectAll');
    
    if (selectedListings.size > 0) {
      bar.style.display = 'flex';
      count.textContent = `${selectedListings.size} selected`;
    } else {
      bar.style.display = 'none';
    }
    
    // Update select all checkbox
    const filtered = getFilteredListings();
    selectAll.checked = filtered.length > 0 && filtered.every(l => selectedListings.has(l.id));
  }

  // Get filtered listings
  function getFilteredListings() {
    let filtered = allListings;
    const search = document.getElementById('searchInput').value.toLowerCase();
    const category = document.getElementById('categoryFilter').value;
    
    if (currentFilter !== 'all') {
      filtered = filtered.filter(l => l.status === currentFilter);
    }
    if (search) {
      filtered = filtered.filter(l => 
        l.title.toLowerCase().includes(search) ||
        l.description.toLowerCase().includes(search) ||
        l.userEmail.toLowerCase().includes(search)
      );
    }
    if (category) {
      filtered = filtered.filter(l => l.category === category);
    }
    
    return filtered;
  }

  // Select all handler
  document.getElementById('selectAll').addEventListener('change', function(e) {
    const filtered = getFilteredListings();
    if (e.target.checked) {
      filtered.forEach(l => selectedListings.add(l.id));
    } else {
      filtered.forEach(l => selectedListings.delete(l.id));
    }
    renderListings();
    updateBulkActionsBar();
  });

  // Bulk approve
  window.bulkApprove = async function() {
    if (selectedListings.size === 0) return;
    if (!confirm(`Approve ${selectedListings.size} listing(s)?`)) return;

    try {
      const promises = Array.from(selectedListings).map(id =>
        fetch(`/api/admin/marketplace/listings/${id}/approve`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': window.__CSRF_TOKEN__ || '' },
          credentials: 'include',
          body: JSON.stringify({ approved: true })
        })
      );
      await Promise.all(promises);
      showToast(`Approved ${selectedListings.size} listing(s)`);
      await loadListings();
    } catch (error) {
      console.error('Error bulk approving:', error);
      showToast('Failed to approve some listings', 'error');
    }
  };

  // Bulk mark sold
  window.bulkMarkSold = async function() {
    if (selectedListings.size === 0) return;
    if (!confirm(`Mark ${selectedListings.size} listing(s) as sold?`)) return;

    try {
      const promises = Array.from(selectedListings).map(id =>
        fetch(`/api/marketplace/listings/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': window.__CSRF_TOKEN__ || '' },
          credentials: 'include',
          body: JSON.stringify({ status: 'sold' })
        })
      );
      await Promise.all(promises);
      showToast(`Marked ${selectedListings.size} listing(s) as sold`);
      await loadListings();
    } catch (error) {
      console.error('Error bulk marking sold:', error);
      showToast('Failed to mark some listings as sold', 'error');
    }
  };

  // Bulk delete
  window.bulkDelete = async function() {
    if (selectedListings.size === 0) return;
    if (!confirm(`Delete ${selectedListings.size} listing(s)? This cannot be undone.`)) return;

    try {
      const promises = Array.from(selectedListings).map(id =>
        fetch(`/api/marketplace/listings/${id}`, {
          method: 'DELETE',
          headers: { 'X-CSRF-Token': window.__CSRF_TOKEN__ || '' },
          credentials: 'include'
        })
      );
      await Promise.all(promises);
      showToast(`Deleted ${selectedListings.size} listing(s)`);
      await loadListings();
    } catch (error) {
      console.error('Error bulk deleting:', error);
      showToast('Failed to delete some listings', 'error');
    }
  };

  // Export listings
  document.getElementById('exportListingsBtn').addEventListener('click', function() {
    const filtered = getFilteredListings();
    if (filtered.length === 0) {
      showToast('No listings to export', 'error');
      return;
    }

    const csv = [
      ['Title', 'Description', 'Price', 'Category', 'Condition', 'Status', 'Location', 'Posted By', 'Created At'].join(','),
      ...filtered.map(l => [
        `"${l.title.replace(/"/g, '""')}"`,
        `"${l.description.replace(/"/g, '""').slice(0, 100)}"`,
        l.price,
        l.category,
        l.condition,
        l.status,
        `"${(l.location || '').replace(/"/g, '""')}"`,
        l.userEmail,
        new Date(l.createdAt).toISOString()
      ].join(','))
    ].join('\n');

    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `marketplace-listings-${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    URL.revokeObjectURL(url);
    
    showToast(`Exported ${filtered.length} listing(s)`);
  });

  // Filter buttons
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentFilter = btn.dataset.filter;
      renderListings();
    });
  });

  // Search and category filters
  document.getElementById('searchInput').addEventListener('input', renderListings);
  document.getElementById('categoryFilter').addEventListener('change', renderListings);

  // Sign out
  document.getElementById('signoutBtn').addEventListener('click', async () => {
    await fetch('/api/auth/signout', { method: 'POST', credentials: 'include' });
    window.location.href = '/auth.html';
  });

  // Initial load
  await loadListings();
})();
</script>
<script src="/assets/js/cookie-consent.js" defer></script>
</body>
</html>
