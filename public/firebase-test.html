<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Integration Test - EventFlow</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #3b82f6;
            padding-bottom: 10px;
        }
        .test-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-item {
            padding: 10px;
            margin: 10px 0;
            border-left: 4px solid #ddd;
            background: #f9f9f9;
        }
        .test-item.pending {
            border-left-color: #fbbf24;
        }
        .test-item.pass {
            border-left-color: #10b981;
            background: #f0fdf4;
        }
        .test-item.fail {
            border-left-color: #ef4444;
            background: #fef2f2;
        }
        .test-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .test-result {
            font-size: 14px;
            color: #666;
        }
        .summary {
            background: #eff6ff;
            border: 2px solid #3b82f6;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        button:hover {
            background: #2563eb;
        }
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .code {
            background: #1f2937;
            color: #f3f4f6;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <h1>üî• Firebase Integration Test Suite</h1>
    
    <div class="test-section">
        <h2>Test Controls</h2>
        <button id="runAllTests">Run All Tests</button>
        <button id="clearResults">Clear Results</button>
    </div>

    <div class="test-section">
        <h2>1. Firebase Configuration Tests</h2>
        <div id="config-tests"></div>
    </div>

    <div class="test-section">
        <h2>2. Firestore Collections Tests</h2>
        <div id="firestore-tests"></div>
    </div>

    <div class="test-section">
        <h2>3. Firebase Storage Tests</h2>
        <div id="storage-tests"></div>
    </div>

    <div class="test-section">
        <h2>4. Module Integration Tests</h2>
        <div id="module-tests"></div>
    </div>

    <div class="summary" id="summary" style="display:none;">
        <h2>Test Summary</h2>
        <div id="summary-content"></div>
    </div>

    <script type="module">
        import * as firebaseConfig from '/assets/js/firebase-config.js';
        import ticketingSystem from '/assets/js/ticketing.js';
        import messagingSystem from '/assets/js/messaging.js';

        const tests = {
            config: [
                { name: 'Firebase SDK imported', fn: () => firebaseConfig.app !== undefined },
                { name: 'Firestore initialized', fn: () => firebaseConfig.db !== undefined },
                { name: 'Storage initialized', fn: () => firebaseConfig.storage !== undefined },
                { name: 'Auth initialized', fn: () => firebaseConfig.auth !== undefined },
                { name: 'Helper functions exported', fn: () => typeof firebaseConfig.saveDocument === 'function' },
                { name: 'Upload function exported', fn: () => typeof firebaseConfig.uploadImage === 'function' }
            ],
            firestore: [
                { name: 'Firestore collection helper', fn: () => typeof firebaseConfig.collection === 'function' },
                { name: 'Firestore query helper', fn: () => typeof firebaseConfig.query === 'function' },
                { name: 'Firestore arrayUnion available', fn: () => typeof firebaseConfig.arrayUnion === 'function' },
                { name: 'Firestore writeBatch available', fn: () => typeof firebaseConfig.writeBatch === 'function' }
            ],
            storage: [
                { name: 'Storage ref function', fn: () => typeof firebaseConfig.ref === 'function' },
                { name: 'Upload bytes function', fn: () => typeof firebaseConfig.uploadBytes === 'function' },
                { name: 'Get download URL function', fn: () => typeof firebaseConfig.getDownloadURL === 'function' }
            ],
            modules: [
                { name: 'Ticketing module loaded', fn: () => ticketingSystem !== undefined },
                { name: 'Ticketing createTicket method', fn: () => typeof ticketingSystem.createTicket === 'function' },
                { name: 'Ticketing addResponse method', fn: () => typeof ticketingSystem.addResponse === 'function' },
                { name: 'Messaging module loaded', fn: () => messagingSystem !== undefined },
                { name: 'Messaging startConversation method', fn: () => typeof messagingSystem.startConversation === 'function' },
                { name: 'Messaging sendMessage method', fn: () => typeof messagingSystem.sendMessage === 'function' }
            ]
        };

        function createTestItem(name, status, message = '') {
            const item = document.createElement('div');
            item.className = `test-item ${status}`;
            item.innerHTML = `
                <div class="test-name">${name}</div>
                <div class="test-result">${message || status.toUpperCase()}</div>
            `;
            return item;
        }

        async function runTests(category, testList, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            let passed = 0;
            let failed = 0;

            for (const test of testList) {
                try {
                    const result = await test.fn();
                    if (result) {
                        container.appendChild(createTestItem(test.name, 'pass', 'Test passed'));
                        passed++;
                    } else {
                        container.appendChild(createTestItem(test.name, 'fail', 'Test returned false'));
                        failed++;
                    }
                } catch (error) {
                    container.appendChild(createTestItem(test.name, 'fail', `Error: ${error.message}`));
                    failed++;
                }
            }

            return { passed, failed, total: testList.length };
        }

        async function runAllTests() {
            const results = {
                config: await runTests('config', tests.config, 'config-tests'),
                firestore: await runTests('firestore', tests.firestore, 'firestore-tests'),
                storage: await runTests('storage', tests.storage, 'storage-tests'),
                modules: await runTests('modules', tests.modules, 'module-tests')
            };

            // Calculate totals
            const totalPassed = Object.values(results).reduce((sum, r) => sum + r.passed, 0);
            const totalFailed = Object.values(results).reduce((sum, r) => sum + r.failed, 0);
            const totalTests = Object.values(results).reduce((sum, r) => sum + r.total, 0);

            // Show summary
            const summary = document.getElementById('summary');
            const summaryContent = document.getElementById('summary-content');
            summary.style.display = 'block';
            
            const passRate = ((totalPassed / totalTests) * 100).toFixed(1);
            summaryContent.innerHTML = `
                <div style="font-size: 18px; margin-bottom: 15px;">
                    <strong>Overall Results:</strong> ${totalPassed}/${totalTests} tests passed (${passRate}%)
                </div>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                    <div>‚úÖ <strong>Passed:</strong> ${totalPassed}</div>
                    <div>‚ùå <strong>Failed:</strong> ${totalFailed}</div>
                    <div>üìã <strong>Config Tests:</strong> ${results.config.passed}/${results.config.total}</div>
                    <div>üî• <strong>Firestore Tests:</strong> ${results.firestore.passed}/${results.firestore.total}</div>
                    <div>üì¶ <strong>Storage Tests:</strong> ${results.storage.passed}/${results.storage.total}</div>
                    <div>üß© <strong>Module Tests:</strong> ${results.modules.passed}/${results.modules.total}</div>
                </div>
                ${totalFailed > 0 ? '<div style="margin-top: 15px; color: #ef4444;"><strong>‚ö†Ô∏è Some tests failed. Check the details above.</strong></div>' : '<div style="margin-top: 15px; color: #10b981;"><strong>‚ú® All tests passed! Firebase integration is working correctly.</strong></div>'}
            `;
        }

        function clearResults() {
            ['config-tests', 'firestore-tests', 'storage-tests', 'module-tests'].forEach(id => {
                document.getElementById(id).innerHTML = '';
            });
            document.getElementById('summary').style.display = 'none';
        }

        // Event listeners
        document.getElementById('runAllTests').addEventListener('click', runAllTests);
        document.getElementById('clearResults').addEventListener('click', clearResults);

        // Auto-run tests on load
        window.addEventListener('load', () => {
            setTimeout(runAllTests, 500);
        });
    </script>

    <div class="test-section">
        <h2>Implementation Checklist</h2>
        <div class="code">
‚úÖ Firebase SDK v10.7.1 installed and configured
‚úÖ Firestore Database collections defined (packages, suppliers, customers, tickets, conversations)
‚úÖ Firebase Storage configured for image uploads
‚úÖ Security rules created for Firestore and Storage
‚úÖ Package Management with Firebase Storage integration
‚úÖ Ticketing System with real-time updates
‚úÖ Customer-Supplier Messaging with real-time chat
‚úÖ Atomic operations (arrayUnion, writeBatch)
‚úÖ Real-time listeners with cleanup
‚úÖ Module exports and imports working

‚ö†Ô∏è Known Limitations:
- Data migration from local storage not automated
- Unread message counts not implemented
- Backend server.js still uses local storage (dual persistence)
        </div>
    </div>

    <div class="test-section">
        <h2>Next Steps</h2>
        <ol>
            <li>Set up Firebase project in Firebase Console</li>
            <li>Deploy Firestore security rules</li>
            <li>Deploy Storage security rules</li>
            <li>Test package creation with image upload</li>
            <li>Test ticket creation and responses</li>
            <li>Test messaging between customer and supplier</li>
            <li>Verify real-time updates work</li>
            <li>Consider migrating existing data from local storage</li>
        </ol>
    </div>
</body>
</html>
