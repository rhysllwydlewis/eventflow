name: Deploy

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  NODE_VERSION: '20'

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run linter
        run: npm run lint
      
      - name: Run unit tests
        run: npm run test:unit
        env:
          NODE_ENV: test
          JWT_SECRET: test-secret-key-for-ci-testing-only-min-32-chars
      
      - name: Run integration tests
        run: npm run test:integration
        env:
          NODE_ENV: test
          JWT_SECRET: test-secret-key-for-ci-testing-only-min-32-chars
      
      - name: Upload test coverage
        uses: codecov/codecov-action@v4
        if: success()
        with:
          files: ./coverage/lcov.info
          fail_ci_if_error: false

  security:
    name: Security Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run security audit
        run: npm audit --production
        continue-on-error: true
      
      - name: Check for vulnerable dependencies
        run: |
          if npm audit --production --audit-level=high | grep -q "found"; then
            echo "::warning::High or critical vulnerabilities found"
          fi

  deploy:
    name: Deploy to ${{ github.event.inputs.environment || 'production' }}
    runs-on: ubuntu-latest
    needs: [test, security]
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}
      url: ${{ secrets.APP_URL }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci --production
      
      - name: Create deployment package
        run: |
          tar -czf deployment.tar.gz \
            --exclude=node_modules \
            --exclude=.git \
            --exclude=coverage \
            --exclude=test-results \
            --exclude=playwright-report \
            --exclude=.env \
            --exclude=data \
            --exclude=uploads \
            .
      
      - name: Deploy to Railway
        if: success()
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "Deploying to Railway..."
          # Railway CLI deployment would go here
          # For now, Railway deploys automatically via GitHub integration
      
      - name: Smoke Test - Health Check
        if: success()
        run: |
          echo "Running smoke tests..."
          sleep 30  # Wait for deployment
          
          HEALTH_URL="${{ secrets.APP_URL }}/api/health"
          echo "Checking health endpoint: $HEALTH_URL"
          
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "$HEALTH_URL")
          if [ "$RESPONSE" != "200" ]; then
            echo "::error::Health check failed with status $RESPONSE"
            exit 1
          fi
          
          echo "✅ Health check passed"
      
      - name: Smoke Test - API Endpoints
        if: success()
        run: |
          echo "Testing API endpoints..."
          
          # Test config endpoint
          CONFIG_URL="${{ secrets.APP_URL }}/api/config"
          CONFIG_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "$CONFIG_URL")
          
          if [ "$CONFIG_RESPONSE" != "200" ]; then
            echo "::error::Config endpoint failed with status $CONFIG_RESPONSE"
            exit 1
          fi
          
          # Test sitemap
          SITEMAP_URL="${{ secrets.APP_URL }}/sitemap.xml"
          SITEMAP_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "$SITEMAP_URL")
          
          if [ "$SITEMAP_RESPONSE" != "200" ]; then
            echo "::warning::Sitemap endpoint failed with status $SITEMAP_RESPONSE"
          fi
          
          echo "✅ Smoke tests passed"
      
      - name: Performance Test
        if: success()
        run: |
          echo "Running performance tests..."
          
          # Test response time
          RESPONSE_TIME=$(curl -s -o /dev/null -w "%{time_total}" "${{ secrets.APP_URL }}")
          echo "Response time: ${RESPONSE_TIME}s"
          
          # Check if response time is acceptable (< 3s)
          if (( $(echo "$RESPONSE_TIME > 3.0" | bc -l) )); then
            echo "::warning::Response time is slow: ${RESPONSE_TIME}s"
          else
            echo "✅ Performance test passed"
          fi
      
      - name: Notify deployment
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ Deployment successful"
          else
            echo "❌ Deployment failed"
          fi
      
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          draft: false
          prerelease: false

  rollback:
    name: Rollback (if deployment fails)
    runs-on: ubuntu-latest
    needs: [deploy]
    if: failure()
    
    steps:
      - name: Rollback deployment
        run: |
          echo "::warning::Deployment failed, rollback procedures should be initiated"
          echo "Manual rollback may be required via Railway dashboard"
      
      - name: Notify failure
        run: |
          echo "::error::Deployment failed and rollback initiated"
